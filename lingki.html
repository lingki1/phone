<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>lingki</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        /* 自定义字体 */
        @font-face { 
            font-family: 'bulangni'; 
            src: url('') format('truetype'); 
            font-weight: normal; 
            font-style: normal; 
            font-display: swap; 
        }
        
        /* CSS 变量定义 */
        :root { 
            --screen-width: 350px; 
            --screen-height: 650px; 
            --secondary-bg: #ffffff; 
            --border-color: #e0e0e0; 
            --text-primary: #1f1f1f; 
            --text-secondary: #8a8a8a; 
            --accent-color: #007bff; 
        }
        
        /* 全局重置 */
        html { 
            height: 100%; 
            overflow: hidden; 
        }

        /* 主体样式 - 现代化响应式设计 */
        body {
            height: 100%;
            overflow: hidden;
            margin: 0;
            font-family: 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-weight: normal;
            background-color: #f0f2f5;
            line-height: 1.4;
        }

        /* 手机屏幕容器 - 全屏适配 */
        #phone-screen {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-color: #000;
        }

        /* 隐藏状态栏 */
        #status-bar {
            display: none;
        }

        /* 安全区域适配 */
        .header, .qzone-header {
            padding-top: calc(15px + env(safe-area-inset-top));
        }

        #chat-input-area {
            padding-bottom: calc(8px + env(safe-area-inset-bottom));
            background: transparent;
            border: none;
        }

        #chat-list-bottom-nav {
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* 模态框层级 */
        .modal {
            z-index: 1000;
        }

        /* 状态栏样式 */
        #status-bar { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            padding: 12px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            color: #1f1f1f; 
            z-index: 10; 
            font-size: 14px; 
            box-sizing: border-box; 
            pointer-events: none; 
        }
        
        #status-bar-time { 
            font-weight: 600; 
        }
        
        /* 电池图标组件 */
        .battery-container { 
            display: flex; 
            align-items: center; 
            gap: 5px; 
        }
        
        .battery-icon { 
            width: 25px; 
            height: 12px; 
            border: 1px solid #1f1f1f; 
            border-radius: 3px; 
            position: relative; 
            padding: 1px; 
        }
        
        .battery-icon::after { 
            content: ''; 
            position: absolute; 
            right: -3px; 
            top: 2px; 
            width: 2px; 
            height: 6px; 
            background-color: #1f1f1f; 
            border-radius: 0 1px 1px 0; 
        }
        
        .battery-level { 
            height: 100%; 
            background-color: #1f1f1f; 
            border-radius: 1px; 
            transition: width 0.5s ease; 
        }
        
        .battery-container.charging .battery-level { 
            background-color: #4cd964; 
            animation: charge-breath 2s infinite; 
        }
        
        .battery-container.charging .battery-text { 
            color: #4cd964; 
        }
        
        @keyframes charge-breath { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.7; } 
        }
        
        /* 屏幕切换系统 */
        .screen { 
            width: 100%; 
            height: 100%; 
            position: absolute; 
            top: 0; 
            left: 0; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            opacity: 0; 
            visibility: hidden; 
            transition: opacity 0.3s, visibility 0.3s; 
        }
        
        .screen.active { 
            opacity: 1; 
            visibility: visible; 
            z-index: 1; 
        }
        
        /* 通用头部样式 */
        .header { 
            position: relative; 
            z-index: 15; 
            flex-shrink: 0; 
            padding: 15px 20px; 
            padding-top: 40px; 
            background-color: rgba(247, 247, 247, 0.8); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px); 
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-size: 18px; 
            font-weight: 600; 
        }
        
        .header .header-actions { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        
        .header .back-btn, 
        .header .action-btn { 
            font-size: 24px; 
            cursor: pointer; 
            width: 30px; 
            text-align: center; 
            color: var(--accent-color); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }

        .header .action-btn {
            font-size: 16px;
            font-weight: 600;
        }

        .header .action-btn img { 
            height: 26px; 
        }
        
        .header .save-btn { 
            font-size: 16px; 
            color: var(--accent-color); 
            font-weight: 600; 
            cursor: pointer; 
        }

        /* 用户头像系统 */
        .user-avatar-container {
            position: absolute;
            top: 40px;
            left: 18px;
        }
        
        /* 主聊天列表头部布局 */
        #main-chat-list-header {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-left: 70px;
            padding-right: 20px;
        }
        
        /* 群聊/单聊切换开关 */
        .chat-type-toggle {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 16px;
            padding: 2px;
            max-width: 180px;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        
        #main-chat-list-header .header-actions {
            margin-left: auto;
        }

        .toggle-btn {
            padding: 4px 8px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            min-width: 36px;
            white-space: nowrap;
        }

        .toggle-btn.active {
            background: var(--accent-color);
            color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .toggle-btn:hover:not(.active) {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text-primary);
        }
        
        /* 用户头像样式 */
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid var(--border-color);
            transition: all 0.2s ease;
            background-color: #f0f0f0;
        }
        
        .user-avatar:hover {
            border-color: var(--accent-color);
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }
        
        .user-avatar:active {
            transform: scale(0.95);
        }
        
        /* 下拉菜单样式 */
        .user-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 8px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border-color);
            min-width: 160px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 1000;
        }
        
        .user-dropdown-menu.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-item:first-child {
            border-radius: 12px 12px 0 0;
        }
        
        .dropdown-item:last-child {
            border-radius: 0 0 12px 12px;
        }
        
        .dropdown-item:hover {
            background-color: #f8f9fa;
        }
        
        .dropdown-item svg {
            margin-right: 12px;
            color: var(--accent-color);
            flex-shrink: 0;
        }
        
        .dropdown-item span {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        /* 响应式设计 - 移动端适配 */
        @media (max-width: 480px) {
            .user-avatar {
                width: 28px;
                height: 28px;
            }
            
            .user-dropdown-menu {
                min-width: 140px;
                right: -10px;
            }
            
            .dropdown-item {
                padding: 10px 12px;
            }
            
            .dropdown-item span {
                font-size: 13px;
            }
            
            .dropdown-item svg {
                width: 14px;
                height: 14px;
                margin-right: 10px;
            }
        }
        
        @media (max-width: 360px) {
            .user-avatar {
                width: 26px;
                height: 26px;
            }
            
            .user-dropdown-menu {
                min-width: 130px;
                right: -15px;
            }
            
            .dropdown-item {
                padding: 8px 10px;
            }
            
            .dropdown-item span {
                font-size: 12px;
            }
        }
        
        @media (max-width: 320px) {
            .user-dropdown-menu {
                right: 0;
                left: auto;
                transform: translateX(0);
            }
        }
        
        /* 添加菜单容器 */
        .add-menu-container {
            position: relative;
        }
        
        .add-dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border-color);
            min-width: 160px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 1000;
        }
        
        .add-dropdown-menu.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        /* 添加菜单响应式 */
        @media (max-width: 480px) {
            .add-dropdown-menu {
                min-width: 140px;
                right: -10px;
            }
        }
        
        @media (max-width: 360px) {
            .add-dropdown-menu {
                min-width: 130px;
                right: -15px;
            }
        }
        
        @media (max-width: 320px) {
            .add-dropdown-menu {
                right: 0;
                left: auto;
                transform: translateX(0);
            }
        }
        
        /* 表单和列表容器 */
        .form-container, 
        .list-container { 
            padding: 20px; 
            overflow-y: auto; 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
        }
        
        .form-group { 
            margin-bottom: 20px; 
        }
        
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 500; 
            color: var(--text-secondary); 
        }
        
        .form-group input, 
        .form-group select, 
        .form-group textarea { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            font-size: 16px; 
            box-sizing: border-box; 
        }
        
        .form-group textarea { 
            min-height: 80px; 
            resize: vertical; 
        }
        
        #world-book-content-input { 
            height: calc(100% - 120px); 
        }
        
        .form-button { 
            width: 100%; 
            padding: 15px; 
            background-color: var(--accent-color); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            margin-top: 10px; 
        }
        
        .form-button-secondary { 
            background-color: #f0f0f0; 
            color: var(--text-primary); 
            border: 1px solid var(--border-color); 
        }
        
        #wallpaper-screen .form-container { 
            align-items: center; 
        }
        
        #wallpaper-preview { 
            width: 180px; 
            height: 320px; 
            border: 2px dashed var(--border-color); 
            background-color: #f0f2f5; 
            margin-bottom: 20px; 
            background-size: cover; 
            background-position: center; 
            border-radius: 10px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            color: var(--text-secondary); 
        }
        
        #wallpaper-upload-input { 
            display: none; 
        }

        /* 知识库列表样式 */
        #world-book-list {
            flex-grow: 1;
            overflow-y: auto;
            background-color: var(--secondary-bg);
            padding-top: 80px;
            margin-top: -80px;
        }

        /* 聊天列表样式 */
        #chat-list {
            flex-grow: 1;
            background-color: transparent;
            padding-top: 80px; 
            padding-bottom: 50px;
            box-sizing: border-box;
        }

        /* 列表项样式 */
        .list-item { 
            display: flex; 
            flex-direction: column; 
            padding: 12px 20px; 
            cursor: pointer; 
            border-bottom: 1px solid var(--border-color); 
        }
        
        .list-item:hover { 
            background-color: #f5f5f5; 
        }
        
        .list-item .item-title { 
            font-weight: 500; 
            font-size: 16px; 
            margin-bottom: 5px; 
        }
        
        .list-item .item-content { 
            font-size: 14px; 
            color: var(--text-secondary); 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        
        /* 聊天列表项样式 */
        .chat-list-item { 
            display: flex; 
            align-items: center; 
            padding: 10px 15px; 
            cursor: pointer; 
            border-bottom: 1px solid var(--border-color); 
            position: relative;
            transition: all 0.2s ease;
            background-color: transparent;
        }
        
        .chat-list-item:hover { 
            background-color: rgba(0, 0, 0, 0.04);
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .chat-list-item .name {
            font-weight: 700 !important;
            color: #ee0606 !important;
            text-shadow: 0 1px 4px rgba(255,255,255,0.85), 0 0 2px rgba(0,0,0,0.12) !important;
            letter-spacing: 0.5px !important;
            font-size: 16px !important;
        }
        
        .chat-list-item .avatar { 
            width: 45px; 
            height: 45px; 
            border-radius: 50%; 
            margin-right: 12px; 
            object-fit: cover; 
            background-color: #ccc; 
        }
        
        .chat-list-item .info { 
            flex-grow: 1; 
            overflow: hidden; 
        }
        
        .chat-list-item .name-line { 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            margin-bottom: 2px; 
        }
        
        .chat-list-item .name { 
            font-weight: 500; 
            color: var(--text-primary); 
        }
        
        .chat-list-item .group-tag { 
            font-size: 10px; 
            color: var(--accent-color); 
            background-color: #e7f3ff; 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-weight: bold; 
            flex-shrink: 0; 
        }
        
        .chat-list-item .last-msg { 
            font-size: 13px; 
            color: var(--text-secondary); 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            max-width: 180px; 
        }
        
        /* 聊天界面样式 */
        #chat-interface-screen { 
            background-size: cover; 
            background-position: center; 
            position: relative; 
        }
        
        #selection-cancel-btn, 
        #selection-delete-btn { 
            font-size: 16px; 
            color: var(--accent-color); 
            cursor: pointer; 
            padding: 5px; 
        }
        
        #selection-delete-btn { 
            color: #ff3b30; 
        }

        /* 聊天消息区域 */
        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 10px 15px;
            padding-top: 110px;
            margin-top: -80px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-sizing: border-box;
        }
        
        #load-more-btn { 
            text-align: center; 
            padding: 10px; 
            color: var(--accent-color); 
            font-size: 14px; 
            cursor: pointer; 
            background-color: transparent; 
            border: none; 
            width: 100%; 
        }
        
        #load-more-btn:hover { 
            text-decoration: underline; 
        }

        /* 发送者名称 */
        .sender-name { 
            font-size: 11px; 
            color: #666; 
            margin-bottom: 3px; 
        }

        .message-wrapper.ai .sender-name {
            margin-left: 50px;
            margin-bottom: 3px;
            position: absolute;
            top: -16px;
            left: 0;
        }

        /* 消息布局系统 */
        .message-wrapper {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            position: relative;
            max-width: 90%;
        }

        .message-wrapper.ai {
            align-self: flex-start;
            flex-direction: row;
        }

        .message-wrapper.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-bubble {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 100%;
        }

        .timestamp {
            font-size: 11px;
            color: #999;
            text-shadow: 0 0 3px rgba(255,255,255,0.6);
            white-space: nowrap;
            margin-bottom: 5px;
            flex-shrink: 0;
        }

        .message-bubble.selected::after { 
            content: '✔'; 
            position: absolute; 
            left: -10px; 
            top: 50%; 
            transform: translateY(-50%); 
            background-color: var(--accent-color); 
            color: white; 
            width: 20px; 
            height: 20px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 12px; 
        }
        
        .message-bubble.user.selected::after { 
            left: auto; 
            right: -10px; 
        }

        .message-bubble.user { 
            flex-direction: row-reverse; 
        }
        
        #typing-indicator { 
            align-self: flex-start; 
            display: none; 
            margin: 0 10px 10px; 
            color: var(--text-secondary); 
        }
        
        /* 聊天输入区域 */
        #chat-input-area { 
            flex-shrink: 0; 
            padding: 8px; 
            background-color: transparent; 
            backdrop-filter: none; 
            -webkit-backdrop-filter: none; 
            border-top: none; 
            display: flex; 
            flex-direction: column; 
            gap: 5px; 
        }
        
        #chat-input-main-row { 
            display: flex; 
            align-items: flex-end; 
            gap: 8px; 
            width: 100%; 
        }
        
        #chat-input { 
            flex-grow: 1; 
            border: none; 
            padding: 10px 15px; 
            border-radius: 20px; 
            background-color: var(--secondary-bg); 
            font-size: 16px; 
            max-height: 100px; 
            resize: none; 
        }
        
        .action-button { 
            border: none; 
            color: white; 
            border-radius: 20px; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 14px; 
            flex-shrink: 0; 
        }
        
        #send-btn { 
            background-color: var(--accent-color); 
            height: 40px; 
            padding: 0 15px;
        }
        
        /* 模态框系统 */
        .modal { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.4); 
            display: none; 
            justify-content: center; 
            align-items: center; 
            z-index: 100; 
        }
        
        .modal.visible { 
            display: flex; 
        }
        
        .modal-content { 
            width: 90%; 
            max-height: 90%; 
            background-color: white; 
            border-radius: 15px; 
            display: flex; 
            flex-direction: column; 
        }
        
        .modal-header { 
            padding: 15px; 
            font-weight: 600; 
            border-bottom: 1px solid var(--border-color); 
            text-align: center; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .modal-body { 
            padding: 15px; 
            overflow-y: auto; 
        }
        
        .modal-footer { 
            padding: 15px; 
            border-top: 1px solid var(--border-color); 
            display: flex; 
            justify-content: space-around; 
        }
        
        .modal-footer button { 
            width: 45%; 
            padding: 12px; 
            border-radius: 8px; 
            border: 1px solid var(--accent-color); 
            cursor: pointer; 
            font-size: 16px; 
        }
        
        .modal-footer .save { 
            background-color: var(--accent-color); 
            color: white; 
        }
        
        .modal-footer .cancel { 
            background-color: white; 
            color: var(--accent-color); 
        }
        
        /* 头像上传组件 */
        .avatar-upload { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        
        .avatar-upload img { 
            width: 60px; 
            height: 60px; 
            border-radius: 50%; 
            object-fit: cover; 
            background-color: #eee; 
        }
        
        .avatar-upload button { 
            padding: 8px 12px; 
            border: 1px solid #ccc; 
            background-color: #f0f0f0; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        
        #open-persona-library-btn { 
            font-size: 14px; 
            padding: 6px 10px; 
            margin-left: auto; 
        }
        
        .avatar-upload input[type="file"] { 
            display: none; 
        }
        
        /* 主题选择器 */
        .theme-selector label { 
            display: inline-flex; 
            align-items: center; 
            margin-right: 15px; 
            margin-bottom: 5px; 
            cursor: pointer; 
        }
        
        #reset-theme-btn { 
            background: none; 
            border: 1px solid #ccc; 
            color: #555; 
            font-size: 12px; 
            padding: 2px 8px; 
            border-radius: 5px; 
            cursor: pointer; 
            margin-left: 10px; 
        }
        
        /* 群组成员设置 */
        #group-members-settings { 
            display: flex; 
            overflow-x: auto; 
            padding-bottom: 10px; 
            gap: 15px; 
        }
        
        .member-editor { 
            text-align: center; 
            cursor: pointer; 
        }
        
        .member-editor img { 
            width: 50px; 
            height: 50px; 
            border-radius: 50%; 
            object-fit: cover; 
            background-color: #eee; 
            margin-bottom: 5px; 
        }
        
        .member-editor .member-name { 
            font-size: 12px; 
        }
        
        /* 通知栏 */
        #notification-bar { 
            position: absolute; 
            top: 40px; 
            left: 50%; 
            width: 90%; 
            z-index: 500; 
            background-color: rgba(250, 250, 250, 0.9); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px); 
            border-radius: 16px; 
            padding: 10px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            cursor: pointer;
            transform: translateX(-50%) translateY(-150%); 
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            visibility: hidden;
        }
        
        #notification-bar.visible {
            transform: translateX(-50%) translateY(0);
            visibility: visible;
        }
        
        #notification-avatar { 
            width: 30px; 
            height: 30px; 
            border-radius: 50%; 
            object-fit: cover; 
        }
        
        #notification-content .name { 
            font-weight: 600; 
            font-size: 15px; 
            color: #000; 
        }
        
        #notification-content .message { 
            font-size: 14px; 
            color: #555; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            max-width: 200px; 
        }
        
        /* 贴纸图片 */
        .sticker-image { 
            max-width: 100px; 
            max-height: 100px; 
            display: block; 
            object-fit: contain; 
        }
        
        .message-bubble.is-sticker .content, 
        .message-bubble.is-voice-message .content { 
            padding: 0; 
            background-color: transparent; 
            box-shadow: none; 
            border: none; 
            backdrop-filter: none; 
            -webkit-backdrop-filter: none; 
        }
        
        /* 聊天输入操作栏 */
        #chat-input-actions-top { 
            display: none; 
            gap: 8px; 
            padding: 8px 5px; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            transform: translateY(-10px);
            background: transparent;
            border: none;
            box-shadow: none;
            pointer-events: none;
            flex-wrap: wrap;
            min-height: 0;
        }
        
        #chat-input-actions-top.visible { 
            opacity: 1; 
            transform: translateY(0);
            pointer-events: auto;
        }
        
        /* 操作图标按钮 */
        .toggle-actions-icon { 
            width: 38px; 
            height: 38px; 
            border: none; 
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.85), rgba(255, 255, 255, 0.65)); 
            border-radius: 50%; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: var(--text-primary); 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.12), inset 0 1px 0 rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            position: relative;
            overflow: hidden;
        }
        
        .toggle-actions-icon::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.1), transparent);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .toggle-actions-icon:hover { 
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.75)); 
            transform: scale(1.1); 
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.18), inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }
        
        .toggle-actions-icon:hover::before {
            opacity: 1;
        }
        
        .toggle-actions-icon:active { 
            transform: scale(0.92); 
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .toggle-actions-icon svg { 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
        }
        
        .toggle-actions-icon:hover svg { 
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.15));
            stroke-width: 2.5;
        }
        
        .toggle-actions-icon.expanded svg { 
            transform: rotate(180deg); 
        }
        
        .toggle-actions-icon.expanded:hover svg { 
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.15));
            stroke-width: 2.5;
        }
        
        .chat-action-icon-btn { 
            font-size: 24px; 
            padding: 0; 
            width: 38px; 
            height: 38px; 
            line-height: 38px; 
            text-align: center; 
            border-radius: 50%; 
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.6)); 
            color: var(--text-primary); 
            backdrop-filter: blur(8px); 
            -webkit-backdrop-filter: blur(8px); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            cursor: pointer; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
                 .chat-action-icon-btn:hover {
             background: linear-gradient(145deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
             transform: scale(1.05);
             box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
         }
         
         /* 贴纸面板系统 */
         #sticker-panel { 
             position: absolute; 
             bottom: 0; 
             left: 0; 
             width: 100%; 
             height: 50%; 
             background-color: rgba(242, 242, 247, 0.85); 
             backdrop-filter: blur(15px); 
             -webkit-backdrop-filter: blur(15px); 
             border-top: 1px solid var(--border-color); 
             border-radius: 20px 20px 0 0; 
             z-index: 200; 
             display: flex; 
             flex-direction: column; 
             transform: translateY(100%); 
             transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
             visibility: hidden; 
         }
         
         #sticker-panel.visible { 
             transform: translateY(0); 
             visibility: visible; 
         }
         
         #sticker-panel-header { 
             padding: 10px 20px; 
             display: flex; 
             justify-content: space-between; 
             align-items: center; 
             flex-shrink: 0; 
             border-bottom: 1px solid var(--border-color); 
         }
         
         #sticker-panel-header .title { 
             font-weight: 600; 
         }
         
         #sticker-panel-header .panel-btn { 
             font-size: 16px; 
             padding: 5px 10px; 
             cursor: pointer; 
             color: var(--accent-color); 
         }
         
         #sticker-grid { 
             flex-grow: 1; 
             overflow-y: auto; 
             padding: 15px; 
             display: grid; 
             grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); 
             gap: 15px; 
         }
         
         .sticker-item { 
             position: relative; 
             aspect-ratio: 1 / 1; 
             background-color: white; 
             border-radius: 10px; 
             background-size: contain; 
             background-repeat: no-repeat; 
             background-position: center; 
             cursor: pointer; 
             box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
         }
         
         .sticker-item .delete-btn { 
             display: none; 
             position: absolute; 
             top: -5px; 
             right: -5px; 
             width: 20px; 
             height: 20px; 
             background-color: #ff3b30; 
             color: white; 
             border-radius: 50%; 
             text-align: center; 
             line-height: 20px; 
             font-size: 14px; 
             cursor: pointer; 
             border: 2px solid white; 
         }
         
         /* 输入操作包装器 */
         #input-actions-wrapper { 
             position: static; 
             display: flex; 
             align-items: flex-end; 
             gap: 8px; 
             flex-shrink: 0; 
         }
         
         #wait-reply-btn { 
             position: static; 
             bottom: auto; 
             right: auto; 
             width: auto; 
             height: 40px; 
             padding: 0 10px; 
             border-radius: 20px; 
             display: flex; 
             align-items: center; 
             justify-content: center; 
             background-color: rgba(255, 255, 255, 0.6); 
             backdrop-filter: blur(5px); 
             -webkit-backdrop-filter: blur(5px); 
             border: 1px solid rgba(0,0,0,0.08); 
             box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
             transition: opacity 0.2s, transform 0.1s; 
             cursor: pointer;
         }
         
         #wait-reply-btn:hover { 
             opacity: 0.8; 
         }
         
         #wait-reply-btn:active { 
             transform: scale(0.9); 
         }
         
         #wait-reply-btn img { 
             height: 22px; 
             display: block; 
             margin: auto; 
         }
         
         /* 聊天图片样式 */
         .chat-image { 
             max-width: 100%; 
             border-radius: 10px; 
             display: block; 
         }
         
         .message-bubble.has-image .content { 
             padding: 5px; 
         }
         
         /* 自定义模态框系统 */
         #custom-modal-overlay { 
             position: fixed; 
             top: 0; 
             left: 0; 
             width: 100%; 
             height: 100%; 
             background-color: rgba(0, 0, 0, 0.5); 
             display: none; 
             align-items: center; 
             justify-content: center; 
             z-index: 1000; 
             opacity: 0; 
             transition: opacity 0.2s ease-in-out; 
         }
         
         #custom-modal-overlay.visible { 
             display: flex; 
             opacity: 1; 
         }
         
         #custom-modal { 
             background-color: #fff; 
             width: 280px; 
             border-radius: 14px; 
             box-shadow: 0 4px 20px rgba(0,0,0,0.2); 
             display: flex; 
             flex-direction: column; 
             transform: scale(0.95); 
             transition: transform 0.2s ease-in-out; 
         }
         
         #custom-modal-overlay.visible #custom-modal { 
             transform: scale(1); 
         }
         
         .custom-modal-header { 
             padding: 16px; 
             font-size: 17px; 
             font-weight: 600; 
             text-align: center; 
         }
         
         .custom-modal-body { 
             padding: 0 16px 16px; 
             text-align: center; 
             font-size: 14px; 
             color: #333; 
             line-height: 1.5; 
         }
         
         .custom-modal-body p { 
             margin: 0; 
             margin-bottom: 12px; 
         }
         
         .custom-modal-body input { 
             width: 100%; 
             padding: 8px; 
             border-radius: 6px; 
             border: 1px solid #ccc; 
             font-size: 14px; 
             box-sizing: border-box; 
         }
         
         .custom-modal-footer { 
             border-top: 1px solid #dbdbdb; 
             display: flex; 
         }
         
         .custom-modal-footer button { 
             flex: 1; 
             background: none; 
             border: none; 
             padding: 12px; 
             font-size: 17px; 
             cursor: pointer; 
             color: var(--accent-color); 
         }
         
         .custom-modal-footer button:first-child { 
             border-right: 1px solid #dbdbdb; 
         }
         
         .custom-modal-footer .confirm-btn { 
             font-weight: 600; 
         }
         
         .custom-modal-footer .confirm-btn.btn-danger { 
             color: #ff3b30; 
         }
         
         #preset-actions-modal .custom-modal-footer { 
             flex-direction: column; 
         }
         
         #preset-actions-modal .custom-modal-footer button { 
             width: 100%; 
             border: none; 
             border-bottom: 1px solid #dbdbdb; 
             padding: 14px; 
             font-size: 18px; 
         }
         
         #preset-actions-modal .custom-modal-footer button:last-child { 
             border-bottom: none; 
         }
         
         /* 自定义多选组件 */
         .custom-multiselect { 
             position: relative; 
             user-select: none; 
         }
         
         .select-box { 
             display: flex; 
             align-items: center; 
             width: 100%; 
             padding: 12px; 
             border: 1px solid var(--border-color); 
             border-radius: 8px; 
             font-size: 16px; 
             box-sizing: border-box; 
             background-color: #fff; 
             cursor: pointer; 
         }
         
         .select-box .selected-options-text { 
             flex-grow: 1; 
             white-space: nowrap; 
             overflow: hidden; 
             text-overflow: ellipsis; 
             color: var(--text-primary); 
         }
         
         .select-box .arrow-down { 
             margin-left: auto; 
             font-size: 10px; 
             color: var(--text-secondary); 
             transition: transform 0.2s; 
         }
         
         .select-box.expanded .arrow-down { 
             transform: rotate(180deg); 
         }

         /* 复选框容器 */
         .checkboxes-container {
             display: none;
             position: absolute;
             top: 100%; 
             margin-top: 5px;
             left: 0;
             right: 0;
             max-height: 150px;
             overflow-y: auto;
             background-color: #fff;
             border: 1px solid var(--border-color);
             border-radius: 8px;
             z-index: 101;
             box-shadow: 0 4px 8px rgba(0,0,0,0.1);
         }

         .checkboxes-container.visible { 
             display: block; 
         }

         .checkboxes-container label {
             display: block;
             padding: 12px 15px;
             cursor: pointer;
             font-weight: normal;
             color: var(--text-primary);
             font-size: 15px;
         }

         .checkboxes-container input { 
             margin-right: 10px; 
             vertical-align: middle; 
         }
         
         /* 背景上传容器 */
         .bg-upload-container { 
             display: flex; 
             align-items: center; 
             gap: 10px; 
             margin-top: 8px; 
             flex-wrap: wrap; 
         }
         
         .bg-preview-img { 
             max-width: 120px; 
             max-height: 80px; 
             border-radius: 8px; 
             border: 1px solid var(--border-color); 
             object-fit: cover; 
             display: none; 
         }
         
         #remove-bg-btn { 
             padding: 8px 12px; 
             border: 1px solid #ff3b30; 
             color: #ff3b30; 
             background-color: #fff; 
             border-radius: 5px; 
             cursor: pointer; 
             font-size: 14px; 
             display: none; 
         }
         
         /* AI生成图片样式 */
         .message-bubble.is-ai-image .content { 
             padding: 5px; 
             background: transparent; 
             box-shadow: none; 
             border: none; 
             backdrop-filter: none; 
             -webkit-backdrop-filter: none; 
         }
         
         .ai-generated-image { 
             max-width: 180px; 
             border-radius: 12px; 
             display: block; 
             cursor: pointer; 
             transition: transform 0.2s, box-shadow 0.2s; 
         }
         
         .ai-generated-image:hover { 
             transform: scale(1.05); 
             box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
         }
         
         /* 语音消息样式 */
         .voice-message-body { 
             display: flex; 
             align-items: center; 
             cursor: pointer; 
             padding: 8px 12px; 
             min-width: 80px; 
             max-width: 200px; 
         }
         
         .message-bubble.user .voice-message-body { 
             color: #1a3d00; 
             flex-direction: row-reverse; 
         }
         
         .message-bubble.ai .voice-message-body { 
             color: var(--text-primary); 
         }
         
         .voice-waveform { 
             display: flex; 
             align-items: center; 
             height: 20px; 
             gap: 2px; 
             flex-grow: 1; 
             margin: 0 10px; 
         }
         
         .voice-waveform div { 
             width: 3px; 
             background-color: currentColor; 
             border-radius: 2px; 
             animation: wave-quiet 1.5s ease-in-out infinite; 
         }
         
         @keyframes wave-quiet { 
             0%, 100% { height: 2px; } 
             50% { height: 10px; } 
         }
         
         .voice-waveform div:nth-child(2) { animation-delay: 0.2s; } 
         .voice-waveform div:nth-child(3) { animation-delay: 0.4s; } 
         .voice-waveform div:nth-child(4) { animation-delay: 0.6s; } 
         .voice-waveform div:nth-child(5) { animation-delay: 0.8s; }

         .voice-duration {
             font-size: var(--chat-font-size, 13px);
             font-weight: 500;
             color: var(--text-secondary);
         }
         
         .message-bubble.user .voice-duration { 
             color: #3e6224; 
         }

         /* 消息气泡内容样式 */
         .message-bubble .content {
             position: relative;
             font-size: var(--chat-font-size, 16px);
             padding: 8px 12px;
             line-height: 1.5;
             word-break: break-word;
         }

         /* 气泡主题样式 */
         .message-bubble.user .content { 
             background-color: rgba(255, 255, 255, 0.75); 
             color: #585858; 
             border-radius: 8px 2px 8px 8px; 
         }
         
         .message-bubble.ai .content { 
             background-color: rgba(255, 255, 255, 0.7); 
             color: #585858; 
             border-radius: 2px 8px 8px 8px; 
         }
       
         .message-bubble::after {
             content: "";
             position: absolute;
             width: 20px;  
             height: 20px; 
             background-size: contain;
             background-repeat: no-repeat;
             opacity: 1; 
             z-index: 1;
         }

         /* 主题色彩系统 */
         #chat-messages[data-theme="pink_blue"] .message-bubble.user .content { 
             background-color: #fff0f6; 
             color: #432531; 
         }
         
         #chat-messages[data-theme="pink_blue"] .message-bubble.ai .content { 
             background-color: #eff7ff; 
             color: #263a4e; 
         }
         
         #chat-messages[data-theme="blue_white"] .message-bubble.user .content { 
             background-color: #eff7ff; 
             color: #263a4e; 
         }
         
         #chat-messages[data-theme="blue_white"] .message-bubble.ai .content { 
             background-color: #f8f9fa; 
             color: #383d41; 
         }
         
         #chat-messages[data-theme="purple_yellow"] .message-bubble.user .content { 
             background-color: #faf7ff; 
             color: #827693; 
         }
         
         #chat-messages[data-theme="purple_yellow"] .message-bubble.ai .content { 
             background-color: #fffde4; 
             color: #5C4033; 
         }
         
         #chat-messages[data-theme="black_white"] .message-bubble.user .content { 
             background-color: #343a40; 
             color: #f8f9fa; 
         }
         
         #chat-messages[data-theme="black_white"] .message-bubble.ai .content { 
             background-color: #f8f9fa; 
             color: #343a40; 
         }
         
         #chat-messages[data-theme="yellow_white"] .message-bubble.user .content { 
             background-color: #FFEB3B; 
             color: #5D4037; 
         }
         
         #chat-messages[data-theme="yellow_white"] .message-bubble.ai .content { 
             background-color: #f8f9fa; 
             color: #383d41; 
         }
         
         #chat-messages[data-theme="red_black"] .message-bubble.user .content { 
             background-color: #C62828; 
             color: #FFFFFF; 
         }
         
         #chat-messages[data-theme="red_black"] .message-bubble.ai .content { 
             background-color: #212121; 
             color: #FFFFFF; 
         }
         
         #chat-messages[data-theme="blue_yellow"] .message-bubble.user .content { 
             background-color: #A0D2EB; 
             color: #153243; 
         }
         
         #chat-messages[data-theme="blue_yellow"] .message-bubble.ai .content { 
             background-color: #FEF9E7; 
             color: #5D4037; 
         }
         
         #chat-messages[data-theme="pink_yellow"] .message-bubble.user .content { 
             background-color: #fff0f6; 
             color: #432531; 
         }
         
         #chat-messages[data-theme="pink_yellow"] .message-bubble.ai .content { 
             background-color: #FEF9E7; 
             color: #5D4037; 
         }
         
         #chat-messages[data-theme="pink_purple"] .message-bubble.user .content { 
             background-color: #fff0f6; 
             color: #a78396; 
         }
         
         #chat-messages[data-theme="pink_purple"] .message-bubble.ai .content { 
             background-color: #faf7ff; 
             color: #827693; 
         }
         
         #chat-messages[data-theme="gray_white"] .message-bubble.user .content { 
             background-color: #e9ecef; 
             color: #495057; 
         }
         
         #chat-messages[data-theme="gray_white"] .message-bubble.ai .content { 
             background-color: #f8f9fa; 
             color: #383d41; 
         }
         
         #chat-messages[data-theme="blue_green"] .message-bubble.user .content { 
             background-color: #d1ecf1; 
             color: #0c5460; 
         }
         
         #chat-messages[data-theme="blue_green"] .message-bubble.ai .content { 
             background-color: #d4edda; 
             color: #155724; 
         }
         
         #chat-messages[data-theme="pink_white"] .message-bubble.user .content { 
             background-color: #fff0f6; 
             color: #a78396; 
         }
         
         #chat-messages[data-theme="pink_white"] .message-bubble.ai .content { 
             background-color: #f8f9fa; 
             color: #383d41; 
         }
         
         #chat-messages[data-theme="pink_black"] .message-bubble.user .content { 
             background-color: #F8BBD0; 
             color: #5B2C6F; 
         }
         
         #chat-messages[data-theme="pink_black"] .message-bubble.ai .content { 
             background-color: #343a40; 
             color: #f8f9fa; 
         }
         
         #chat-messages[data-theme="pink_green"] .message-bubble.user .content { 
             background-color: #F8BBD0; 
             color: #5B2C6F; 
         }
         
         #chat-messages[data-theme="pink_green"] .message-bubble.ai .content { 
             background-color: #C8E6C9; 
             color: #1B5E20; 
         }
         
         #chat-messages[data-theme="green_black"] .message-bubble.user .content { 
             background-color: #d4edda; 
             color: #155724; 
         }
         
         #chat-messages[data-theme="green_black"] .message-bubble.ai .content { 
             background-color: #343a40; 
             color: #f8f9fa; 
         }

         /* 转账功能样式 */
         #transfer-btn { 
             font-weight: bold; 
         }
         
         #transfer-modal { 
             position: fixed; 
             top: 0; 
             left: 0; 
             width: 100%; 
             height: 100%; 
             background-color: rgba(0,0,0,0.5); 
             display: none; 
             align-items: center; 
             justify-content: center; 
             z-index: 1001; 
         }
         
         #transfer-modal.visible { 
             display: flex; 
         }
         
         .transfer-content { 
             background-color: #fff0f5; 
             border-radius: 20px; 
             width: 290px; 
             padding: 20px; 
             box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3); 
             text-align: center; 
             background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100" opacity="0.05"><path d="M50,4 C35,4 28,15 28,24 C28,33 35,32 35,40 C35,48 28,49 28,57 C28,65 35,66 35,74 C35,82 28,83 28,91 C28,99 35,100 50,100 C65,100 72,99 72,91 C72,83 65,82 65,74 C65,66 72,65 72,57 C72,49 65,48 65,40 C65,32 72,33 72,24 C72,15 65,4 50,4 Z" fill="%23FF69B4"/></svg>'); 
             background-repeat: no-repeat; 
             background-position: top right; 
             background-size: 80px; 
         }
         
         .transfer-header { 
             font-size: 20px; 
             font-weight: bold; 
             color: #a35c7b; 
             margin-bottom: 20px; 
         }
         
         .transfer-input-group { 
             margin-bottom: 15px; 
             text-align: left; 
         }
         
         .transfer-input-group label { 
             display: block; 
             font-size: 14px; 
             color: #ff85b3; 
             margin-bottom: 5px; 
             font-weight: 500; 
         }
         
         .transfer-input-group input { 
             width: 100%; 
             padding: 12px; 
             border-radius: 10px; 
             border: 2px solid #ffcce0; 
             background-color: #fff; 
             font-size: 16px; 
             box-sizing: border-box; 
         }
         
         .transfer-input-group input:focus { 
             border-color: #ff85b3; 
             outline: none; 
         }
         
         .transfer-actions { 
             display: flex; 
             justify-content: space-between; 
             gap: 10px; 
         }
         
         .transfer-actions button { 
             flex: 1; 
             padding: 12px; 
             border: none; 
             border-radius: 10px; 
             font-size: 16px; 
             font-weight: bold; 
             cursor: pointer; 
             transition: transform 0.2s; 
         }
         
         .transfer-actions button:active { 
             transform: scale(0.95); 
         }
         
         #transfer-cancel-btn { 
             background-color: #ffdde9; 
             color: #a35c7b; 
         }
         
         #transfer-confirm-btn { 
             background-color: #ff85b3; 
             color: white; 
         }
         
         .message-bubble.is-transfer .content { 
             padding: 0; 
             background: transparent; 
             box-shadow: none; 
             border: none; 
             backdrop-filter: none; 
             -webkit-backdrop-filter: none; 
             cursor: pointer; 
         }
         
         .transfer-card { 
             width: 200px; 
             border-radius: 12px; 
             padding: 12px; 
             color: white; 
             position: relative; 
             overflow: hidden; 
         }
         
         .transfer-card::before { 
             content: '🐾'; 
             position: absolute; 
             right: 10px; 
             top: 5px; 
             font-size: 30px; 
             opacity: 0.2; 
             transform: rotate(15deg); 
         }
         
         .message-bubble.user .transfer-card { 
             background: radial-gradient(circle at top left, #ffc5d5, #ff85b3); 
         }
         
         .message-bubble.ai .transfer-card { 
             background: radial-gradient(circle at top left, #a1c4fd, #c2e9fb); 
         }
         
         .transfer-title { 
             font-size: 16px; 
             font-weight: 600; 
             display: flex; 
             align-items: center; 
             gap: 6px; 
             margin-bottom: 8px; 
         }
         
         .transfer-amount { 
             font-size: 28px; 
             font-weight: bold; 
             margin-bottom: 4px; 
         }
         
         .transfer-note { 
             font-size: 13px; 
             opacity: 0.9; 
             border-top: 1px solid rgba(255,255,255,0.3); 
             padding-top: 8px; 
             margin-top: 8px; 
             word-break: break-all; 
         }
         
         /* 音乐播放器动画 */
         @keyframes spin { 
             from { transform: rotate(0deg); } 
             to { transform: rotate(360deg); } 
         }
         
         #listen-together-btn img.rotating { 
             animation: spin 2s linear infinite; 
         }
         
         #listen-together-btn img.paused { 
             animation-play-state: paused; 
         }
         
         /* 音乐播放器覆盖层 */
         #music-player-overlay { 
             position: absolute; 
             top: 0; 
             left: 0; 
             width: 100%; 
             height: 100%; 
             z-index: 50; 
             display: none; 
             justify-content: center; 
             align-items: center; 
             background-color: rgba(0,0,0,0.3); 
         }
         
         #music-player-overlay.visible { 
             display: flex; 
         }
         
         .music-player-window { 
             width: 90%; 
             background-color: rgba(255, 255, 255, 0.6); 
             backdrop-filter: blur(20px); 
             -webkit-backdrop-filter: blur(20px); 
             border-radius: 20px; 
             box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); 
             border: 1px solid rgba(255, 255, 255, 0.18); 
             padding: 25px; 
             display: flex; 
             flex-direction: column; 
             align-items: center; 
             color: #1f1f1f; 
             position: relative; 
         }
         
         #music-playlist-btn { 
             position: absolute; 
             top: 15px; 
             right: 15px; 
             font-size: 24px; 
             cursor: pointer; 
             color: #333; 
         }
         
         #music-time-counter { 
             font-size: 12px; 
             color: #555; 
             margin-bottom: 20px; 
         }
         
         #music-player-song-title { 
             font-size: 20px; 
             font-weight: 600; 
             margin-bottom: 5px; 
             text-align: center; 
         }
         
         #music-player-artist { 
             font-size: 14px; 
             color: #666; 
             margin-bottom: 25px; 
         }
         
         .music-controls { 
             display: flex; 
             align-items: center; 
             justify-content: center; 
             gap: 20px; 
             width: 100%; 
             margin-bottom: 30px; 
         }
         
         .music-controls button { 
             background: none; 
             border: none; 
             font-size: 16px; 
             font-weight: bold; 
             cursor: pointer; 
             color: #333; 
             width: 44px; 
             height: 44px; 
             display: flex; 
             justify-content: center; 
             align-items: center; 
             transition: transform 0.2s; 
         }
         
         .music-controls button:active { 
             transform: scale(0.9); 
         }
         
         .music-controls .play-pause-btn { 
             font-size: 24px; 
             width: 60px; 
             height: 60px; 
             border-radius: 50%; 
             background-color: rgba(0,0,0,0.05); 
         }
         
         .music-bottom-actions { 
             display: flex; 
             justify-content: space-between; 
             width: 100%; 
         }
         
         .music-bottom-actions button { 
             flex: 1; 
             padding: 12px 0; 
             border: none; 
             border-radius: 10px; 
             font-size: 15px; 
             font-weight: 500; 
             cursor: pointer; 
         }
         
         #music-exit-btn { 
             background-color: rgba(255, 100, 100, 0.7); 
             color: white; 
             margin-right: 5px; 
         }
         
         #music-return-btn { 
             background-color: rgba(0, 123, 255, 0.7); 
             color: white; 
             margin-left: 5px; 
         }
         
         /* 音乐播放列表面板 */
         #music-playlist-panel { 
             position: absolute; 
             bottom: 0; 
             left: 0; 
             width: 100%; 
             height: 70%; 
             background-color: rgba(242, 242, 247, 0.9); 
             backdrop-filter: blur(15px); 
             -webkit-backdrop-filter: blur(15px); 
             border-top: 1px solid var(--border-color); 
             border-radius: 20px 20px 0 0; 
             z-index: 210; 
             display: flex; 
             flex-direction: column; 
             transform: translateY(100%); 
             transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
             visibility: hidden; 
         }
         
         #music-playlist-panel.visible { 
             transform: translateY(0); 
             visibility: visible; 
         }
         
         .playlist-header { 
             padding: 15px 20px; 
             display: flex; 
             justify-content: space-between; 
             align-items: center; 
             flex-shrink: 0; 
             border-bottom: 1px solid var(--border-color); 
             font-weight: 600; 
         }
         
         .playlist-header .panel-btn { 
             font-size: 16px; 
             cursor: pointer; 
             color: var(--accent-color); 
         }
         
         .playlist-body { 
             flex-grow: 1; 
             overflow-y: auto; 
             padding: 10px 0; 
         }
         
         .playlist-item { 
             padding: 10px 20px; 
             display: flex; 
             justify-content: space-between; 
             align-items: center; 
             cursor: pointer; 
             border-bottom: 1px solid #eee; 
         }
         
         .playlist-item.playing { 
             background-color: rgba(0, 123, 255, 0.1); 
         }
         
         .playlist-item-info .title { 
             font-weight: 500; 
             font-size: 15px; 
         }
         
         .playlist-item-info .artist { 
             font-size: 12px; 
             color: #666; 
         }
         
         .playlist-item .delete-track-btn { 
             color: #ff3b30; 
             font-size: 20px; 
             padding: 5px; 
         }

         /* 人物库样式 */
         #persona-library-grid { 
             display: grid; 
             grid-template-columns: repeat(4, 1fr); 
             gap: 15px; 
             padding: 10px; 
         }
         
         .persona-preset-item { 
             aspect-ratio: 1 / 1; 
             border-radius: 12px; 
             background-size: cover; 
             background-position: center; 
             cursor: pointer; 
             transition: transform 0.2s, box-shadow 0.2s; 
             border: 1px solid rgba(0,0,0,0.1); 
         }
         
         .persona-preset-item:hover { 
             transform: scale(1.08); 
             box-shadow: 0 4px 10px rgba(0,0,0,0.2); 
         }
         
         .modal-header .action-button { 
             font-size: 16px; 
             color: var(--accent-color); 
             font-weight: 600; 
             cursor: pointer; 
             background: none; 
             border: none; 
             padding: 5px; 
         }
         
         /* 电池警告模态框 */
         #battery-alert-modal { 
             position: fixed; 
             top: 0; 
             left: 0; 
             width: 100%; 
             height: 100%; 
             background-color: rgba(0, 0, 0, 0.4); 
             display: none; 
             justify-content: center; 
             align-items: center; 
             z-index: 2000; 
             opacity: 0; 
             transition: opacity 0.3s ease; 
         }
         
         #battery-alert-modal.visible { 
             display: flex; 
             opacity: 1; 
         }
         
         .battery-alert-content { 
             background-color: rgba(255, 255, 255, 0.9); 
             backdrop-filter: blur(10px); 
             -webkit-backdrop-filter: blur(10px); 
             width: 280px; 
             border-radius: 15px; 
             box-shadow: 0 5px 20px rgba(0,0,0,0.2); 
             text-align: center; 
             padding: 20px; 
             cursor: pointer; 
             transform: scale(0.9); 
             transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); 
         }
         
         #battery-alert-modal.visible .battery-alert-content { 
             transform: scale(1); 
         }
         
         #battery-alert-image { 
             max-width: 100px; 
             max-height: 100px; 
             margin-bottom: 15px; 
         }
         
         #battery-alert-text { 
             font-size: 16px; 
             font-weight: 500; 
             color: #333; 
             margin: 0; 
             line-height: 1.4; 
         }

         /* 主要按钮样式优化 */
         #add-chat-btn,
         #add-world-book-btn,
         #create-album-btn-page {
             font-size: 28px;
             font-weight: 300;
             position: relative;
             top: -1px;
         }

         /* 设置预览区域 */
         #settings-preview-area {
             width: 100%;
             height: 180px;
             background-color: #f0f2f5;
             border-radius: 8px;
             padding: 15px;
             box-sizing: border-box;
             overflow: hidden;
             display: flex;
             flex-direction: column;
             gap: 10px;
             border: 1px solid var(--border-color);
             position: relative;
         }

         #settings-preview-area::before {
             content: '';
             position: absolute;
             top: 0; 
             left: 0;
             width: 100%; 
             height: 100%;
             background-size: cover;
             background-position: center;
             z-index: 1;
             opacity: 0.8;
         }

         #settings-preview-area .message-wrapper {
             position: relative;
             z-index: 2;
         }

         #settings-preview-area .message-bubble .avatar {
             width: 30px;
             height: 30px;
         }
         
         #settings-preview-area .avatar-with-frame {
             width: 30px;
             height: 30px;
         }
         
         #settings-preview-area .avatar-with-frame .avatar-frame {
             width: 44px;
             height: 44px;
             top: -7px;
             left: -7px;
         }
         
         #settings-preview-area .message-bubble .timestamp {
             display: none;
         }

         /* 群组管理样式 */
         .existing-group-item {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 12px;
             background-color: #f9f9f9;
             border-radius: 8px;
             border: 1px solid var(--border-color);
         }

         .existing-group-item .group-name {
             font-weight: 500;
         }

         .existing-group-item .delete-group-btn {
             color: #ff3b30;
             font-size: 20px;
             cursor: pointer;
             padding: 5px;
         }

         /* 聊天分组容器 */
         .chat-group-container {
             border-bottom: 1px solid var(--border-color);
         }
         
         .chat-group-container:first-child {
             border-top: 1px solid var(--border-color);
         }

         .chat-group-header {
             display: flex;
             align-items: center;
             padding: 12px 15px;
             cursor: pointer;
             background-color: #f7f7f7;
             transition: all 0.2s ease;
         }

         .chat-group-header:hover {
             background-color: #eeeeee;
             transform: translateX(1px);
         }

         .chat-group-header .arrow {
             font-size: 14px;
             margin-right: 8px;
             transition: transform 0.2s ease;
         }

         .chat-group-header.collapsed .arrow {
             transform: rotate(-90deg);
         }

         .chat-group-header .group-name {
             font-weight: 600;
             font-size: 15px;
         }

         .chat-group-content {
             max-height: 1000px;
             overflow: hidden;
             transition: max-height 0.3s ease-in-out;
         }

         .chat-group-content.collapsed {
             max-height: 0;
         }

         /* 格式助手按钮 */
         .format-helpers {
             display: flex;
             gap: 10px;
             margin-bottom: 15px;
             flex-wrap: wrap;
         }

         .format-btn {
             background-color: #e9ecef;
             color: var(--text-primary);
             border: none;
             padding: 6px 12px;
             border-radius: 16px;
             font-size: 13px;
             font-weight: 500;
             cursor: pointer;
             transition: background-color 0.2s;
         }

         .format-btn:hover {
             background-color: #dcdfe3;
         }

         /* 帖子操作按钮 */
         .post-actions-btn {
             margin-left: auto;
             padding: 5px 10px;
             font-size: 20px;
             font-weight: bold;
             color: var(--text-secondary);
             cursor: pointer;
             border-radius: 50%;
             line-height: 1;
         }
         
         .post-actions-btn:hover {
             background-color: #f0f0f0;
         }

         #post-actions-modal .custom-modal-footer button {
             width: 100%;
             border: none;
             border-bottom: 1px solid #dbdbdb;
             padding: 14px;
             font-size: 18px;
         }
         
         #post-actions-modal .custom-modal-footer button:last-child {
             border-bottom: none;
         }
         
         #post-actions-modal #cancel-post-action-btn {
             margin-top: 8px;
             border-radius: 8px;
             background-color: #f0f0f0;
         }

         /* 转账卡片文字样式修正 */
         #chat-messages .transfer-card .transfer-title,
         #chat-messages .transfer-card .transfer-amount,
         #chat-messages .transfer-card .transfer-note {
             text-shadow: none !important;
             color: white !important;
         }

         #chat-messages .transfer-card .transfer-title {
             font-size: 16px !important;
             font-weight: 600 !important;
         }

         #chat-messages .transfer-card .transfer-amount {
             font-size: 28px !important;
             font-weight: bold !important;
         }

         #chat-messages .transfer-card .transfer-note {
             font-size: 13px !important;
             opacity: 0.9 !important;
         }

         /* 加载页面样式 */
         #loading-screen {
             position: fixed;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
             background-size: cover;
             background-position: center;
             background-repeat: no-repeat;
             display: flex;
             flex-direction: column;
             justify-content: center;
             align-items: center;
             z-index: 9999;
             transition: opacity 0.5s ease-out;
             overflow: hidden;
         }

         #loading-screen.has-wallpaper::before {
             content: '';
             position: absolute;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background: rgba(0, 0, 0, 0.4);
             z-index: 1;
         }

         #loading-screen .background-decoration {
             content: '';
             position: absolute;
             top: -50%;
             left: -50%;
             width: 200%;
             height: 200%;
             background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
             animation: backgroundFloat 20s infinite linear;
             z-index: 2;
         }

         #loading-screen .background-overlay {
             content: '';
             position: absolute;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background: 
                 radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                 radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                 radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
             animation: backgroundPulse 8s infinite ease-in-out;
             z-index: 3;
         }

         .loading-particles {
             position: absolute;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             z-index: 4;
         }

         .particle {
             position: absolute;
             width: 4px;
             height: 4px;
             background: rgba(255, 255, 255, 0.6);
             border-radius: 50%;
             animation: particleFloat 6s infinite linear;
         }

         .particle:nth-child(1) { top: 20%; left: 10%; animation-delay: 0s; }
         .particle:nth-child(2) { top: 60%; left: 80%; animation-delay: 1s; }
         .particle:nth-child(3) { top: 80%; left: 20%; animation-delay: 2s; }
         .particle:nth-child(4) { top: 30%; left: 70%; animation-delay: 3s; }
         .particle:nth-child(5) { top: 70%; left: 30%; animation-delay: 4s; }
         .particle:nth-child(6) { top: 10%; left: 60%; animation-delay: 5s; }

         .loading-content {
             text-align: center;
             color: white;
             position: relative;
             z-index: 10;
             background: rgba(255, 255, 255, 0.1);
             backdrop-filter: blur(20px);
             -webkit-backdrop-filter: blur(20px);
             border-radius: 24px;
             padding: 40px;
             border: 1px solid rgba(255, 255, 255, 0.2);
             box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
         }

         #loading-screen.fade-out {
             opacity: 0;
             pointer-events: none;
         }

         .loading-title {
             font-size: 36px;
             font-weight: 700;
             margin-bottom: 40px;
             text-shadow: 0 4px 8px rgba(0,0,0,0.3);
             animation: titleFadeIn 1s ease-out;
             background: linear-gradient(45deg, #ffffff, #e0e7ff);
             -webkit-background-clip: text;
             -webkit-text-fill-color: transparent;
             background-clip: text;
             letter-spacing: 1px;
         }

         .loading-subtitle {
             font-size: 16px;
             opacity: 0.9;
             margin-bottom: 60px;
             animation: titleFadeIn 1s ease-out 0.3s both;
         }

         .loading-progress-container {
             width: 320px;
             height: 8px;
             background-color: rgba(255,255,255,0.15);
             border-radius: 4px;
             overflow: hidden;
             margin-bottom: 20px;
             animation: titleFadeIn 1s ease-out 0.6s both;
             border: 1px solid rgba(255,255,255,0.2);
             box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
         }

         .loading-progress-bar {
             height: 100%;
             background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
             border-radius: 4px;
             width: 0%;
             transition: width 0.1s ease-out;
             box-shadow: 0 0 15px rgba(102, 126, 234, 0.6);
             position: relative;
         }

         .loading-progress-bar::after {
             content: '';
             position: absolute;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
             animation: progressShine 2s infinite;
         }

         .loading-percentage {
             font-size: 14px;
             opacity: 0.8;
             animation: titleFadeIn 1s ease-out 0.9s both;
         }

         .loading-dots {
             margin-top: 30px;
             animation: titleFadeIn 1s ease-out 1.2s both;
         }

         .loading-dots span {
             display: inline-block;
             width: 10px;
             height: 10px;
             border-radius: 50%;
             background: linear-gradient(45deg, #ffffff, #e0e7ff);
             margin: 0 6px;
             animation: loadingDots 1.4s infinite ease-in-out;
             box-shadow: 0 2px 8px rgba(255,255,255,0.3);
         }

         .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
         .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
         .loading-dots span:nth-child(3) { animation-delay: 0s; }

         @keyframes titleFadeIn {
             from {
                 opacity: 0;
                 transform: translateY(20px);
             }
             to {
                 opacity: 1;
                 transform: translateY(0);
             }
         }

         @keyframes loadingDots {
             0%, 80%, 100% {
                 transform: scale(0.8);
                 opacity: 0.5;
             }
             40% {
                 transform: scale(1);
                 opacity: 1;
             }
         }

         @keyframes backgroundFloat {
             0% {
                 transform: rotate(0deg);
             }
             100% {
                 transform: rotate(360deg);
             }
         }

         @keyframes backgroundPulse {
             0%, 100% {
                 opacity: 0.5;
                 transform: scale(1);
             }
             50% {
                 opacity: 0.8;
                 transform: scale(1.1);
             }
         }

         @keyframes particleFloat {
             0% {
                 transform: translateY(0px) translateX(0px);
                 opacity: 0;
             }
             10% {
                 opacity: 1;
             }
             90% {
                 opacity: 1;
             }
             100% {
                 transform: translateY(-100px) translateX(50px);
                 opacity: 0;
             }
         }

         @keyframes progressShine {
             0% {
                 transform: translateX(-100%);
             }
             100% {
                 transform: translateX(100%);
             }
         }

         #phone-screen {
             opacity: 0;
             transition: opacity 0.5s ease-in;
         }

         #phone-screen.loaded {
             opacity: 1;
         }

         /* 响应式设计 */
         @media (max-width: 768px) {
             .loading-content {
                 padding: 30px 20px;
                 margin: 0 20px;
             }
             
             .loading-title {
                 font-size: 28px;
             }
             
             .loading-progress-container {
                 width: 280px;
             }
             
             .loading-subtitle {
                 font-size: 14px;
             }
         }

         @media (max-width: 480px) {
             .loading-content {
                 padding: 25px 15px;
             }
             
             .loading-title {
                 font-size: 24px;
             }
             
             .loading-progress-container {
                 width: 250px;
             }
             
             .loading-subtitle {
                 font-size: 13px;
                 margin-bottom: 40px;
             }
         }

         /* 头像系统自适应 */
         .avatar-group {
             width: 34px;
             flex-shrink: 0;
             position: relative;
             transition: width 0.2s ease;
         }

         .avatar-group.has-frame {
             width: 42px;
         }

         .message-bubble .avatar {
             width: 34px;
             height: 34px;
             border-radius: 20%;
             object-fit: cover;
         }

         .avatar-with-frame {
             position: relative;
             width: 34px;
             height: 34px;
             margin: 0 auto;
             transition: all 0.2s ease;
         }

         .avatar-group.has-frame .avatar-with-frame {
             width: 43px;
             height: 43px;
         }

         .avatar-with-frame .avatar-img {
             position: absolute;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             border-radius: 50%;
             object-fit: cover;
             z-index: 1;
         }

         .avatar-with-frame .avatar-frame {
             position: absolute;
             width: 52px;
             height: 52px;
             top: -9px;   
             left: -4px;  
             z-index: 2;
             pointer-events: none;
         }

         /* 头部标题居中修正 */
         .header > span:nth-child(2),
         #chat-header-title {
             position: absolute;
             left: 50%;
             transform: translateX(calc(-50% - 2px));
             max-width: 60%;
             white-space: nowrap;
             overflow: hidden;
             text-overflow: ellipsis;
         }

         /* 可视化消息编辑器 */
         #message-editor-container {
             display: flex;
             flex-direction: column;
             gap: 15px;
         }

         .message-editor-block {
             background-color: #f9f9f9;
             border: 1px solid var(--border-color);
             border-radius: 8px;
             padding: 12px;
         }

         .message-editor-block textarea {
             width: 100%;
             min-height: 60px;
             resize: vertical;
             border: 1px solid #ccc;
             border-radius: 6px;
             padding: 8px;
             font-size: 14px;
             box-sizing: border-box;
         }

         .message-editor-block .format-helpers {
             margin-top: 8px;
             margin-bottom: 0;
         }

         .message-editor-block .delete-block-btn {
             float: right;
             margin-top: -5px;
             background: none;
             border: none;
             color: #ff3b30;
             font-size: 20px;
             cursor: pointer;
         }

         /* 联系人选择器 */
         .contact-picker-item {
             display: flex;
             align-items: center;
             padding: 10px 15px;
             cursor: pointer;
             border-bottom: 1px solid var(--border-color);
         }
         
         .contact-picker-item .checkbox {
             width: 20px;
             height: 20px;
             border: 2px solid #ccc;
             border-radius: 50%;
             margin-right: 15px;
             transition: all 0.2s ease;
         }
         
         .contact-picker-item.selected .checkbox {
             background-color: var(--accent-color);
             border-color: var(--accent-color);
             content: '✔';
             color: white;
             font-size: 14px;
             text-align: center;
             line-height: 20px;
         }
         
         .contact-picker-item .avatar {
             width: 40px;
             height: 40px;
             border-radius: 50%;
             margin-right: 12px;
         }
         
         .contact-picker-item .name {
             font-weight: 500;
         }

         /* 群成员管理界面 */
         #member-management-list {
             padding: 0;
         }

         .member-management-item {
             display: flex;
             align-items: center;
             padding: 12px 15px;
             border-bottom: 1px solid var(--border-color);
         }

         .member-management-item .avatar {
             width: 40px;
             height: 40px;
             border-radius: 50%;
             margin-right: 12px;
         }

         .member-management-item .name {
             flex-grow: 1;
             font-weight: 500;
         }

         .member-management-item .remove-member-btn {
             background-color: #ff3b30;
             color: white;
             border: none;
             width: 28px;
             height: 28px;
             border-radius: 50%;
             font-size: 20px;
             line-height: 28px;
             text-align: center;
             cursor: pointer;
             flex-shrink: 0;
         }

         #member-management-actions {
             flex-shrink: 0;
             padding: 15px;
             border-top: 1px solid var(--border-color);
             background-color: #f7f7f7;
             display: flex;
             flex-direction: column;
             gap: 10px;
         }

         #member-management-actions button {
             width: 100%;
             padding: 15px;
             background-color: var(--accent-color);
             color: white;
             border: none;
             border-radius: 8px;
             font-size: 16px;
             font-weight: 600;
             cursor: pointer;
         }
         
         #member-management-actions #create-new-member-btn {
             background-color: #4cd964;
         }

         /* 外卖代付卡片 */
         .message-bubble.is-waimai-request .content {
             padding: 0;
             background: transparent;
             box-shadow: none;
             border: none;
             backdrop-filter: none;
             -webkit-backdrop-filter: none;
         }

         .waimai-card {
             width: 240px;
             border-radius: 12px;
             overflow: hidden;
             background-color: #fff;
             box-shadow: 0 4px 12px rgba(0,0,0,0.1);
             font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
         }

         .waimai-header {
             display: flex;
             align-items: center;
             gap: 8px;
             padding: 10px 12px;
             border-bottom: 1px solid #f0f0f0;
         }

         .waimai-header .icon {
             width: 20px;
             height: 20px;
         }

         .waimai-header .title-group {
             display: flex;
             align-items: baseline;
             font-size: 14px;
             color: #8a8a8a;
         }
         
         .waimai-header .title-group .brand {
             font-weight: 600;
             color: #555;
             margin-right: 5px;
         }
         
         .waimai-header .title-group .separator {
             margin: 0 5px;
         }

         .waimai-catchphrase {
             font-size: 13px;
             color: #1f1f1f;
             padding: 12px;
         }

         .waimai-main {
             background-color: #FFD66B;
             padding: 12px;
             text-align: center;
         }

         .waimai-main .request-title {
             font-size: 12px;
             color: #856404;
             margin-bottom: 8px;
         }

         .waimai-main .payment-box {
             background-color: #fff;
             border-radius: 8px;
             padding: 15px 10px;
         }

         .waimai-main .payment-label {
             font-size: 13px;
             color: #8a8a8a;
         }

         .waimai-main .amount {
             font-size: 32px;
             font-weight: 700;
             color: #1f1f1f;
             margin: 4px 0 12px 0;
         }

         .waimai-main .countdown-label {
             font-size: 13px;
             color: #8a8a8a;
         }
         
         .waimai-main .countdown-timer {
             display: inline-flex;
             align-items: center;
             gap: 2px;
             margin-left: 5px;
         }
         
         .waimai-main .countdown-timer span {
             background-color: #333;
             color: white;
             padding: 2px 4px;
             border-radius: 2px;
             font-weight: bold;
             font-size: 12px;
         }

         .waimai-details-btn {
             width: 100%;
             padding: 10px 0;
             margin-top: 15px;
             border: none;
             border-radius: 6px;
             background-color: #FFC33A;
             color: #49380a;
             font-size: 14px;
             font-weight: 600;
             cursor: pointer;
         }

         /* 外卖响应状态样式 */
         .message-bubble.status-paid .waimai-card {
             border: 2px solid #28a745;
         }
         
         .message-bubble.status-paid .waimai-main .request-title::before {
             content: '✅  ';
         }
         
         .message-bubble.status-paid .waimai-main .request-title {
             color: #155724;
             font-weight: 600;
             content: "我已为您买单，请尽情享用吧～" !important;
             display: block;
             margin-bottom: 15px;
         }

         .message-bubble.status-paid .payment-box {
             display: none;
         }
         
         .message-bubble.status-paid .waimai-details-btn {
             background-color: #28a745;
             color: white;
         }

         .message-bubble.status-rejected .waimai-card {
             border: 2px solid #dc3545;
             opacity: 0.8;
         }
         
         .message-bubble.status-rejected .waimai-main {
             background-color: #e9ecef;
         }
         
         .message-bubble.status-rejected .waimai-main .request-title::before {
             content: '❌ ';
         }
         
         .message-bubble.status-rejected .waimai-main .request-title {
             color: #721c24;
             font-weight: 600;
             content: "我拒绝了您的代付请求" !important;
             display: block;
             margin-bottom: 15px;
         }
         
         .message-bubble.status-rejected .payment-box {
             display: none;
         }
         
         .message-bubble.status-rejected .waimai-details-btn {
             background-color: #6c757d;
             color: white;
         }

         .message-bubble[class*="status-"] .request-title {
             font-size: 0;
         }
         
         .message-bubble[class*="status-"] .request-title::after {
             font-size: 14px;
         }
         
         .message-bubble.status-paid .request-title::after {
             content: "我已为您买单，请尽情享用吧～";
         }
         
         .message-bubble.status-rejected .request-title::after {
             content: "我拒绝了您的代付请求";
         }

         /* 外卖用户操作按钮 */
         .waimai-user-actions {
             display: flex;
             gap: 10px;
             padding: 0 12px 12px 12px;
             background-color: #fff;
         }

         .waimai-user-actions button {
             flex: 1;
             padding: 10px;
             border-radius: 8px;
             border: 1.5px solid;
             font-size: 14px;
             font-weight: 600;
             cursor: pointer;
             transition: all 0.2s ease;
         }

         .waimai-pay-btn {
             background-color: #28a745;
             border-color: #1f7a33;
             color: white;
         }
         
         .waimai-pay-btn:hover {
             background-color: #218838;
         }

         .waimai-decline-btn {
             background-color: #f8f9fa;
             border-color: #ced4da;
             color: #495057;
         }
         
         .waimai-decline-btn:hover {
             background-color: #e2e6ea;
         }

         /* 统一设置页面背景色 */
         #api-settings-screen,
         #font-settings-screen,
         #wallpaper-screen,
         #memories-view,
         #contact-picker-screen,
         #member-management-screen,
         #world-book-editor-screen {  
             background-color: var(--secondary-bg);
         }

         #api-settings-screen .form-container,
         #font-settings-screen .form-container,
         #wallpaper-screen .form-container {
             padding-top: 100px;
             margin-top: -80px;
             background-color: var(--secondary-bg);
         }

         #wallpaper-screen .form-container {
             align-items: center;
         }

         /* 来电请求与视频通话界面 */
         #incoming-call-modal .incoming-call-content {
             background-color: rgba(40, 40, 40, 0.85);
             backdrop-filter: blur(20px);
             -webkit-backdrop-filter: blur(20px);
             border-radius: 20px;
             width: 280px;
             padding: 30px 20px;
             text-align: center;
             color: white;
             box-shadow: 0 10px 30px rgba(0,0,0,0.3);
         }

         .caller-avatar {
             width: 80px;
             height: 80px;
             border-radius: 50%;
             object-fit: cover;
             margin-bottom: 12px;
             border: 3px solid rgba(255,255,255,0.5);
         }

         .caller-name {
             font-size: 20px;
             font-weight: 600;
             margin-bottom: 5px;
         }

         .caller-text {
             font-size: 14px;
             color: #ccc;
             margin-bottom: 30px;
         }

         .incoming-call-actions {
             display: flex;
             justify-content: space-around;
             align-items: center;
         }

         .action-button-wrapper {
             display: flex;
             flex-direction: column;
             align-items: center;
             gap: 8px;
             font-size: 13px;
             color: #e0e0e0;
         }

         .call-action-btn {
             width: 60px;
             height: 60px;
             border-radius: 50%;
             border: none;
             cursor: pointer;
             background-size: 50%;
             background-repeat: no-repeat;
             background-position: center;
             transition: transform 0.2s, box-shadow 0.2s;
             box-shadow: 0 4px 10px rgba(0,0,0,0.2);
         }
         
         .call-action-btn:active {
             transform: scale(0.9);
         }

         .call-action-btn.decline {
             background-color: #ff3b30;
             background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 16.5L3 6m18 6l-5.6-5.6a1.2 1.2 0 0 0-1.7 0L3 18.2a1.2 1.2 0 0 0-.3 1.2l1.2 3.6a1.2 1.2 0 0 0 1.2.9h15.6a1.2 1.2 0 0 0 1.2-1.2V7.7a1.2 1.2 0 0 0-.3-1.1z"/></svg>');
         }

         .call-action-btn.accept {
             background-color: #4cd964;
             background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>');
             animation: pulse 1.5s infinite;
         }

         @keyframes pulse {
             0% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0.7); }
             70% { box-shadow: 0 0 0 15px rgba(76, 217, 100, 0); }
             100% { box-shadow: 0 0 0 0 rgba(76, 217, 100, 0); }
         }

         /* 视频通话界面 */
         #video-call-screen {
             background-color: #1c1c1e;
             color: white;
             display: flex;
             flex-direction: column;
             overflow: hidden;
         }

         .video-call-top-bar {
             position: absolute;
             top: 0; 
             left: 0; 
             width: 100%;
             padding: 15px 20px;
             padding-top: 50px;
             background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
             z-index: 10;
             text-align: center;
             box-sizing: border-box;
             pointer-events: none;
         }
         
         #call-timer {
             font-size: 16px;
             font-weight: 500;
             letter-spacing: 1px;
         }
         
         .video-call-controls {
             position: absolute;
             bottom: 0; 
             left: 0; 
             width: 100%;
             display: flex;
             justify-content: space-around;
             align-items: center;
             padding: 20px;
             padding-bottom: 40px;
             background: linear-gradient(to top, rgba(0,0,0,0.5), transparent);
             z-index: 10;
             box-sizing: border-box;
         }

         .video-call-avatar-area {
             flex-grow: 1; 
             display: flex;
             justify-content: center;
             align-items: center;
             padding: 20px;
             padding-top: 80px;
             box-sizing: border-box;
             overflow-y: auto;
         }

         #participant-avatars-grid {
             display: flex;
             flex-wrap: wrap; 
             justify-content: center;
             align-items: center;
             gap: 15px;
             max-width: 100%;
         }

         .participant-avatar-wrapper {
             position: relative;
             text-align: center;
             flex-shrink: 0;
         }
         
         .participant-avatar {
             width: 70px;
             height: 70px;
             border-radius: 50%;
             object-fit: cover;
             border: 3px solid rgba(255, 255, 255, 0.2);
             transition: all 0.3s ease;
         }
         
         .participant-name {
             margin-top: 8px;
             font-size: 12px;
             color: #ccc;
         }

         .participant-avatar.speaking {
             border-color: #4cd964;
             box-shadow: 0 0 20px rgba(76, 217, 100, 0.6);
             transform: scale(1.05);
         }

         #video-call-main {
             flex-shrink: 0; 
             height: 30%;
             margin: 15px 15px 130px 15px;
             overflow-y: auto;
             padding: 15px;
             background-color: rgba(255, 255, 255, 0.05);
             border-radius: 20px;
             display: flex;
             flex-direction: column;
             gap: 15px;
             box-sizing: border-box;
         }

         .control-btn {
             width: 70px;
             height: 70px;
             border-radius: 50%;
             border: none;
             cursor: pointer;
             background-repeat: no-repeat;
             background-position: center;
             transition: transform 0.2s, background-color 0.2s;
         }
         
         .control-btn:active {
             transform: scale(0.9);
         }
         
         .control-btn.speak-btn {
             background-color: rgba(255,255,255,0.2);
             background-size: 55%;
             background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>');
         }
         
         .control-btn.hangup-btn {
             background-color: #ff3b30;
             background-size: 50%;
             background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 16.5L3 6m18 6l-5.6-5.6a1.2 1.2 0 0 0-1.7 0L3 18.2a1.2 1.2 0 0 0-.3 1.2l1.2 3.6a1.2 1.2 0 0 0 1.2.9h15.6a1.2 1.2 0 0 0 1.2-1.2V7.7a1.2 1.2 0 0 0-.3-1.1z"/></svg>');
         }
         
         .control-btn.join-btn {
             background-color: #007bff;
             background-size: 50%;
             background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>');
         }

         /* 视频通话对话气泡 */
         .call-message-bubble {
             padding: 10px 15px;
             border-radius: 12px;
             max-width: 85%;
             line-height: 1.6;
             word-break: break-word;
             white-space: pre-wrap;
         }

         .call-message-bubble.ai-speech {
             background-color: rgba(255, 255, 255, 0.15);
             align-self: flex-start;
         }

         .call-message-bubble.user-speech {
             background-color: #4cd964;
             align-self: flex-end;
             text-align: left;
         }

         /* 正在呼叫界面 */
         #outgoing-call-screen {
             background-color: #1c1c1e;
             color: white;
             justify-content: center;
             align-items: center;
         }

         .outgoing-call-content {
             display: flex;
             flex-direction: column;
             align-items: center;
             text-align: center;
         }

         .outgoing-call-actions {
             margin-top: 50px;
             display: flex;
             flex-direction: column;
             align-items: center;
             gap: 8px;
             font-size: 13px;
             color: #e0e0e0;
         }

         /* 动态帖子滑动删除 */
         .qzone-post-container {
             position: relative;
             overflow: hidden;
             border-radius: 12px;
         }

         .qzone-post-item {
             transition: transform 0.3s ease;
             background-color: var(--secondary-bg);
             position: relative;
             z-index: 2;
         }

         .qzone-post-delete-action {
             position: absolute;
             top: 0;
             right: 0;
             bottom: 0;
             width: 90px;
             background-color: #ff3b30;
             color: white;
             display: flex;
             align-items: center;
             justify-content: center;
             font-weight: 500;
             cursor: pointer;
             z-index: 1;
         }

         .qzone-post-item.swiped {
             transform: translateX(-90px);
         }

         /* 拍一拍功能 */
         @keyframes pat-shake {
             0%, 100% { transform: translateX(0); }
             10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
             20%, 40%, 60%, 80% { transform: translateX(3px); }
         }

         .pat-animation {
             animation: pat-shake 0.4s ease-in-out;
         }

         .system-message {
             align-self: center;
             padding: 4px 12px;
             margin: 5px 0;
             background-color: rgba(0, 0, 0, 0.1);
             color: var(--text-secondary);
             font-size: 12px;
             border-radius: 10px;
             text-align: center;
             max-width: 80%;
         }

         .message-wrapper.system-pat {
             justify-content: center;
             align-self: center;
             margin: 5px 0;
             max-width: 80%;
         }
         
         .message-bubble.system-bubble {
             background-color: rgba(0, 0, 0, 0.1);
             color: var(--text-secondary);
             font-size: 12px;
             padding: 4px 12px;
             border-radius: 10px;
         }

         /* 聊天输入操作栏响应式 */
         #chat-input-actions-top {
             display: flex;
             gap: 8px;
             padding: 0 5px;
             flex-wrap: wrap;
             justify-content: flex-start;
             align-items: center;
             overflow-x: visible;
             overflow-y: visible;
             min-height: 46px;
             max-height: 138px;
         }

         #chat-input-actions-top::-webkit-scrollbar {
             display: none; 
         }

         /* 聊天界面头部状态栏 */
         #chat-header-title-wrapper {
             display: flex;
             flex-direction: column;
             align-items: center;
             gap: 2px;
             position: absolute;
             left: 50%;
             transform: translateX(-50%);
             max-width: 60%;
         }

         #chat-header-title {
             font-size: 16px;
             font-weight: 600;
             position: static;
             transform: none;
             white-space: nowrap;
             overflow: hidden;
             text-overflow: ellipsis;
             max-width: 100%;
         }

         #chat-header-status {
             display: flex;
             align-items: center;
             gap: 5px;
             font-size: 11px;
             color: var(--text-secondary);
             transition: all 0.3s ease;
         }

         .status-dot {
             width: 7px;
             height: 7px;
             border-radius: 50%;
             background-color: #4cd964;
             transition: background-color 0.3s ease;
         }

         #chat-header-status.busy .status-dot {
             background-color: #cccccc;
         }

         .status-text {
             font-weight: 500;
         }

         /* 回忆卡片样式 */
         .memory-card {
             background-color: #fffaf0;
             border-radius: 12px;
             padding: 15px;
             box-shadow: 0 2px 6px rgba(0,0,0,0.07);
             border-left: 5px solid #ffb74d; 
             display: flex;
             flex-direction: column;
             gap: 8px;
         }

         .memory-card .header {
             border-bottom: 1px solid rgba(217, 129, 0, 0.15);
             padding-bottom: 8px; 
         }

         .memory-card .header .date {
             font-size: 11px;
             color: #a1887f;
             margin-bottom: 4px; 
         }

         .memory-card .header .author {
             font-weight: 600;
             color: #d98100;
             font-size: 15px;
             white-space: nowrap;
             overflow: hidden;
             text-overflow: ellipsis;
         }

         .memory-card .content {
             font-size: 14px;
             line-height: 1.7;
             color: #5d4037;
             white-space: pre-wrap;
         }

         /* 约定/倒计时卡片 */
         .countdown-card {
             background: linear-gradient(135deg, #667eea, #764ba2);
             color: white;
             border-radius: 12px;
             padding: 20px;
             box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
             text-align: center;
             position: relative;
             overflow: hidden;
             flex-shrink: 0;
         }
         
         .countdown-card::before {
             content: '✨';
             position: absolute;
             top: -10px;
             left: -10px;
             font-size: 50px;
             opacity: 0.1;
             transform: rotate(-15deg);
         }
         
         .countdown-card .title {
             font-size: 18px;
             font-weight: 600;
             margin-bottom: 15px;
         }
         
         .countdown-card .timer {
             font-size: 28px;
             font-weight: 300;
             letter-spacing: 2px;
             margin-bottom: 15px;
         }
         
         .countdown-card .target-date {
             font-size: 12px;
             opacity: 0.8;
             border-top: 1px solid rgba(255,255,255,0.2);
             padding-top: 10px;
         }

         /* 聊天锁定遮罩层 */
         #chat-lock-overlay {
             position: absolute;
             bottom: 0;
             left: 0;
             width: 100%;
             background-color: rgba(247, 247, 247, 0.9);
             backdrop-filter: blur(10px);
             -webkit-backdrop-filter: blur(10px);
             z-index: 150;
             display: none;
             align-items: center;
             justify-content: center;
             padding: 20px;
             box-sizing: border-box;
             border-top: 1px solid var(--border-color);
             text-align: center;
         }
         
         #chat-lock-content {
             display: flex;
             flex-direction: column;
             gap: 15px;
         }
         
         #chat-lock-content .lock-text {
             color: var(--text-secondary);
             font-size: 14px;
         }
         
         #chat-lock-content .lock-action-btn {
             padding: 10px 20px;
             border-radius: 20px;
             border: 1px solid var(--accent-color);
             background-color: var(--accent-color);
             color: white;
             cursor: pointer;
         }
         
         #chat-lock-content .lock-action-btn.secondary {
             background-color: transparent;
             color: var(--accent-color);
         }

         /* 红包卡片样式 */
         .message-bubble.is-red-packet .content {
             padding: 0;
             background: transparent;
             box-shadow: none;
             border: none;
             backdrop-filter: none;
             -webkit-backdrop-filter: none;
         }

         .red-packet-card {
             width: 220px;
             border-radius: 8px;
             background: linear-gradient(160deg, #F96259, #E44D44);
             color: #ffd700;
             padding: 12px;
             cursor: pointer;
             box-shadow: 0 2px 5px rgba(0,0,0,0.1);
             position: relative;
             overflow: hidden;
         }

         .red-packet-card.opened {
             background: linear-gradient(160deg, #d3c4a0, #c4b693);
             cursor: default;
         }

         .red-packet-card::before {
             content: '🧧';
             position: absolute;
             top: -5px;
             left: -5px;
             font-size: 30px;
             opacity: 0.2;
             transform: rotate(-10deg);
         }

         .rp-header {
             display: flex;
             align-items: center;
             gap: 8px;
             margin-bottom: 8px;
         }

         .rp-icon {
             width: 20px;
             height: 20px;
         }

         .rp-greeting {
             font-size: 15px;
             font-weight: 500;
             white-space: nowrap;
             overflow: hidden;
             text-overflow: ellipsis;
         }

         .rp-type {
             font-size: 11px;
             color: white;
             opacity: 0.8;
             border-top: 1px solid rgba(255, 255, 255, 0.2);
             padding-top: 8px;
             margin-top: 8px;
         }

         .rp-claimed-info {
             font-size: 13px;
             color: white;
             margin-top: 10px;
             padding-top: 10px;
             border-top: 1px solid rgba(255,255,255,0.3);
         }

         /* 红包详情列表 */
         .rp-details-item {
             display: flex;
             align-items: center;
             padding: 8px 0;
             border-bottom: 1px solid #eee;
         }
         
         .rp-details-item:last-child {
             border-bottom: none;
         }
         
         .rp-details-item .name {
             flex-grow: 1;
             font-weight: 500;
             color: #333;
         }
         
         .rp-details-item .amount {
             font-weight: 500;
             color: #555;
         }
         
         .rp-details-item .lucky-king-tag {
             font-size: 10px;
             background-color: #ffd700;
             color: #a67c00;
             padding: 2px 5px;
             border-radius: 4px;
             margin-left: 8px;
             font-weight: bold;
         }

         /* 投票功能样式 */
         .message-bubble.is-poll .content {
             padding: 0;
             background: transparent;
             box-shadow: none;
             border: none;
             backdrop-filter: none;
             -webkit-backdrop-filter: none;
         }

         .poll-card {
             width: 250px;
             background-color: #f9f9f9;
             border-radius: 10px;
             border: 1px solid #e0e0e0;
             padding: 12px;
             font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
         }

         .poll-card.closed {
             background-color: #e9ecef;
         }

         .poll-question {
             font-weight: 600;
             font-size: 15px;
             margin-bottom: 12px;
             line-height: 1.4;
             word-break: break-word;
         }

         .poll-options-list {
             display: flex;
             flex-direction: column;
             gap: 8px;
         }

         .poll-option-item {
             background-color: white;
             border: 1px solid #dcdcdc;
             border-radius: 8px;
             padding: 10px;
             cursor: pointer;
             position: relative;
             overflow: hidden;
             transition: background-color 0.2s;
         }

         .poll-card:not(.closed) .poll-option-item:hover {
             background-color: #f0f8ff;
         }

         .poll-option-item.voted {
             border-color: var(--accent-color);
             background-color: #e7f3ff;
             font-weight: 500;
         }

         .poll-option-bar {
             position: absolute;
             top: 0;
             left: 0;
             height: 100%;
             background-color: rgba(0, 123, 255, 0.1);
             z-index: 1;
             transition: width 0.3s ease-in-out;
         }

         .poll-option-content {
             position: relative;
             z-index: 2;
             display: flex;
             justify-content: space-between;
             align-items: center;
         }

         .poll-option-text {
             font-size: 14px;
         }

         .poll-option-votes {
             font-size: 13px;
             color: #8a8a8a;
             font-weight: 500;
         }

         .poll-footer {
             margin-top: 12px;
             padding-top: 8px;
             border-top: 1px solid #e9e9e9;
             display: flex;
             justify-content: space-between;
             align-items: center;
             font-size: 12px;
             color: var(--text-secondary);
         }

         .poll-total-votes {
             font-weight: 500;
         }

         .poll-action-btn {
             background: none;
             border: 1px solid var(--accent-color);
             color: var(--accent-color);
             padding: 4px 10px;
             border-radius: 15px;
             cursor: pointer;
             font-size: 12px;
         }
         
         .poll-card.closed .poll-action-btn {
             background-color: #6c757d;
             color: white;
             border-color: #6c757d;
         }

         .poll-option-input-wrapper {
             display: flex;
             align-items: center;
             gap: 8px;
         }
         
         .poll-option-input-wrapper input {
             flex-grow: 1;
         }
         
         .poll-option-input-wrapper .remove-option-btn {
             width: 28px;
             height: 28px;
             border-radius: 50%;
             background-color: #f0f0f0;
             color: #ff3b30;
             border: none;
             cursor: pointer;
             font-size: 18px;
             line-height: 28px;
             text-align: center;
             flex-shrink: 0;
         }

         /* 聊天头部"正在输入"状态 */
         #chat-header-title.typing-status {
             color: var(--text-secondary);
             animation: typing-pulse 1.5s infinite;
             font-style: italic;
         }

         @keyframes typing-pulse {
             0%, 100% { opacity: 1; }
             50% { opacity: 0.6; }
         }

         #chat-header-title {
             transition: opacity 0.2s ease-in-out;
         }

         @keyframes message-pop-in {
           from {
             opacity: 0;
             transform: translateY(15px);
           }
           to {
             opacity: 1;
             transform: translateY(0);
           }
         }

         .message-wrapper.animate-in {
           animation: message-pop-in 0.3s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
         }

         /* App图标设置 */
         #icon-settings-grid {
             display: grid;
             grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
             gap: 20px;
             width: 100%;
             padding: 0 10px;
             box-sizing: border-box;
         }

         .icon-setting-item {
             display: flex;
             flex-direction: column;
             align-items: center;
             gap: 8px;
         }

         .icon-preview {
             width: 60px;
             height: 60px;
             border-radius: 15px;
             background-size: cover;
             background-position: center;
             box-shadow: 0 2px 5px rgba(0,0,0,0.1);
         }

         .change-icon-btn {
             padding: 4px 10px;
             font-size: 12px;
             border: 1px solid #ccc;
             background-color: #f0f0f0;
             border-radius: 5px;
             cursor: pointer;
         }

         /* 外观设置页面布局修正 */
         #wallpaper-screen .form-container {
             min-height: 0; 
         }

         #wallpaper-preview {
             flex-shrink: 0; 
         }

         /* 分享链接功能样式 */
         #browser-screen {
             background-color: #f8f9fa;
         }
         
         #browser-content {
             padding: 20px;
             font-size: 16px;
             line-height: 1.8;
             color: #333;
             overflow-y: auto;
             background-color: #f8f9fa;
         }
         
         #browser-content .article-title {
             font-size: 24px;
             font-weight: 700;
             margin-bottom: 10px;
         }
         
         #browser-content .article-meta {
             font-size: 13px;
             color: #8a8a8a;
             margin-bottom: 25px;
             padding-bottom: 15px;
             border-bottom: 1px solid #e0e0e0;
         }
         
         #browser-content .article-body {
             white-space: pre-wrap;
             word-break: break-word;
         }
         
         #browser-content .article-body p {
             margin-bottom: 1em;
         }

         .message-bubble.is-link-share .content {
             padding: 0;
             background: transparent;
             box-shadow: none;
             border: none;
             backdrop-filter: none;
             -webkit-backdrop-filter: none;
         }

         .link-share-card {
             width: 250px;
             background-color: #f8f9fa;
             border: 1px solid #e9ecef;
             border-radius: 8px;
             overflow: hidden;
             cursor: pointer;
             transition: box-shadow 0.2s ease;
         }

         .link-share-card:hover {
             box-shadow: 0 2px 8px rgba(0,0,0,0.1);
         }

         .link-card-content {
             padding: 12px;
         }

         .link-title {
             font-weight: 600;
             font-size: 15px;
             margin-bottom: 6px;
             line-height: 1.3;
             color: #333;
             display: -webkit-box;
             -webkit-line-clamp: 2;
             -webkit-box-orient: vertical;
             overflow: hidden;
         }

         .link-description {
             font-size: 13px;
             color: #666;
             line-height: 1.4;
             display: -webkit-box;
             -webkit-line-clamp: 2;
             -webkit-box-orient: vertical;
             overflow: hidden;
             margin-bottom: 8px;
         }

         .link-url {
             font-size: 12px;
             color: #8a8a8a;
             text-decoration: none;
         }

         /* 头像框选择模态框 */
         .change-frame-btn {
             padding: 6px 10px;
             border: 1px solid #ccc;
             background-color: #f0f0f0;
             border-radius: 5px;
             cursor: pointer;
             font-size: 13px;
             margin-left: 10px;
         }

         #avatar-frame-modal .modal-content {
             height: 70%;
         }

         #avatar-frame-modal .modal-body {
             padding: 0;
             display: flex;
             flex-direction: column;
         }
           
         .frame-tabs {
             display: flex;
             border-bottom: 1px solid var(--border-color);
             flex-shrink: 0;
         }

         .frame-tab {
             flex: 1;
             padding: 12px;
             text-align: center;
             font-weight: 500;
             cursor: pointer;
             color: var(--text-secondary);
             border-bottom: 2px solid transparent;
         }

         .frame-tab.active {
             color: var(--accent-color);
             border-bottom-color: var(--accent-color);
         }

         .frame-content {
             flex-grow: 1;
             overflow-y: auto;
             padding: 15px;
         }

         .frame-grid {
             display: grid;
             grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
             gap: 15px;
         }

         .frame-item {
             aspect-ratio: 1 / 1;
             border: 2px solid transparent;
             border-radius: 10px;
             cursor: pointer;
             background-color: #f0f0f0;
             background-size: cover;
             background-position: center;
             padding: 5px;
             transition: all 0.2s ease;
             position: relative;
         }

         .frame-item.selected {
             border-color: var(--accent-color);
             transform: scale(1.05);
         }

         .frame-item .preview-avatar {
             width: 100%;
             height: 100%;
             border-radius: 50%;
             object-fit: cover;
         }

         .frame-item .preview-frame {
             position: absolute;
             top: -7px;
             left: 0;
             width: 100%;
             height: 100%;
         }

         /* 字体预览 */
         #font-preview {
             transition: font-family 0.3s ease;
         }

         /* 底部导航栏样式 */
         #chat-list-bottom-nav {
             position: absolute;
             bottom: 0;
             left: 0;
             width: 100%;
             height: 50px;
             background-color: rgba(247, 247, 247, 0.9);
             backdrop-filter: blur(10px);
             -webkit-backdrop-filter: blur(10px);
             border-top: 1px solid var(--border-color);
             display: flex;
             justify-content: space-around;
             align-items: center;
             z-index: 10;
         }

         .nav-item {
             display: flex;
             flex-direction: column;
             align-items: center;
             gap: 4px;
             cursor: pointer;
             transition: all 0.2s ease;
             padding: 5px;
             border-radius: 8px;
         }

         .nav-item:hover {
             background-color: rgba(0, 0, 0, 0.05);
         }

         .nav-item.active {
             color: var(--accent-color);
         }

         .nav-item .nav-icon {
             font-size: 20px;
         }

         .nav-item .nav-label {
             font-size: 10px;
             font-weight: 500;
         }

         /* 确保聊天列表为底部导航留出空间 */
         #chat-list {
             padding-bottom: 60px;
         }
     /* 链接分享卡片样式 */
     .link-share-card {
         background-color: #fff;
         border-radius: 10px;
         border: 1px solid #e0e0e0;
         padding: 12px;
         cursor: pointer;
         transition: background-color 0.2s;
         display: flex;
         flex-direction: column;
         gap: 8px;
     }
     
     .link-share-card:hover {
         background-color: #f9f9f9;
     }
     
     .link-share-card .title {
         font-weight: 600;
         font-size: 15px;
         line-height: 1.4;
         color: #1f1f1f;
         display: -webkit-box;
         -webkit-line-clamp: 2;
         -webkit-box-orient: vertical;
         overflow: hidden;
         text-overflow: ellipsis;
     }
     
     .link-share-card .description {
         font-size: 13px;
         color: #8a8a8a;
         display: -webkit-box;
         -webkit-line-clamp: 3;
         -webkit-box-orient: vertical;
         overflow: hidden;
         text-overflow: ellipsis;
     }
     
     .link-share-card .footer {
         display: flex;
         align-items: center;
         gap: 6px;
         font-size: 12px;
         color: var(--text-secondary);
         margin-top: 4px;
     }
     
     .link-share-card .footer-icon {
         width: 14px;
         height: 14px;
         flex-shrink: 0;
     }
     
     /* 评论项样式 */
     .comment-item {
         position: relative;
         padding-right: 25px;
     }
     
     .comment-delete-btn {
         position: absolute;
         top: 50%;
         right: 0;
         transform: translateY(-50%);
         width: 22px;
         height: 22px;
         line-height: 22px;
         text-align: center;
         border-radius: 50%;
         color: var(--text-secondary);
         font-size: 18px;
         cursor: pointer;
         transition: all 0.2s ease;
         opacity: 0;
     }
     
     .comment-item:hover .comment-delete-btn {
         opacity: 1;
     }
     
     .comment-delete-btn:hover {
         background-color: #f0f0f0;
         color: #ff3b30;
     }
     
     /* 夜间模式样式 */
     #phone-screen.dark-mode {
         --secondary-bg: #1c1c1e;
         --border-color: #38383a;
         --text-primary: #ffffff;
         --text-secondary: #8d8d92;
     }
     
     #phone-screen.dark-mode #chat-list-screen,
     #phone-screen.dark-mode #qzone-screen .qzone-content,
     #phone-screen.dark-mode #memories-view {
         background-color: #000000;
     }
     
     #phone-screen.dark-mode #chat-list {
         background-color: transparent;
     }
     
     #phone-screen.dark-mode .chat-list-bg-layer {
         background-color: #000000;
     }
     
     #phone-screen.dark-mode .chat-list-item {
         border-bottom-color: rgba(255, 255, 255, 0.15);
     }
     
     #phone-screen.dark-mode .chat-group-header {
         background-color: #1c1c1e;
         border-bottom: 1px solid #38383a;
     }
     
     #phone-screen.dark-mode .chat-group-header:hover {
         background-color: #2c2c2e;
         transform: translateX(1px);
     }
     
     #phone-screen.dark-mode .chat-list-item .name,
     #phone-screen.dark-mode .chat-group-header .group-name {
         color: #ffffff;
     }
     
     #phone-screen.dark-mode .chat-list-item:hover {
         background-color: rgba(255, 255, 255, 0.08);
         transform: translateX(2px);
         box-shadow: 0 2px 8px rgba(255, 255, 255, 0.1);
     }
     
     #phone-screen.dark-mode .header,
     #phone-screen.dark-mode .qzone-header {
         background-color: rgba(25, 25, 25, 0.9);
         backdrop-filter: blur(15px);
         -webkit-backdrop-filter: blur(15px);
         border-bottom-color: rgba(255, 255, 255, 0.15);
         color: #ffffff;
     }
     
     #phone-screen.dark-mode .header .back-btn,
     #phone-screen.dark-mode .header .action-btn,
     #phone-screen.dark-mode .header .save-btn {
         color: #ffffff;
     }
     
     #phone-screen.dark-mode .user-avatar {
         border-color: #444444;
     }
     
     #phone-screen.dark-mode .user-avatar:hover {
         border-color: #007bff;
     }
     
     #phone-screen.dark-mode .user-dropdown-menu {
         background-color: #2d2d2d;
         border-color: #444444;
     }
     
     #phone-screen.dark-mode .dropdown-item {
         border-bottom-color: #444444;
     }
     
     #phone-screen.dark-mode .dropdown-item:hover {
         background-color: #3d3d3d;
     }
     
     #phone-screen.dark-mode .dropdown-item span {
         color: #ffffff;
     }
     
     #phone-screen.dark-mode .dropdown-item svg {
         color: #007bff;
     }
     
     #phone-screen.dark-mode .add-dropdown-menu {
         background-color: #2d2d2d;
         border-color: #444444;
         box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
     }
     
     #phone-screen.dark-mode .add-dropdown-menu .dropdown-item {
         border-bottom-color: #444444;
     }
     
     #phone-screen.dark-mode .add-dropdown-menu .dropdown-item:hover {
         background-color: #3d3d3d;
     }
     
     #phone-screen.dark-mode .add-dropdown-menu .dropdown-item span {
         color: #ffffff;
     }
     
     #phone-screen.dark-mode .add-dropdown-menu .dropdown-item svg {
         color: #007bff;
     }
     
     #phone-screen.dark-mode #chat-list-bottom-nav {
         background-color: rgba(25, 25, 25, 0.9);
         border-top-color: rgba(255, 255, 255, 0.15);
     }
     
     #phone-screen.dark-mode .nav-item.active {
         color: #ffffff;
     }
     
     #phone-screen.dark-mode #chat-input-area {
         background-color: transparent;
         border-top: none;
     }
     
     #phone-screen.dark-mode #chat-input {
         background-color: #3e3e42;
         color: #ffffff;
     }
     
     #phone-screen.dark-mode #chat-input::placeholder {
         color: #8d8d92;
     }
     
     #phone-screen.dark-mode .chat-action-icon-btn {
         color: #ffffff;
         background-color: rgba(255, 255, 255, 0.1);
         border: none;
     }
     
     #phone-screen.dark-mode #send-btn {
         background-color: var(--accent-color);
     }
     
     #phone-screen.dark-mode .qzone-actions-bar,
     #phone-screen.dark-mode .qzone-post-item {
         background-color: #1c1c1e;
         border: 1px solid #333;
         box-shadow: 0 2px 8px rgba(255, 255, 255, 0.05);
     }
     
     #phone-screen.dark-mode .action-item:not(:last-child)::after {
         background-color: #333;
     }
     
     #phone-screen.dark-mode .post-footer,
     #phone-screen.dark-mode .post-likes-section {
         border-top-color: #333;
     }
     
     #phone-screen.dark-mode .post-likes-section {
         background-color: rgba(0, 123, 255, 0.1);
     }
     
     #phone-screen.dark-mode .comment-input {
         background-color: #333;
         color: #ffffff;
     }
     
     #phone-screen.dark-mode .comment-input::placeholder {
         color: #8d8d92;
     }
     
     #phone-screen.dark-mode .post-actions-btn:hover {
         background-color: #333;
     }
     
     #phone-screen.dark-mode .at-mention-popup {
         background-color: #1c1c1e;
         border-color: #333;
     }
     
     #phone-screen.dark-mode .at-mention-item {
         border-bottom-color: #333;
     }
     
     #phone-screen.dark-mode .at-mention-item:hover {
         background-color: #333;
     }
     
     #phone-screen.dark-mode .memory-card {
         background-color: #1c1c1e;
         border-left-color: #e6a753;
         box-shadow: 0 4px 12px rgba(255, 255, 255, 0.08);
     }
     
     #phone-screen.dark-mode .memory-card .header {
         background-color: #2c2c2e;
         border-bottom-color: #38383a;
         margin: -15px -15px 8px -15px;
         padding: 12px 15px;
         border-radius: 12px 12px 0 0;
     }
     
     #phone-screen.dark-mode .memory-card .header .date,
     #phone-screen.dark-mode .memory-card .header .author,
     #phone-screen.dark-mode .memory-card .content {
         color: #e0e0e0;
     }
     
     #phone-screen.dark-mode #api-settings-screen,
     #phone-screen.dark-mode #font-settings-screen,
     #phone-screen.dark-mode #wallpaper-screen,
     #phone-screen.dark-mode #contact-picker-screen,
     #phone-screen.dark-mode #member-management-screen,
     #phone-screen.dark-mode #world-book-editor-screen,
     #phone-screen.dark-mode #world-book-list,
     #phone-screen.dark-mode .list-item:hover,
     #phone-screen.dark-mode .list-container,
     #phone-screen.dark-mode .form-container {
         background-color: #000000;
     }
     
     #phone-screen.dark-mode .form-group input, 
     #phone-screen.dark-mode .form-group select, 
     #phone-screen.dark-mode .form-group textarea {
         background-color: #1c1c1e;
         color: #ffffff;
         border-color: #38383a;
     }
     
     #phone-screen.dark-mode .form-button-secondary {
         background-color: #333;
         border-color: #555;
         color: #fff;
     }
     
     #phone-screen.dark-mode #font-preview {
         background-color: #1c1c1e;
         border-color: #38383a;
     }
     
     #phone-screen.dark-mode #font-preview p {
         color: #ffffff;
     }
     
     /* 夜间模式视觉修正 */
     #phone-screen.dark-mode .qzone-post-item .post-nickname,
     #phone-screen.dark-mode .qzone-post-item .post-content {
         color: #f0f0f0;
     }
     
     #phone-screen.dark-mode .favorite-item-card .fav-card-header .name,
     #phone-screen.dark-mode .favorite-item-card .fav-card-content {
         color: #f0f0f0;
     }
     
     #phone-screen.dark-mode .favorite-item-card .fav-card-header .source {
         color: #8d8d92;
     }
     
     #phone-screen.dark-mode .search-bar-container {
         background-color: #000000;
     }
     
     #phone-screen.dark-mode #favorites-search-input {
         background-color: #1c1c1e;
         border-color: #38383a;
         color: #ffffff;
     }
     
     #phone-screen.dark-mode #favorites-search-input::placeholder {
         color: #8d8d92;
     }
     
     /* iOS风格的Toggle Switch开关样式 */
     .toggle-switch {
         position: relative;
         display: inline-block;
         width: 51px;
         height: 31px;
     }
     
     .toggle-switch input {
         opacity: 0;
         width: 0;
         height: 0;
     }
     
     .slider {
         position: absolute;
         cursor: pointer;
         top: 0;
         left: 0;
         right: 0;
         bottom: 0;
         background-color: #e9e9eb;
         transition: .4s;
         border-radius: 34px;
     }
     
     .slider:before {
         position: absolute;
         content: "";
         height: 27px;
         width: 27px;
         left: 2px;
         bottom: 2px;
         background-color: white;
         transition: .4s;
         border-radius: 50%;
         box-shadow: 0 1px 2px rgba(0,0,0,0.1);
     }
     
     input:checked + .slider {
         background-color: #34c759;
     }
     
     input:checked + .slider:before {
         transform: translateX(20px);
     }
     
     /* 引用回复功能样式 */
     #reply-preview-bar {
         display: none;
         padding: 8px 12px;
         margin: 0 8px 8px 8px;
         background-color: rgba(0, 0, 0, 0.05);
         border-left: 3px solid var(--accent-color);
         border-radius: 6px;
         position: relative;
         font-size: 13px;
         color: var(--text-secondary);
     }
     
     #phone-screen.dark-mode #reply-preview-bar {
         background-color: rgba(255, 255, 255, 0.1);
     }
     
     .reply-preview-content .sender {
         font-weight: 600;
         color: var(--text-primary);
     }
     
     .reply-preview-content .text {
         white-space: nowrap;
         overflow: hidden;
         text-overflow: ellipsis;
         display: block;
         max-width: 95%;
     }
     
     #cancel-reply-btn {
         position: absolute;
         top: 50%;
         right: 8px;
         transform: translateY(-50%);
         width: 20px;
         height: 20px;
         line-height: 20px;
         text-align: center;
         border-radius: 50%;
         background-color: rgba(0,0,0,0.1);
         cursor: pointer;
         font-size: 14px;
     }
     
     .quoted-message {
         padding: 6px 10px;
         margin-bottom: 6px;
         background-color: rgba(0, 0, 0, 0.04);
         border-left: 2px solid var(--accent-color);
         border-radius: 4px;
         font-size: 0.9em;
         opacity: 0.8;
     }
     
     #phone-screen.dark-mode .quoted-message {
         background-color: rgba(255, 255, 255, 0.08);
         border-left-color: #a0cff1;
     }
     
     .quoted-message .quoted-sender {
         font-weight: 600;
         color: var(--accent-color);
     }
     
     #phone-screen.dark-mode .quoted-message .quoted-sender {
         color: #a0cff1;
     }
     
     .quoted-message .quoted-content {
         color: var(--text-secondary);
         white-space: nowrap;
         overflow: hidden;
         text-overflow: ellipsis;
         display: block;
     }
     
     /* 字体预览框样式 */
     #font-preview {
         padding: 20px;
         border: 1px solid var(--border-color);
         border-radius: 8px;
         background-color: #f9f9f9;
         transition: background-color 0.3s, border-color 0.3s;
     }
     
     #font-preview p {
         color: var(--text-primary);
     }
     
     /* 精致版转账操作弹窗样式 */
     .transfer-actions-content {
         background-color: #fff0f5;
         border-radius: 20px;
         width: 290px;
         padding: 20px;
         box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3);
         text-align: center;
         position: relative;
         border: 1px solid #ffcce0;
         font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
     }
     
     .transfer-actions-header {
         font-size: 20px;
         font-weight: bold;
         color: #a35c7b;
         margin-bottom: 15px;
     }
     
     .transfer-actions-body p {
         font-size: 15px;
         color: #555;
         margin: 0 0 25px 0;
         line-height: 1.5;
     }
     
     .transfer-actions-footer {
         display: flex;
         justify-content: space-between;
         gap: 15px;
     }
     
     .transfer-actions-footer .action-btn {
         flex: 1;
         padding: 12px;
         border: none;
         border-radius: 12px;
         font-size: 16px;
         font-weight: 600;
         cursor: pointer;
         transition: transform 0.2s, box-shadow 0.2s;
         color: white;
     }
     
     .transfer-actions-footer .action-btn:active {
         transform: scale(0.95);
     }
     
     .transfer-actions-footer .action-btn.accept {
         background: linear-gradient(135deg, #ff85b3, #ff69b4);
         box-shadow: 0 4px 10px rgba(255, 105, 180, 0.4);
     }
     
     .transfer-actions-footer .action-btn.decline {
         background: linear-gradient(135deg, #c2c2c2, #a0a0a0);
         box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
     }
     
     .transfer-actions-content .cancel-btn {
         position: absolute;
         top: 10px;
         right: 10px;
         width: 28px;
         height: 28px;
         border-radius: 50%;
         border: none;
         background-color: rgba(0, 0, 0, 0.1);
         color: #a35c7b;
         font-size: 20px;
         line-height: 28px;
         cursor: pointer;
     }
     
     /* 未读消息红点样式 */
     .unread-count-wrapper {
         flex-shrink: 0;
         width: 40px;
         display: flex;
         justify-content: center;
         align-items: flex-start;
         padding-top: 20px;
     }
     
     .unread-count {
         min-width: 20px;
         height: 20px;
         padding: 0 6px;
         background-color: #ff3b30;
         color: white;
         font-size: 13px;
         font-weight: 500;
         line-height: 20px;
         text-align: center;
         border-radius: 10px;
         box-shadow: 0 1px 2px rgba(0,0,0,0.15);
         display: none;
         justify-content: center;
         align-items: center;
     }
     
     /* 通话记录页面与卡片样式 */
     #call-history-screen {
         background-color: #f0f2f5;
     }
     
     .call-record-card {
         background-color: var(--secondary-bg);
         border-radius: 12px;
         padding: 15px;
         box-shadow: 0 2px 8px rgba(0,0,0,0.08);
         cursor: pointer;
         transition: transform 0.2s ease, box-shadow 0.2s ease;
         border-left: 5px solid var(--accent-color);
     }
     
     .call-record-card:hover {
         transform: translateY(-3px);
         box-shadow: 0 6px 12px rgba(0,0,0,0.1);
     }
     
     .call-record-card .card-header {
         display: flex;
         justify-content: space-between;
         align-items: center;
         font-size: 13px;
         color: var(--text-secondary);
         margin-bottom: 12px;
         padding-bottom: 8px;
         border-bottom: 1px solid var(--border-color);
     }
     
     .call-record-card .card-header .duration {
         font-weight: 500;
         color: var(--text-primary);
     }
     
     .call-record-card .card-body {
         display: flex;
         align-items: center;
     }
     
     .call-record-card .participants-avatars {
         display: flex;
         align-items: center;
     }
     
     .call-record-card .participant-avatar {
         width: 36px;
         height: 36px;
         border-radius: 50%;
         object-fit: cover;
         border: 2px solid white;
         box-shadow: 0 1px 3px rgba(0,0,0,0.1);
     }
     
     .call-record-card .participant-avatar:not(:first-child) {
         margin-left: -12px;
     }
     
     .call-record-card .participants-names {
         margin-left: 12px;
         font-weight: 600;
         color: var(--text-primary);
         font-size: 15px;
     }
     
     #transcript-modal-body {
         display: flex;
         flex-direction: column;
         gap: 12px;
         padding: 15px;
     }
     
     .transcript-entry {
         padding: 8px 12px;
         border-radius: 10px;
         max-width: 85%;
         line-height: 1.5;
         word-break: break-word;
     }
     
     .transcript-entry.user {
         background-color: #dcf8c6;
         align-self: flex-end;
     }
     
     .transcript-entry.assistant {
         background-color: #ffffff;
         align-self: flex-start;
     }
     
     /* 通话记录卡片美化样式 */
     .call-record-card .card-body {
         display: flex;
         flex-direction: column;
         gap: 8px;
     }
     
     .call-record-card .custom-title {
         font-size: 16px;
         font-weight: 600;
         color: var(--text-primary);
         padding-bottom: 8px;
         border-bottom: 1px solid var(--border-color);
         margin-bottom: 4px;
     }
     
     .call-record-card .participants-info {
         display: flex;
         align-items: center;
     }
     
     .call-record-card .participants-names {
         margin-left: 12px;
         font-weight: 500;
         font-size: 14px;
         color: var(--text-secondary);
     }
     </style>
 </head>
 <body>
     <!-- 加载屏幕 -->
     <div id="loading-screen">
         <div class="loading-content">
             <h1 class="loading-title">LingKi</h1>
             <h2 class="loading-subtitle">AI 聊天助手</h2>
             <div class="loading-progress-container">
                 <div class="loading-progress-bar"></div>
             </div>
             <div class="loading-particles"></div>
         </div>
     </div>
     
     <!-- 主手机屏幕 -->
     <div id="phone-screen">
         <!-- 状态栏 -->
         <div id="status-bar">
             <div class="status-bar-left">
                 <span class="time">12:30</span>
             </div>
             <div class="status-bar-right">
                 <span class="battery">100%</span>
                 <span class="wifi">📶</span>
                 <span class="signal">📱</span>
             </div>
         </div>
         
         <!-- 通知栏 -->
         <div id="notification-bar" style="display: none;">
             <div class="notification-content">
                 <div class="notification-icon"></div>
                 <div class="notification-text"></div>
             </div>
             <div class="notification-close">×</div>
         </div>
         
         <!-- 世界观管理屏幕 -->
         <div id="world-book-screen" class="app-screen" style="display: none;">
             <div class="header">
                 <div class="back-btn">←</div>
                 <div class="title">世界观管理</div>
                 <div class="action-btn">+</div>
             </div>
             <div id="world-book-list" class="list-container">
                 <!-- 世界观条目将在这里动态生成 -->
             </div>
         </div>
         
         <!-- 世界观编辑屏幕 -->
         <div id="world-book-editor-screen" class="app-screen" style="display: none;">
             <div class="header">
                 <div class="back-btn">←</div>
                 <div class="title">编辑世界观</div>
                 <div class="save-btn">保存</div>
             </div>
             <div class="form-container">
                 <div class="form-group">
                     <label for="world-name">世界观名称</label>
                     <input type="text" id="world-name" placeholder="输入世界观名称">
                 </div>
                 <div class="form-group">
                     <label for="world-description">世界观描述</label>
                     <textarea id="world-description" placeholder="详细描述这个世界观的设定" rows="6"></textarea>
                 </div>
                 <div class="form-group">
                     <label for="character-name">角色名称</label>
                     <input type="text" id="character-name" placeholder="输入角色名称">
                 </div>
                 <div class="form-group">
                     <label for="character-description">角色描述</label>
                     <textarea id="character-description" placeholder="详细描述这个角色的设定" rows="6"></textarea>
                 </div>
                 <div class="form-group">
                     <label for="chat-example">对话示例</label>
                     <textarea id="chat-example" placeholder="提供一些对话示例，帮助AI理解角色" rows="6"></textarea>
                 </div>
                 <div class="form-group">
                     <label for="world-book-avatar">角色头像</label>
                     <div class="avatar-preview-container">
                         <img id="world-book-avatar-preview" src="" alt="角色头像预览" style="display: none;">
                         <div id="world-book-avatar-placeholder">选择头像</div>
                     </div>
                     <input type="file" id="world-book-avatar" accept="image/*" style="display: none;">
                 </div>
                 <div class="form-actions">
                     <button id="delete-world-btn" class="form-button-danger">删除</button>
                 </div>
             </div>
         </div>
         
         <!-- API设置屏幕 -->
         <div id="api-settings-screen" class="app-screen" style="display: none;">
             <div class="header">
                 <div class="back-btn">←</div>
                 <div class="title">API设置</div>
                 <div class="save-btn">保存</div>
             </div>
             <div class="form-container">
                 <div class="form-group">
                     <label for="api-proxy">API代理</label>
                     <input type="text" id="api-proxy" placeholder="输入API代理地址（可选）">
                 </div>
                 <div class="form-group">
                     <label for="api-key">API密钥</label>
                     <input type="password" id="api-key" placeholder="输入你的API密钥">
                 </div>
                 <div class="form-group">
                     <label for="model-selection">模型选择</label>
                     <select id="model-selection">
                         <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                         <option value="gpt-4">GPT-4</option>
                         <option value="gpt-4-turbo">GPT-4 Turbo</option>
                         <option value="claude-instant-1">Claude Instant</option>
                         <option value="claude-2">Claude 2</option>
                     </select>
                 </div>
                 <div class="form-group">
                     <label>后台活动</label>
                     <div class="toggle-container">
                         <label class="toggle-switch">
                             <input type="checkbox" id="background-activity-toggle">
                             <span class="slider"></span>
                         </label>
                         <span class="toggle-label">允许应用在后台继续运行</span>
                     </div>
                 </div>
                 <div class="form-group">
                     <label>冷却时间</label>
                     <div class="range-container">
                         <input type="range" id="cooldown-range" min="0" max="60" value="0">
                         <span id="cooldown-value">0秒</span>
                     </div>
                     <p class="form-help">设置消息发送间隔，避免API请求过于频繁</p>
                 </div>
                 <div class="form-group">
                     <label>数据管理</label>
                     <div class="button-group">
                         <button id="export-data-btn" class="form-button-secondary">导出数据</button>
                         <button id="import-data-btn" class="form-button-secondary">导入数据</button>
                         <button id="reset-data-btn" class="form-button-danger">重置数据</button>
                     </div>
                 </div>
             </div>
         </div>
         
         <!-- 聊天列表屏幕 -->
         <div id="chat-list-screen" class="app-screen">
             <div class="header">
                 <div class="chat-type-toggle">
                     <span class="toggle-option active" data-type="all">全部</span>
                     <span class="toggle-option" data-type="ai">AI</span>
                     <span class="toggle-option" data-type="group">群聊</span>
                     <div class="toggle-indicator"></div>
                 </div>
                 <div class="add-btn">+</div>
                 <div class="add-dropdown-menu" style="display: none;">
                     <div class="dropdown-item" id="add-friend-item">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                             <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                             <circle cx="9" cy="7" r="4"></circle>
                             <line x1="19" y1="8" x2="19" y2="14"></line>
                             <line x1="16" y1="11" x2="22" y2="11"></line>
                         </svg>
                         <span>添加好友</span>
                      </div>
                      <div class="dropdown-item" id="create-group-chat-item">
                          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                              <circle cx="9" cy="7" r="4"></circle>
                              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                          </svg>
                          <span>创建群聊</span>
                      </div>
                  </div>
              </div>
              
              <!-- 用户头像容器 -->
              <div class="user-avatar-container">
                  <div class="user-avatar">
                      <img src="https://api.dicebear.com/6.x/micah/svg?seed=Felix" alt="用户头像">
                  </div>
                  <div class="user-dropdown-menu" style="display: none;">
                      <div class="dropdown-item" id="api-settings-item">
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <circle cx="12" cy="12" r="3"></circle>
                              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                          </svg>
                          <span>API设置</span>
                      </div>
                      <div class="dropdown-item" id="appearance-settings-item">
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <circle cx="12" cy="12" r="10"></circle>
                              <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                              <line x1="9" y1="9" x2="9.01" y2="9"></line>
                              <line x1="15" y1="9" x2="15.01" y2="9"></line>
                          </svg>
                          <span>外观设置</span>
                      </div>
                      <div class="dropdown-item" id="font-settings-item">
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <polyline points="4 7 4 4 20 4 20 7"></polyline>
                              <line x1="9" y1="20" x2="15" y2="20"></line>
                              <line x1="12" y1="4" x2="12" y2="20"></line>
                          </svg>
                          <span>字体设置</span>
                      </div>
                      <div class="dropdown-item" id="world-book-item">
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                              <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                          </svg>
                          <span>世界观</span>
                      </div>
                      <div class="dropdown-item" id="memories-item">
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                              <line x1="16" y1="2" x2="16" y2="6"></line>
                              <line x1="8" y1="2" x2="8" y2="6"></line>
                              <line x1="3" y1="10" x2="21" y2="10"></line>
                          </svg>
                          <span>回忆录</span>
                      </div>
                      <div class="dropdown-item" id="favorites-item">
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                          </svg>
                          <span>收藏夹</span>
                      </div>
                      <div class="dropdown-item" id="change-avatar-item">
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                              <circle cx="12" cy="7" r="4"></circle>
                          </svg>
                          <span>更换头像</span>
                      </div>
                      <div class="dropdown-item" id="chat-background-item">
                          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                              <circle cx="8.5" cy="8.5" r="1.5"></circle>
                              <polyline points="21 15 16 10 5 21"></polyline>
                          </svg>
                          <span>聊天背景</span>
                      </div>
                  </div>
              </div>
              
              <!-- 消息视图 -->
              <div id="messages-view">
                  <div class="chat-list-bg-layer"></div>
                  <div id="chat-list">
                      <!-- 聊天列表将在这里动态生成 -->
                  </div>
              </div>
              
              <!-- 底部导航栏 -->
              <div id="chat-list-bottom-nav">
                  <div class="nav-item active" data-screen="chat-list-screen">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                      </svg>
                      <span>聊天</span>
                  </div>
                  <div class="nav-item" data-screen="qzone-screen">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M18 8h1a4 4 0 0 1 0 8h-1"></path>
                          <path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path>
                          <line x1="6" y1="1" x2="6" y2="4"></line>
                          <line x1="10" y1="1" x2="10" y2="4"></line>
                          <line x1="14" y1="1" x2="14" y2="4"></line>
                      </svg>
                      <span>空间</span>
                  </div>
                  <div class="nav-item" data-screen="call-history-screen">
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                      </svg>
                      <span>通话</span>
                  </div>
              </div>
          </div>
          
          <!-- QZone空间屏幕 -->
          <div id="qzone-screen" class="app-screen" style="display: none;">
              <div class="qzone-header">
                  <div class="back-btn">←</div>
                  <div class="title">空间动态</div>
                  <div class="action-btn">+</div>
              </div>
              <div class="qzone-profile-header">
                  <svg width="100%" height="120" preserveAspectRatio="none">
                      <defs>
                          <linearGradient id="header-gradient" x1="0%" y1="0%" x2="0%" y2="100%">
                              <stop offset="0%" style="stop-color:#3f87ff;stop-opacity:1" />
                              <stop offset="100%" style="stop-color:#758fff;stop-opacity:1" />
                          </linearGradient>
                      </defs>
                      <rect width="100%" height="100%" fill="url(#header-gradient)" />
                  </svg>
              </div>
          </div>
      </div>

      <!-- 聊天界面屏幕 -->
      <div id="chat-interface-screen" class="screen">
          <div class="chat-header">
              <div class="status-notification-bar">
                  <div class="status-bar">
                      <span class="time">9:41</span>
                      <div class="status-icons">
                          <span class="signal">📶</span>
                          <span class="wifi">📶</span>
                          <span class="battery">🔋</span>
                      </div>
                  </div>
                  <div class="notification-bar">
                      <div class="notification-content">
                          <span class="notification-text">新消息通知</span>
                          <button class="notification-close">×</button>
                      </div>
                  </div>
              </div>
              <div class="chat-header-main">
                  <button class="back-btn" id="chat-back-btn">‹</button>
                  <div class="chat-info">
                      <div class="chat-avatar">
                          <img id="chat-avatar-img" src="" alt="聊天头像">
                      </div>
                      <div class="chat-details">
                          <h3 id="chat-title">聊天标题</h3>
                          <span id="chat-status">在线</span>
                      </div>
                  </div>
                  <div class="chat-actions">
                      <button class="search-btn" id="chat-search-btn">🔍</button>
                      <button class="more-btn" id="chat-more-btn">⋯</button>
                  </div>
              </div>
          </div>
          
          <div class="message-area" id="message-area">
              <!-- 消息将在这里动态生成 -->
          </div>
          
          <div class="input-area">
              <div class="input-container">
                  <button class="action-btn" id="sticker-btn">😊</button>
                  <button class="action-btn" id="send-photo-btn">📷</button>
                  <button class="action-btn" id="upload-image-btn">🖼️</button>
                  <input type="text" id="message-input" placeholder="输入消息...">
                  <button class="action-btn" id="transfer-btn">💰</button>
                  <button class="action-btn" id="voice-btn">🎤</button>
                  <button class="action-btn" id="send-waimai-btn">🍔</button>
                  <button class="action-btn" id="video-call-btn">📹</button>
                  <button class="action-btn" id="group-video-call-btn">👥</button>
                  <button class="action-btn" id="send-poll-btn">📊</button>
                  <button class="action-btn" id="share-link-btn">🔗</button>
                  <button class="send-btn" id="send-btn">发送</button>
              </div>
          </div>
      </div>

      <!-- 聊天锁定覆盖层 -->
      <div id="chat-lock-overlay" class="modal" style="display: none;">
          <div class="lock-content">
              <div class="lock-icon">🔒</div>
              <h3>聊天已锁定</h3>
              <p>请输入密码解锁聊天</p>
              <input type="password" id="chat-unlock-input" placeholder="输入密码">
              <div class="lock-actions">
                  <button id="unlock-chat-btn">解锁</button>
                  <button id="cancel-unlock-btn">取消</button>
              </div>
          </div>
      </div>

      <!-- 表情面板 -->
      <div id="sticker-panel" class="panel" style="display: none;">
          <div class="panel-header">
              <h3>表情包</h3>
              <button class="close-btn" id="close-sticker-panel">×</button>
          </div>
          <div class="sticker-grid">
              <!-- 表情包将在这里动态生成 -->
          </div>
      </div>

      <!-- 音乐播放器覆盖层 -->
      <div id="music-player-overlay" class="modal" style="display: none;">
          <div class="music-player-content">
              <div class="album-art">
                  <img id="album-art-img" src="" alt="专辑封面">
              </div>
              <div class="music-info">
                  <h3 id="song-title">歌曲标题</h3>
                  <p id="artist-name">艺术家</p>
              </div>
              <div class="music-controls">
                  <button id="prev-btn">⏮️</button>
                  <button id="play-pause-btn">⏯️</button>
                  <button id="next-btn">⏭️</button>
              </div>
              <div class="progress-bar">
                  <input type="range" id="progress-slider" min="0" max="100" value="0">
              </div>
              <button class="close-music-btn" id="close-music-player">×</button>
          </div>
      </div>

      <!-- 播放列表面板 -->
      <div id="playlist-panel" class="panel" style="display: none;">
          <div class="panel-header">
              <h3>播放列表</h3>
              <button class="close-btn" id="close-playlist-panel">×</button>
          </div>
          <div class="playlist-content">
               <!-- 播放列表将在这里动态生成 -->
           </div>
       </div>

       <!-- 外观设置屏幕 -->
       <div id="wallpaper-screen" class="screen">
           <div class="header">
               <span class="back-btn" id="wallpaper-back-btn">‹</span>
               <span>外观设置</span>
               <span style="width: 30px;"></span>
           </div>
           <div class="wallpaper-content">
               <div class="wallpaper-section">
                   <h3>聊天背景</h3>
                   <div class="wallpaper-grid" id="wallpaper-grid">
                       <!-- 背景选项将在这里动态生成 -->
                   </div>
                   <div class="wallpaper-upload">
                       <input type="file" id="wallpaper-upload-input" accept="image/*" hidden>
                       <button id="wallpaper-upload-btn">上传自定义背景</button>
                   </div>
               </div>
               <div class="app-icon-section">
                   <h3>应用图标</h3>
                   <div class="icon-grid" id="app-icon-grid">
                       <!-- 应用图标选项将在这里动态生成 -->
                   </div>
               </div>
               <div class="wallpaper-actions">
                   <button id="wallpaper-save-btn" class="save-btn">保存设置</button>
               </div>
           </div>
       </div>

       <!-- 聊天列表背景设置屏幕 -->
       <div id="chat-list-bg-screen" class="screen">
           <div class="header">
               <span class="back-btn" id="chat-list-bg-back-btn">‹</span>
               <span>聊天列表背景</span>
               <span style="width: 30px;"></span>
           </div>
           <div class="chat-list-bg-content">
               <div class="bg-upload-section">
                   <h3>上传背景图片</h3>
                   <input type="file" id="chat-list-bg-upload-input" accept="image/*" hidden>
                   <button id="chat-list-bg-upload-btn">选择图片</button>
                   <div id="chat-list-bg-preview" class="bg-preview"></div>
               </div>
               <div class="bg-opacity-section">
                   <h3>背景透明度</h3>
                   <div class="opacity-control">
                       <input type="range" id="chat-list-bg-opacity" min="0" max="100" value="50">
                       <span id="opacity-value">50%</span>
                   </div>
               </div>
               <div class="bg-apply-section">
                   <h3>应用设置</h3>
                   <label class="checkbox-label">
                       <input type="checkbox" id="apply-to-chat-bg">
                       <span>同时应用到聊天界面背景</span>
                   </label>
               </div>
               <div class="bg-actions">
                   <button id="chat-list-bg-save-btn" class="save-btn">保存设置</button>
                   <button id="chat-list-bg-reset-btn" class="reset-btn">重置</button>
               </div>
           </div>
       </div>

       <!-- 浏览器屏幕 -->
       <div id="browser-screen" class="screen">
           <div class="browser-header">
               <span class="back-btn" id="browser-back-btn">‹</span>
               <div class="url-bar">
                   <input type="url" id="browser-url-input" placeholder="输入网址或搜索...">
                   <button id="browser-go-btn">前往</button>
               </div>
               <button id="browser-share-btn">分享</button>
           </div>
           <div class="browser-content">
               <iframe id="browser-frame" src="about:blank"></iframe>
           </div>
           <div class="browser-toolbar">
               <button id="browser-back">←</button>
               <button id="browser-forward">→</button>
               <button id="browser-refresh">⟳</button>
               <button id="browser-bookmark">⭐</button>
           </div>
       </div>

       <!-- 字体设置屏幕 -->
       <div id="font-settings-screen" class="screen">
           <div class="header">
               <span class="back-btn" id="font-settings-back-btn">‹</span>
               <span>字体设置</span>
               <span style="width: 30px;"></span>
           </div>
           <div class="font-settings-content">
               <div class="font-url-section">
                   <h3>字体URL</h3>
                   <input type="url" id="font-url-input" placeholder="输入Google Fonts或其他字体URL">
                   <button id="load-font-btn">加载字体</button>
               </div>
               <div class="font-preview-section">
                   <h3>字体预览</h3>
                   <div id="font-preview-box" class="font-preview">
                       <p>这是字体预览文本 - The quick brown fox jumps over the lazy dog</p>
                       <p>中文字体预览：你好世界！</p>
                   </div>
               </div>
               <div class="font-size-section">
                   <h3>字体大小</h3>
                   <div class="size-control">
                       <input type="range" id="font-size-slider" min="12" max="24" value="16">
                       <span id="font-size-value">16px</span>
                   </div>
               </div>
               <div class="font-actions">
                   <button id="apply-font-btn" class="save-btn">应用字体</button>
                   <button id="reset-font-btn" class="reset-btn">重置默认</button>
               </div>
           </div>
       </div>

       <!-- 联系人选择器屏幕 -->
       <div id="contact-picker-screen" class="screen">
           <div class="header">
               <span class="back-btn" id="contact-picker-back-btn">‹</span>
               <span>选择联系人</span>
               <span class="action-btn" id="create-group-confirm-btn">确定</span>
           </div>
           <div class="contact-picker-content">
               <div class="search-bar-container">
                   <input type="search" id="contact-search-input" placeholder="搜索联系人...">
               </div>
               <div id="contact-list" class="contact-list">
                   <!-- 联系人列表将在这里动态生成 -->
               </div>
           </div>
       </div>

       <!-- 成员管理屏幕 -->
       <div id="member-management-screen" class="screen">
           <div class="header">
               <span class="back-btn" id="member-management-back-btn">‹</span>
               <span>群成员管理</span>
               <span class="action-btn" id="add-member-btn">+</span>
           </div>
           <div class="member-management-content">
               <div class="member-stats">
                   <span id="member-count">群成员 (0)</span>
               </div>
               <div id="member-list" class="member-list">
                   <!-- 成员列表将在这里动态生成 -->
               </div>
           </div>
       </div>

       <!-- 来电模态框 -->
       <div id="incoming-call-modal" class="modal" style="display: none;">
           <div class="incoming-call-content">
               <div class="caller-info">
                   <div class="caller-avatar">
                       <img id="caller-avatar-img" src="" alt="来电者头像">
                   </div>
                   <h3 id="caller-name">来电者姓名</h3>
                   <p id="call-type">语音通话</p>
               </div>
               <div class="call-actions">
                   <button id="decline-call-btn" class="decline-btn">拒绝</button>
                   <button id="accept-call-btn" class="accept-btn">接听</button>
               </div>
           </div>
       </div>

       <!-- 视频通话屏幕 -->
       <div id="video-call-screen" class="screen">
           <div class="video-call-header">
               <span class="call-duration" id="call-duration">00:00</span>
               <button class="minimize-btn" id="minimize-call-btn">−</button>
           </div>
           <div class="video-call-content">
               <div class="participant-grid" id="participant-grid">
                   <!-- 参与者视频将在这里动态生成 -->
                   <div class="participant-avatar" data-participant="self">
                       <img src="" alt="我的头像">
                       <span class="participant-name">我</span>
                   </div>
               </div>
           </div>
           <div class="video-call-controls">
               <button id="toggle-camera-btn" class="control-btn">📹</button>
               <button id="toggle-mic-btn" class="control-btn">🎤</button>
               <button id="end-call-btn" class="control-btn end-call">📞</button>
               <button id="switch-camera-btn" class="control-btn">🔄</button>
               <button id="join-call-btn" class="control-btn join-btn">加入</button>
           </div>
       </div>

       <!-- 拨出电话屏幕 -->
       <div id="outgoing-call-screen" class="screen">
           <div class="outgoing-call-content">
               <div class="callee-info">
                   <div class="callee-avatar">
                       <img id="callee-avatar-img" src="" alt="接听者头像">
                   </div>
                   <h3 id="callee-name">接听者姓名</h3>
                   <p id="outgoing-call-status">正在呼叫...</p>
               </div>
               <div class="outgoing-call-actions">
                   <button id="cancel-call-btn" class="cancel-btn">取消</button>
               </div>
           </div>
       </div>

       <!-- 通话记录页面 -->
       <div id="call-history-screen" class="screen">
           <div class="header">
               <span class="back-btn" id="call-history-back-btn">‹</span>
               <span>通话记录</span>
               <span class="action-btn" id="clear-call-history-btn">清空</span>
           </div>
           <div class="call-history-content">
               <div id="call-history-list" class="call-history-list">
                   <!-- 通话记录将在这里动态生成 -->
               </div>
           </div>
       </div>

       <!-- 聊天设置模态框 -->
       <div id="chat-settings-modal" class="modal" style="display: none;">
           <div class="modal-content">
               <div class="modal-header">
                   <h3>聊天设置</h3>
                   <button class="close-btn" id="close-chat-settings">×</button>
               </div>
               <div class="modal-body">
                   <div class="setting-section">
                       <h4>分组管理</h4>
                       <div class="group-assignment">
                           <label for="chat-group-select">分配到分组：</label>
                           <select id="chat-group-select">
                               <option value="">选择分组</option>
                               <option value="friends">好友</option>
                               <option value="family">家人</option>
                               <option value="work">工作</option>
                           </select>
                       </div>
                   </div>
                   <div class="setting-section">
                       <h4>群成员管理</h4>
                       <button id="manage-members-btn" class="setting-btn">管理群成员</button>
                   </div>
                   <div class="setting-section">
                       <h4>聊天字体大小</h4>
                       <div class="font-size-control">
                           <input type="range" id="chat-font-size" min="12" max="20" value="14">
                           <span id="chat-font-size-value">14px</span>
                       </div>
                   </div>
                   <div class="setting-section">
                       <h4>自定义CSS</h4>
                       <textarea id="custom-css-input" placeholder="输入自定义CSS样式..."></textarea>
                       <div class="css-preview" id="css-preview">
                           <p>实时预览效果</p>
                       </div>
                   </div>
               </div>
           </div>
       </div>

       <!-- 人格库模态框 -->
       <div id="persona-library-modal" class="modal" style="display: none;">
           <div class="modal-content">
               <div class="modal-header">
                   <h3>人格库</h3>
                   <button class="close-btn" id="close-persona-library">×</button>
               </div>
               <div class="modal-body">
                   <div class="persona-list" id="persona-list">
                       <!-- 人格列表将在这里动态生成 -->
                   </div>
                   <button id="create-persona-btn" class="create-btn">创建新人格</button>
               </div>
           </div>
       </div>

       <!-- 人格编辑器模态框 -->
       <div id="persona-editor-modal" class="modal" style="display: none;">
           <div class="modal-content">
               <div class="modal-header">
                   <h3>编辑人格</h3>
                   <button class="close-btn" id="close-persona-editor">×</button>
               </div>
               <div class="modal-body">
                   <div class="form-group">
                       <label for="persona-name">人格名称</label>
                       <input type="text" id="persona-name" placeholder="输入人格名称">
                   </div>
                   <div class="form-group">
                       <label for="persona-description">人格描述</label>
                       <textarea id="persona-description" placeholder="描述这个人格的特点..."></textarea>
                   </div>
                   <div class="form-group">
                       <label for="persona-prompt">系统提示词</label>
                       <textarea id="persona-prompt" placeholder="输入系统提示词..."></textarea>
                   </div>
                   <div class="modal-actions">
                       <button id="save-persona-btn" class="save-btn">保存</button>
                       <button id="delete-persona-btn" class="delete-btn">删除</button>
                   </div>
               </div>
           </div>
       </div>

       <!-- 成员设置模态框 -->
       <div id="member-settings-modal" class="modal" style="display: none;">
           <div class="modal-content">
               <div class="modal-header">
                   <h3>成员设置</h3>
                   <button class="close-btn" id="close-member-settings">×</button>
               </div>
               <div class="modal-body">
                   <div class="member-info">
                       <div class="member-avatar">
                           <img id="member-avatar-img" src="" alt="成员头像">
                       </div>
                       <h4 id="member-name">成员姓名</h4>
                   </div>
                   <div class="member-actions">
                       <button id="set-admin-btn" class="action-btn">设为管理员</button>
                       <button id="remove-member-btn" class="action-btn danger">移除成员</button>
                   </div>
               </div>
           </div>
       </div>

       <!-- 自定义模态框覆盖层 -->
       <div id="custom-modal-overlay" class="modal" style="display: none;">
           <div class="custom-modal-content">
               <div id="custom-modal-body">
                   <!-- 自定义内容将在这里动态生成 -->
               </div>
           </div>
       </div>

       <!-- 转账模态框 -->
       <div id="transfer-modal" class="modal" style="display: none;">
           <div class="modal-content">
               <div class="modal-header">
                   <h3>转账</h3>
                   <button class="close-btn" id="close-transfer-modal">×</button>
               </div>
               <div class="modal-body">
                   <div class="transfer-info">
                       <div class="recipient-info">
                           <img id="transfer-recipient-avatar" src="" alt="收款人头像">
                           <span id="transfer-recipient-name">收款人</span>
                       </div>
                       <div class="amount-input">
                           <label for="transfer-amount">转账金额</label>
                           <input type="number" id="transfer-amount" placeholder="0.00" step="0.01">
                       </div>
                       <div class="transfer-note">
                           <label for="transfer-note-input">转账说明</label>
                           <input type="text" id="transfer-note-input" placeholder="添加转账说明（可选）">
                       </div>
                   </div>
                   <div class="modal-actions">
                       <button id="confirm-transfer-btn" class="confirm-btn">确认转账</button>
                       <button id="cancel-transfer-btn" class="cancel-btn">取消</button>
                   </div>
               </div>
           </div>
       </div>

       <!-- 电量警告模态框 -->
       <div id="battery-alert-modal" class="modal" style="display: none;">
           <div class="alert-content">
               <div class="alert-icon">🔋</div>
               <h3>电量不足</h3>
               <p>当前电量低于20%，请及时充电</p>
               <button id="dismiss-battery-alert" class="alert-btn">知道了</button>
           </div>
       </div>

       <!-- 头像框选择模态框 -->
       <div id="avatar-frame-modal" class="modal" style="display: none;">
           <div class="modal-content">
               <div class="modal-header">
                   <h3>选择头像框</h3>
                   <button class="close-btn" id="close-avatar-frame-modal">×</button>
               </div>
               <div class="modal-body">
                   <div class="frame-grid" id="avatar-frame-grid">
                       <!-- 头像框选项将在这里动态生成 -->
                   </div>
               </div>
           </div>
       </div>

       <!-- 音频播放器 -->
        <div id="audio-player" class="audio-player" style="display: none;">
            <div class="audio-info">
                <span id="audio-title">音频标题</span>
                <span id="audio-duration">00:00</span>
            </div>
            <div class="audio-controls">
                <button id="audio-play-pause">⏯️</button>
                <input type="range" id="audio-progress" min="0" max="100" value="0">
            </div>
            <button id="close-audio-player">×</button>
        </div>

        <!-- 发布动态模态框 -->
        <div id="create-post-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>发布动态</h3>
                    <button class="close-btn" id="close-create-post">×</button>
                </div>
                <div class="modal-body">
                    <div class="post-mode-tabs">
                        <button id="text-mode-tab" class="tab-btn active">文字</button>
                        <button id="image-mode-tab" class="tab-btn">图片</button>
                        <button id="text-image-mode-tab" class="tab-btn">图文</button>
                    </div>
                    <div id="text-mode-content" class="post-content active">
                        <textarea id="post-text-input" placeholder="分享新鲜事..."></textarea>
                    </div>
                    <div id="image-mode-content" class="post-content">
                        <div class="image-upload-area">
                            <input type="file" id="post-image-input" accept="image/*" multiple>
                            <div class="upload-placeholder">点击上传图片</div>
                        </div>
                        <div id="image-preview-grid" class="image-grid"></div>
                    </div>
                    <div id="text-image-mode-content" class="post-content">
                        <textarea id="post-text-image-input" placeholder="说点什么..."></textarea>
                        <div class="image-upload-area">
                            <input type="file" id="post-text-image-file" accept="image/*" multiple>
                            <div class="upload-placeholder">添加图片</div>
                        </div>
                        <div id="text-image-preview-grid" class="image-grid"></div>
                    </div>
                    <div class="post-visibility">
                        <label for="post-visibility-select">可见范围：</label>
                        <select id="post-visibility-select">
                            <option value="public">公开</option>
                            <option value="friends">仅好友可见</option>
                            <option value="private">仅自己可见</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="cancel-post-btn" class="cancel-btn">取消</button>
                    <button id="publish-post-btn" class="publish-btn">发布</button>
                </div>
            </div>
        </div>

        <!-- 群组管理模态框 -->
        <div id="group-management-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>群组管理</h3>
                    <button class="close-btn" id="close-group-management">×</button>
                </div>
                <div class="modal-body">
                    <div class="group-list" id="group-management-list">
                        <!-- 群组列表将在这里动态生成 -->
                    </div>
                    <button id="create-new-group-btn" class="create-btn">创建新群组</button>
                </div>
            </div>
        </div>

        <!-- 消息操作模态框 -->
        <div id="message-actions-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>消息操作</h3>
                    <button class="close-btn" id="close-message-actions">×</button>
                </div>
                <div class="modal-body">
                    <div class="action-list">
                        <button id="reply-message-btn" class="action-btn">回复</button>
                        <button id="forward-message-btn" class="action-btn">转发</button>
                        <button id="copy-message-btn" class="action-btn">复制</button>
                        <button id="delete-message-btn" class="action-btn danger">删除</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 动态操作模态框 -->
        <div id="post-actions-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>动态操作</h3>
                    <button class="close-btn" id="close-post-actions">×</button>
                </div>
                <div class="modal-body">
                    <div class="action-list">
                        <button id="edit-post-btn" class="action-btn">编辑</button>
                        <button id="share-post-btn" class="action-btn">分享</button>
                        <button id="delete-post-btn" class="action-btn danger">删除</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 消息编辑器模态框 -->
        <div id="message-editor-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>编辑消息</h3>
                    <button class="close-btn" id="close-message-editor">×</button>
                </div>
                <div class="modal-body">
                    <textarea id="message-editor-input" placeholder="编辑消息内容..."></textarea>
                    <div class="editor-actions">
                        <button id="split-message-btn" class="action-btn">拆分消息</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="cancel-edit-btn" class="cancel-btn">取消</button>
                    <button id="save-edit-btn" class="save-btn">保存</button>
                </div>
            </div>
        </div>

        <!-- 外卖请求模态框 -->
        <div id="waimai-request-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>发起外卖付款</h3>
                    <button class="close-btn" id="close-waimai-request">×</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="waimai-amount">金额</label>
                        <input type="number" id="waimai-amount" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="waimai-description">说明</label>
                        <input type="text" id="waimai-description" placeholder="外卖费用分摊">
                    </div>
                    <div class="form-group">
                        <label for="waimai-deadline">付款截止时间</label>
                        <input type="datetime-local" id="waimai-deadline">
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="cancel-waimai-btn" class="cancel-btn">取消</button>
                    <button id="send-waimai-btn" class="send-btn">发起请求</button>
                </div>
            </div>
        </div>

        <!-- 创建倒计时模态框 -->
        <div id="create-countdown-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>创建倒计时</h3>
                    <button class="close-btn" id="close-create-countdown">×</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="countdown-title">标题</label>
                        <input type="text" id="countdown-title" placeholder="输入倒计时标题">
                    </div>
                    <div class="form-group">
                        <label for="countdown-target-date">目标日期</label>
                        <input type="datetime-local" id="countdown-target-date">
                    </div>
                    <div class="form-group">
                        <label for="countdown-description">描述</label>
                        <textarea id="countdown-description" placeholder="添加描述（可选）"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="cancel-countdown-btn" class="cancel-btn">取消</button>
                    <button id="create-countdown-btn" class="create-btn">创建</button>
                </div>
            </div>
        </div>

        <!-- 红包模态框 -->
        <div id="red-packet-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>发红包</h3>
                    <button class="close-btn" id="close-red-packet">×</button>
                </div>
                <div class="modal-body">
                    <div class="packet-type-tabs">
                        <button id="group-packet-tab" class="tab-btn active">群红包</button>
                        <button id="direct-packet-tab" class="tab-btn">直接红包</button>
                    </div>
                    <div id="group-packet-content" class="packet-content active">
                        <div class="form-group">
                            <label for="group-packet-amount">总金额</label>
                            <input type="number" id="group-packet-amount" placeholder="0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="group-packet-count">红包个数</label>
                            <input type="number" id="group-packet-count" placeholder="1" min="1">
                        </div>
                        <div class="form-group">
                            <label for="group-packet-message">祝福语</label>
                            <input type="text" id="group-packet-message" placeholder="恭喜发财，大吉大利">
                        </div>
                    </div>
                    <div id="direct-packet-content" class="packet-content">
                        <div class="form-group">
                            <label for="direct-packet-amount">金额</label>
                            <input type="number" id="direct-packet-amount" placeholder="0.00" step="0.01">
                        </div>
                        <div class="form-group">
                            <label for="direct-packet-message">祝福语</label>
                            <input type="text" id="direct-packet-message" placeholder="恭喜发财，大吉大利">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="cancel-packet-btn" class="cancel-btn">取消</button>
                    <button id="send-packet-btn" class="send-btn">发红包</button>
                </div>
            </div>
        </div>

        <!-- 红包详情模态框 -->
        <div id="red-packet-detail-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>红包详情</h3>
                    <button class="close-btn" id="close-red-packet-detail">×</button>
                </div>
                <div class="modal-body">
                    <div class="packet-info">
                        <div class="packet-sender">
                            <img id="packet-sender-avatar" src="" alt="发送者头像">
                            <span id="packet-sender-name">发送者</span>
                        </div>
                        <div class="packet-message" id="packet-detail-message">祝福语</div>
                        <div class="packet-amount" id="packet-detail-amount">¥0.00</div>
                    </div>
                    <div class="packet-recipients" id="packet-recipients-list">
                        <!-- 领取记录将在这里显示 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 创建投票模态框 -->
        <div id="create-poll-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>发起投票</h3>
                    <button class="close-btn" id="close-create-poll">×</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="poll-question">投票问题</label>
                        <input type="text" id="poll-question" placeholder="输入投票问题">
                    </div>
                    <div class="form-group">
                        <label>选项</label>
                        <div id="poll-options-container">
                            <div class="poll-option">
                                <input type="text" placeholder="选项1" class="poll-option-input">
                                <button class="remove-option-btn">×</button>
                            </div>
                            <div class="poll-option">
                                <input type="text" placeholder="选项2" class="poll-option-input">
                                <button class="remove-option-btn">×</button>
                            </div>
                        </div>
                        <button id="add-poll-option-btn" class="add-option-btn">添加选项</button>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="poll-multiple-choice"> 允许多选
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="cancel-poll-btn" class="cancel-btn">取消</button>
                    <button id="create-poll-btn" class="create-btn">发起投票</button>
                </div>
            </div>
        </div>

    <!-- JavaScript Code -->
    <script>
        // Database and State Management
        const db = new Dexie('LingkiDB');
        
        // Global state object
        let state = {
            chats: {},
            activeChatId: null,
            globalSettings: {},
            apiConfig: {},
            userStickers: [],
            worldBooks: [],
            personaPresets: [],
            qzoneSettings: {},
            activeAlbumId: null
        };
        
        // Music state
        let musicState = {
            isActive: false,
            activeChatId: null,
            isPlaying: false,
            playlist: [],
            currentIndex: -1,
            playMode: 'order',
            totalElapsedTime: 0,
            timerId: null
        };
        
        // Audio player instance
        let audioPlayer = null;
        
        // Global variables
        let newWallpaperBase64 = null;
        let isSelectionMode = false;
        let selectedMessages = new Set();
        let editingMemberId = null;
        let editingFrameForMember = false;
        let editingWorldBookId = null;
        let editingPersonaPresetId = null;
        let waimaiTimers = {};
        let activeMessageTimestamp = null;
        let currentReplyContext = null;
        let activePostId = null;
        let photoViewerState = { isOpen: false, currentIndex: 0, photos: [] };
        let unreadPostsCount = 0;
        let isFavoritesSelectionMode = false;
        let selectedFavorites = new Set();
        let simulationIntervalId = null;
        let frameModal = null;
        let frameModalOverlay = null;
        let allFavoriteItems = [];
        
        // Default avatars
        const defaultAvatar = 'https://files.catbox.moe/q6z5fc.jpeg';
        const defaultMyGroupAvatar = 'https://files.catbox.moe/q6z5fc.jpeg';
        const defaultGroupMemberAvatar = 'https://files.catbox.moe/q6z5fc.jpeg';
        
        // Default app icons
        const DEFAULT_APP_ICONS = {
            'qzone': 'https://files.catbox.moe/ywqhqp.png',
            'favorites': 'https://files.catbox.moe/ywqhqp.png',
            'memories': 'https://files.catbox.moe/ywqhqp.png',
            'album': 'https://files.catbox.moe/ywqhqp.png'
        };

        // 头像框架数据
        const DEFAULT_FRAMES = [
            { id: 'frame_cat_ear', url: 'https://i.postimg.cc/YSkqDg8V/IMG-7092.gif', name: '猫耳' },
            { id: 'frame_ribbon', url: 'https://i.postimg.cc/FzqHTBng/IMG-7093.gif', name: '蝴蝶结' },
            { id: 'frame_flower', url: 'https://i.postimg.cc/tTpZ6wLs/IMG-7095.gif', name: '花朵' },
            { id: 'frame_tech', url: 'https://i.postimg.cc/8P5vt8sW/IMG-7097.gif', name: '科技' },
            { id: 'frame_5', url: 'https://i.postimg.cc/wMxmCZVC/IMG-7099.gif', name: '5' },
            { id: 'frame_6', url: 'https://i.postimg.cc/2jxd0FGp/IMG-7100.gif', name: '6' },
            { id: 'frame_7', url: 'https://i.postimg.cc/B6T59xGK/IMG-7101.gif', name: '7' },
            { id: 'frame_8', url: 'https://i.postimg.cc/kXfcgFRN/IMG-7106.gif', name: '8' },
            { id: 'frame_9', url: 'https://i.postimg.cc/htZppbS4/IMG-7107.gif', name: '9' },
            { id: 'frame_10', url: 'https://i.postimg.cc/hPgyjtyn/IMG-7108.gif', name: '10' },
            { id: 'frame_11', url: 'https://i.postimg.cc/HLKvs0Kv/IMG-7109.gif', name: '11' },
            { id: 'frame_12', url: 'https://i.postimg.cc/wjwbnYkp/IMG-7111.gif', name: '12' },
            { id: 'frame_13', url: 'https://i.postimg.cc/bJDMQVkj/IMG-7112.gif', name: '13' },
            { id: 'frame_14', url: 'https://i.postimg.cc/SNWBTP5S/IMG-7113.gif', name: '14' }
        ];

        let currentFrameSelection = { ai: null, my: null };
        let currentRenderedCount = 0;
        let lastKnownBatteryLevel = 1;
        let alertFlags = { hasShown40: false, hasShown20: false, hasShown10: false };
        let batteryAlertTimeout;
        let activeCountdownTimers = [];

        // 自定义模态框元素
        const modalOverlay = document.getElementById('custom-modal-overlay');
        const modalTitle = document.getElementById('custom-modal-title');
        const modalBody = document.getElementById('custom-modal-body');
        const modalConfirmBtn = document.getElementById('custom-modal-confirm');
        const modalCancelBtn = document.getElementById('custom-modal-cancel');
        let modalResolve;

        function showCustomModal() { 
            modalOverlay.classList.add('visible'); 
        }

        function hideCustomModal() { 
            modalOverlay.classList.remove('visible'); 
            modalConfirmBtn.classList.remove('btn-danger'); 
            if (modalResolve) modalResolve(null); 
        }

        function showCustomConfirm(title, message, options = {}) {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p>${message}</p>`;
                modalCancelBtn.style.display = 'block';
                modalConfirmBtn.textContent = '确定';
                if (options.confirmButtonClass) modalConfirmBtn.classList.add(options.confirmButtonClass);
                modalConfirmBtn.onclick = () => { resolve(true); hideCustomModal(); };
                modalCancelBtn.onclick = () => { resolve(false); hideCustomModal(); };
                showCustomModal();
            });
        }

        function showCustomAlert(title, message) {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p style="text-align: left; white-space: pre-wrap;">${message}</p>`;
                modalCancelBtn.style.display = 'none';
                modalConfirmBtn.textContent = '好的';
                modalConfirmBtn.onclick = () => {
                    modalCancelBtn.style.display = 'block'; 
                    modalConfirmBtn.textContent = '确定';
                    resolve(true); 
                    hideCustomModal();
                };
                showCustomModal();
            });
        }

        function showCustomPrompt(title, placeholder, initialValue = '', type = 'text', extraHtml = '') {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                const inputId = 'custom-prompt-input';
                
                const inputHtml = type === 'textarea' 
                    ? `<textarea id="${inputId}" placeholder="${placeholder}" rows="4" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; resize: vertical;">${initialValue}</textarea>`
                    : `<input type="${type}" id="${inputId}" placeholder="${placeholder}" value="${initialValue}">`;
                
                modalBody.innerHTML = extraHtml + inputHtml;
                const input = document.getElementById(inputId);

                modalBody.querySelectorAll('.format-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const templateStr = btn.dataset.template;
                        if (templateStr) {
                            try {
                                const templateObj = JSON.parse(templateStr);
                                input.value = JSON.stringify(templateObj, null, 2);
                                input.focus();
                            } catch(e) {
                                console.error("解析格式模板失败:", e);
                            }
                        }
                    });
                });
                
                modalConfirmBtn.onclick = () => { resolve(input.value); hideCustomModal(); };
                modalCancelBtn.onclick = () => { resolve(null); hideCustomModal(); };
                showCustomModal();
                setTimeout(() => input.focus(), 100);
            });
        }

        // ===================================================================
        // 数据库结构定义
        // ===================================================================

        db.version(22).stores({ 
            chats: '&id, isGroup, groupId', 
            apiConfig: '&id', 
            globalSettings: '&id', 
            userStickers: '&id, url, name',
            worldBooks: '&id, name',
            musicLibrary: '&id', 
            personaPresets: '&id',
            qzoneSettings: '&id',
            qzonePosts: '++id, timestamp', 
            qzoneAlbums: '++id, name, createdAt',
            qzonePhotos: '++id, albumId',
            favorites: '++id, type, timestamp, originalTimestamp',
            qzoneGroups: '++id, name',
            memories: '++id, chatId, timestamp, type, targetDate',
            callRecords: '++id, chatId, timestamp, customName'
        });

        // ===================================================================
        // 核心功能函数定义
        // ===================================================================

        function showScreen(screenId) {
            if (screenId === 'chat-list-screen') {
                window.renderChatListProxy(); 
                switchToChatListView('messages-view');
            }
            if (screenId === 'api-settings-screen') window.renderApiSettingsProxy();
            if (screenId === 'wallpaper-screen') window.renderWallpaperScreenProxy();
            if (screenId === 'world-book-screen') window.renderWorldBookScreenProxy();
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const screenToShow = document.getElementById(screenId);
            if (screenToShow) screenToShow.classList.add('active');
            if (screenId === 'chat-interface-screen') window.updateListenTogetherIconProxy(state.activeChatId);
            if (screenId === 'font-settings-screen') {
                document.getElementById('font-url-input').value = state.globalSettings.fontUrl || '';
                applyCustomFont(state.globalSettings.fontUrl || '', true);
            }
        }
        window.updateListenTogetherIconProxy = () => {};

        function switchToChatListView(viewId) {
            const chatListScreen = document.getElementById('chat-list-screen');
            const views = {
                'messages-view': document.getElementById('messages-view'),
                'qzone-screen': document.getElementById('qzone-screen'),
                'favorites-view': document.getElementById('favorites-view'),
                'memories-view': document.getElementById('memories-view')
            };
            const mainHeader = document.getElementById('main-chat-list-header');
            const mainBottomNav = document.getElementById('chat-list-bottom-nav');

            if (isFavoritesSelectionMode) {
                document.getElementById('favorites-edit-btn').click(); 
            }

            Object.values(views).forEach(v => v.classList.remove('active'));
            if (views[viewId]) {
                views[viewId].classList.add('active');
            }

            document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.view === viewId);
            });
            
            if (viewId === 'messages-view') {
                mainHeader.style.display = 'flex';
                mainBottomNav.style.display = 'flex';
            } else {
                mainHeader.style.display = 'none';
                mainBottomNav.style.display = 'none';
            }

            if (viewId !== 'memories-view') {
                activeCountdownTimers.forEach(timerId => clearInterval(timerId));
                activeCountdownTimers = [];
            }

            switch (viewId) {
                case 'qzone-screen':
                    views['qzone-screen'].style.backgroundColor = '#f0f2f5';
                    updateUnreadIndicator(0);
                    renderQzoneScreen();
                    renderQzonePosts();
                    break;
                case 'favorites-view':
                    views['favorites-view'].style.backgroundColor = '#f9f9f9';
                    renderFavoritesScreen();
                    break;
                case 'messages-view':
                    loadChatListBackground();
                    break;
            }
        }
        
        function renderQzoneScreen() {
            if (state && state.qzoneSettings) {
                const settings = state.qzoneSettings;
                document.getElementById('qzone-nickname').textContent = settings.nickname;
                document.getElementById('qzone-avatar-img').src = settings.avatar;
                document.getElementById('qzone-banner-img').src = settings.banner;
            }
        }
        window.renderQzoneScreenProxy = renderQzoneScreen;

        async function saveQzoneSettings() {
            if (db && state.qzoneSettings) {
                await db.qzoneSettings.put(state.qzoneSettings);
            }
        }

        // ===================================================================
        // 聊天列表背景壁纸功能
        // ===================================================================
        
        function setChatListBackground(imageUrl, opacity = 1) {
            const bgLayer = document.getElementById('chat-list-bg-layer');
            if (bgLayer) {
                if (imageUrl) {
                    bgLayer.style.backgroundImage = `url('${imageUrl}')`;
                    bgLayer.style.opacity = opacity;
                } else {
                    bgLayer.style.backgroundImage = '';
                    bgLayer.style.opacity = 1;
                }
            }
        }
        
        function loadChatListBackground() {
            if (state.globalSettings && state.globalSettings.chatListBackground) {
                const opacity = (state.globalSettings.chatListBackgroundOpacity || 100) / 100;
                setChatListBackground(state.globalSettings.chatListBackground, opacity);
                
                if (state.globalSettings.applyToChatBackground && state.activeChatId) {
                    applyChatListBackgroundToChat();
                }
            }
        }
        
        async function saveChatListBackground(imageUrl, opacity = 100, applyToChat = false) {
            if (!state.globalSettings) {
                state.globalSettings = {};
            }
            state.globalSettings.chatListBackground = imageUrl;
            state.globalSettings.chatListBackgroundOpacity = opacity;
            state.globalSettings.applyToChatBackground = applyToChat;
            
            if (db && db.globalSettings) {
                await db.globalSettings.put({ id: 'main', ...state.globalSettings });
            }
            
            const opacityValue = opacity / 100;
            setChatListBackground(imageUrl, opacityValue);
            
            if (applyToChat && state.activeChatId) {
                applyChatListBackgroundToChat();
            }
        }
        
        async function resetChatListBackground() {
            await saveChatListBackground('', 100, false);
            if (state.activeChatId) {
                const chat = state.chats[state.activeChatId];
                if (chat) {
                    const chatScreen = document.getElementById('chat-interface-screen');
                    if (chatScreen) {
                        chatScreen.style.backgroundImage = chat.settings.background ? `url(${chat.settings.background})` : 'none';
                    }
                }
            }
        }
        
        function applyChatListBackgroundToChat() {
            if (!state.globalSettings?.chatListBackground || !state.activeChatId) return;
            
            const chatScreen = document.getElementById('chat-interface-screen');
            if (chatScreen) {
                const opacity = (state.globalSettings.chatListBackgroundOpacity || 100) / 100;
                chatScreen.style.backgroundImage = `url('${state.globalSettings.chatListBackground}')`;
                chatScreen.style.backgroundSize = 'cover';
                chatScreen.style.backgroundPosition = 'center';
                chatScreen.style.backgroundRepeat = 'no-repeat';
                
                if (opacity < 1) {
                    chatScreen.style.position = 'relative';
                    chatScreen.style.setProperty('--bg-opacity', opacity);
                }
            }
        }
        
        function renderChatListBgScreen() {
            const preview = document.getElementById('chat-list-bg-preview');
            const opacitySlider = document.getElementById('chat-list-bg-opacity-slider');
            const opacityDisplay = document.getElementById('opacity-value-display');
            const applyToChatToggle = document.getElementById('apply-to-chat-bg-toggle');
            
            const currentBg = state.globalSettings?.chatListBackground;
            const currentOpacity = state.globalSettings?.chatListBackgroundOpacity || 100;
            const applyToChat = state.globalSettings?.applyToChatBackground || false;
            
            if (currentBg) {
                preview.style.backgroundImage = `url('${currentBg}')`;
                preview.style.opacity = currentOpacity / 100;
                preview.textContent = '';
            } else {
                preview.style.backgroundImage = '';
                preview.style.opacity = 1;
                preview.textContent = '点击下方上传背景图片';
            }
            
            opacitySlider.value = currentOpacity;
            opacityDisplay.textContent = currentOpacity + '%';
            applyToChatToggle.checked = applyToChat;
        }

        function formatPostTimestamp(timestamp) {
            if (!timestamp) return '';
            const now = new Date();
            const date = new Date(timestamp);
            const diffSeconds = Math.floor((now - date) / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            const diffHours = Math.floor(diffMinutes / 60);
            if (diffMinutes < 1) return '刚刚';
            if (diffMinutes < 60) return `${diffMinutes}分钟前`;
            if (diffHours < 24) return `${diffHours}小时前`;
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            if (now.getFullYear() === year) {
                return `${month}-${day} ${hours}:${minutes}`;
            } else {
                return `${year}-${month}-${day} ${hours}:${minutes}`;
            }
        }

        async function renderQzonePosts() {
            const postsListEl = document.getElementById('qzone-posts-list');
            if (!postsListEl) return;

            const [posts, favorites] = await Promise.all([
                db.qzonePosts.orderBy('timestamp').reverse().toArray(),
                db.favorites.where('type').equals('qzone_post').toArray()
            ]);

            const favoritedPostIds = new Set(favorites.map(fav => fav.content.id));
            
            postsListEl.innerHTML = '';

            if (posts.length === 0) {
                postsListEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 30px 0;">这里空空如也，快来发布第一条说说吧！</p>';
                return;
            }

            const userSettings = state.qzoneSettings;

            posts.forEach(post => {
                const postContainer = document.createElement('div');
                postContainer.className = 'qzone-post-container';
                postContainer.dataset.postId = post.id;

                const postEl = document.createElement('div');
                postEl.className = 'qzone-post-item';

                let authorAvatar = '', authorNickname = '', commentAvatar = userSettings.avatar; 

                if (post.authorId === 'user') {
                    authorAvatar = userSettings.avatar;
                    authorNickname = userSettings.nickname;
                } else if (state.chats[post.authorId]) {
                    const authorChat = state.chats[post.authorId];
                    authorAvatar = authorChat.settings.aiAvatar || defaultAvatar;
                    authorNickname = authorChat.name;
                } else {
                    authorAvatar = defaultAvatar;
                    authorNickname = '{{char}}';
                }
                
                let contentHtml = '';
                const publicTextHtml = post.publicText ? `<div class="post-content">${post.publicText.replace(/\n/g, '<br>')}</div>` : '';

                if (post.type === 'shuoshuo') {
                    contentHtml = `<div class="post-content" style="margin-bottom: 10px;">${post.content.replace(/\n/g, '<br>')}</div>`;
                } 
                else if (post.type === 'image_post' && post.imageUrl) {
                    contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${post.imageUrl}" class="chat-image"></div>` : `<img src="${post.imageUrl}" class="chat-image">`;
                } 
                else if (post.type === 'text_image') {
                    contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>` : `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`;
                }

                let likesHtml = '';
                if (post.likes && post.likes.length > 0) {
                    likesHtml = `<div class="post-likes-section"><svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>${post.likes.join('、')} 觉得很赞</span></div>`;
                }
                
                let commentsHtml = '';
                if (post.comments && post.comments.length > 0) {
                    commentsHtml = '<div class="post-comments-container">';
                    post.comments.forEach((comment, index) => {
                        commentsHtml += `
                            <div class="comment-item">
                                <span class="commenter-name">${comment.commenterName}:</span>
                                <span class="comment-text">${comment.text}</span>
                                <span class="comment-delete-btn" data-comment-index="${index}">×</span>
                            </div>`;
                    });
                    commentsHtml += '</div>';
                }

                const userNickname = state.qzoneSettings.nickname;
                const isLikedByUser = post.likes && post.likes.includes(userNickname);
                const isFavoritedByUser = favoritedPostIds.has(post.id);

                postEl.innerHTML = `
                    <div class="post-header"><img src="${authorAvatar}" class="post-avatar"><div class="post-info"><span class="post-nickname">${authorNickname}</span><span class="post-timestamp">${formatPostTimestamp(post.timestamp)}</span></div>
                        <div class="post-actions-btn">…</div>
                    </div>
                    <div class="post-main-content">${contentHtml}</div>
                    <div class="post-feedback-icons">
                        <span class="action-icon like ${isLikedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></span>
                        <span class="action-icon favorite ${isFavoritedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg></span>
                    </div>
                    ${likesHtml}
                    ${commentsHtml}
                    <div class="post-footer"><div class="comment-section"><img src="${commentAvatar}" class="comment-avatar"><input type="text" class="comment-input" placeholder="友善的评论是交流的起点"><div class="at-mention-popup"></div></div><button class="comment-send-btn">发送</button></div>
                `;
                
                const deleteAction = document.createElement('div');
                deleteAction.className = 'qzone-post-delete-action';
                deleteAction.innerHTML = '<span>删除</span>';
                postContainer.appendChild(postEl);
                postContainer.appendChild(deleteAction);
                const commentSection = postContainer.querySelector('.comment-section');
                if (commentSection) {
                    commentSection.addEventListener('touchstart', (e) => e.stopPropagation());
                    commentSection.addEventListener('mousedown', (e) => e.stopPropagation());
                }
                postsListEl.appendChild(postContainer);
                const commentInput = postContainer.querySelector('.comment-input');
                const popup = postContainer.querySelector('.at-mention-popup');
                commentInput.addEventListener('input', () => {
                    const value = commentInput.value;
                    const atMatch = value.match(/@([\p{L}\w]*)$/u);
                    if (atMatch) {
                        const namesToMention = new Set();
                        const authorNickname = postContainer.querySelector('.post-nickname')?.textContent;
                        if (authorNickname) namesToMention.add(authorNickname);
                        postContainer.querySelectorAll('.commenter-name').forEach(nameEl => {
                            namesToMention.add(nameEl.textContent.replace(':', ''));
                        });
                        namesToMention.delete(state.qzoneSettings.nickname);
                        popup.innerHTML = '';
                        if (namesToMention.size > 0) {
                            const searchTerm = atMatch[1];
                            namesToMention.forEach(name => {
                                if (name.toLowerCase().includes(searchTerm.toLowerCase())) {
                                    const item = document.createElement('div');
                                    item.className = 'at-mention-item';
                                    item.textContent = name;
                                    item.addEventListener('mousedown', (e) => {
                                        e.preventDefault();
                                        const newText = value.substring(0, atMatch.index) + `@${name} `;
                                        commentInput.value = newText;
                                        popup.style.display = 'none';
                                        commentInput.focus();
                                    });
                                    popup.appendChild(item);
                                }
                            });
                            popup.style.display = popup.children.length > 0 ? 'block' : 'none';
                        } else {
                            popup.style.display = 'none';
                        }
                    } else {
                        popup.style.display = 'none';
                    }
                });
                commentInput.addEventListener('blur', () => { setTimeout(() => { popup.style.display = 'none'; }, 200); });
            });
        }
             
        function displayFilteredFavorites(items) {
            const listEl = document.getElementById('favorites-list');
            listEl.innerHTML = '';

            if (items.length === 0) {
                const searchTerm = document.getElementById('favorites-search-input').value;
                const message = searchTerm ? '未找到相关收藏' : '你的收藏夹是空的，<br>快去动态或聊天中收藏喜欢的内容吧！';
                listEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">${message}</p>`;
                return;
            }

            for (const item of items) {
                const card = document.createElement('div');
                card.className = 'favorite-item-card';
                card.dataset.favid = item.id;

                let headerHtml = '', contentHtml = '', sourceText = '', footerHtml = '';

                if (item.type === 'qzone_post') {
                    const post = item.content;
                    sourceText = '来自动态';
                    let authorAvatar = defaultAvatar, authorNickname = '未知用户';

                    if (post.authorId === 'user') {
                        authorAvatar = state.qzoneSettings.avatar;
                        authorNickname = state.qzoneSettings.nickname;
                    } else if (state.chats[post.authorId]) {
                        authorAvatar = state.chats[post.authorId].settings.aiAvatar;
                        authorNickname = state.chats[post.authorId].name;
                    }

                    headerHtml = `<img src="${authorAvatar}" class="avatar"><div class="info"><div class="name">${authorNickname}</div></div>`;
                    
                    const publicTextHtml = post.publicText ? `<div class="post-content">${post.publicText.replace(/\n/g, '<br>')}</div>` : '';
                    if (post.type === 'shuoshuo') {
                        contentHtml = `<div class="post-content">${post.content.replace(/\n/g, '<br>')}</div>`;
                    } else if (post.type === 'image_post' && post.imageUrl) {
                        contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${post.imageUrl}" class="chat-image"></div>` : `<img src="${post.imageUrl}" class="chat-image">`;
                    } else if (post.type === 'text_image') {
                        contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>` : `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`;
                    }

                    let likesHtml = '';
                    if (post.likes && post.likes.length > 0) {
                        likesHtml = `
                            <div class="post-likes-section">
                                <svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                                <span>${post.likes.join('、')} 觉得很赞</span>
                            </div>`;
                    }

                    let commentsHtml = '';
                    if (post.comments && post.comments.length > 0) {
                        commentsHtml = '<div class="post-comments-container">';
                        post.comments.forEach(comment => {
                            commentsHtml += `
                                <div class="comment-item">
                                    <span class="commenter-name">${comment.commenterName}:</span>
                                    <span class="comment-text">${comment.text}</span>
                                </div>`;
                        });
                        commentsHtml += '</div>';
                    }

                    footerHtml = `${likesHtml}${commentsHtml}`;

                } else if (item.type === 'chat_message') {
                    const msg = item.content;
                    const chat = state.chats[item.chatId];
                    if (!chat) continue; 

                    sourceText = `来自与 ${chat.name} 的聊天`;
                    const isUser = msg.role === 'user';
                    let senderName, senderAvatar;

                    if (isUser) {
                        senderName = chat.isGroup ? (chat.settings.myNickname || '我') : '我';
                        senderAvatar = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
                    } else {
                         if (chat.isGroup) {
                            const member = chat.members.find(m => m.originalName === msg.senderName);
                            senderName = msg.senderName;
                            senderAvatar = member ? member.avatar : defaultGroupMemberAvatar;
                        } else {
                            senderName = chat.name;
                            senderAvatar = chat.settings.aiAvatar || defaultAvatar;
                        }
                    }

                    headerHtml = `<img src="${senderAvatar}" class="avatar"><div class="info"><div class="name">${senderName}</div></div>`;
                    
                    if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
                        contentHtml = `<img src="${msg.content}" class="sticker-image" style="max-width: 80px; max-height: 80px;">`;
                    } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
                        contentHtml = `<img src="${msg.content[0].image_url.url}" class="chat-image">`;
                    } else {
                        contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
                    }
                }
                
                card.innerHTML = `
                    <div class="fav-card-header">${headerHtml}<div class="source">${sourceText}</div></div>
                    <div class="fav-card-content">${contentHtml}</div>
                    ${footerHtml}`;
                    
                listEl.appendChild(card);
            }
        }

        async function renderFavoritesScreen() {
            allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray();
            
            const searchInput = document.getElementById('favorites-search-input');
            const clearBtn = document.getElementById('favorites-search-clear-btn');
            searchInput.value = '';
            clearBtn.style.display = 'none';

            displayFilteredFavorites(allFavoriteItems);
        }

        function resetCreatePostModal() {
            document.getElementById('post-public-text').value = '';
            document.getElementById('post-image-preview').src = '';
            document.getElementById('post-image-description').value = '';
            document.getElementById('post-image-preview-container').classList.remove('visible');
            document.getElementById('post-image-desc-group').style.display = 'none';
            document.getElementById('post-local-image-input').value = '';
            document.getElementById('post-hidden-text').value = '';
            document.getElementById('switch-to-image-mode').click();
        }

        async function exportBackup() {
            try {
                const backupData = {
                    version: 1, 
                    timestamp: Date.now()
                };

                const [
                    chats, worldBooks, userStickers, apiConfig, globalSettings,
                    personaPresets, musicLibrary, qzoneSettings, qzonePosts,
                    qzoneAlbums, qzonePhotos, favorites, qzoneGroups,
                    memories
                ] = await Promise.all([
                    db.chats.toArray(),
                    db.worldBooks.toArray(),
                    db.userStickers.toArray(),
                    db.apiConfig.get('main'),
                    db.globalSettings.get('main'),
                    db.personaPresets.toArray(),
                    db.musicLibrary.get('main'),
                    db.qzoneSettings.get('main'),
                    db.qzonePosts.toArray(),
                    db.qzoneAlbums.toArray(),
                    db.qzonePhotos.toArray(),
                    db.favorites.toArray(),
                    db.qzoneGroups.toArray(),
                    db.memories.toArray()
                ]);

                Object.assign(backupData, {
                    chats, worldBooks, userStickers, apiConfig, globalSettings,
                    personaPresets, musicLibrary, qzoneSettings, qzonePosts,
                    qzoneAlbums, qzonePhotos, favorites, qzoneGroups,
                    memories
                });
                
                const blob = new Blob(
                    [JSON.stringify(backupData, null, 2)], 
                    { type: 'application/json' }
                );
                const url = URL.createObjectURL(blob);
                const link = Object.assign(document.createElement('a'), {
                    href: url,
                    download: `lingki-Full-Backup-${new Date().toISOString().split('T')[0]}.json`
                });
                link.click();
                URL.revokeObjectURL(url);
                
                await showCustomAlert('导出成功', '已成功导出所有数据！');

            } catch (error) {
                console.error("导出数据时出错:", error);
                await showCustomAlert('导出失败', `发生了一个错误: ${error.message}`);
            }
        }

        async function importBackup(file) {
            if (!file) return;

            const confirmed = await showCustomConfirm(
                '严重警告！',
                '导入备份将会覆盖当前所有数据，此操作不可撤销！\n\n确定要继续吗？',
                { confirmButtonClass: 'btn-danger' }
            );
            
            if (!confirmed) return;

            try {
                const text = await file.text();
                const backupData = JSON.parse(text);
                
                if (!backupData.version) {
                    throw new Error('无效的备份文件格式');
                }

                await db.transaction('rw', [
                    db.chats, db.worldBooks, db.userStickers, db.apiConfig, 
                    db.globalSettings, db.personaPresets, db.musicLibrary,
                    db.qzoneSettings, db.qzonePosts, db.qzoneAlbums, 
                    db.qzonePhotos, db.favorites, db.qzoneGroups, db.memories
                ], async () => {
                    await Promise.all([
                        db.chats.clear(),
                        db.worldBooks.clear(),
                        db.userStickers.clear(),
                        db.apiConfig.clear(),
                        db.globalSettings.clear(),
                        db.personaPresets.clear(),
                        db.musicLibrary.clear(),
                        db.qzoneSettings.clear(),
                        db.qzonePosts.clear(),
                        db.qzoneAlbums.clear(),
                        db.qzonePhotos.clear(),
                        db.favorites.clear(),
                        db.qzoneGroups.clear(),
                        db.memories.clear()
                    ]);

                    if (backupData.chats) await db.chats.bulkAdd(backupData.chats);
                    if (backupData.worldBooks) await db.worldBooks.bulkAdd(backupData.worldBooks);
                    if (backupData.userStickers) await db.userStickers.bulkAdd(backupData.userStickers);
                    if (backupData.apiConfig) await db.apiConfig.put(backupData.apiConfig);
                    if (backupData.globalSettings) await db.globalSettings.put(backupData.globalSettings);
                    if (backupData.personaPresets) await db.personaPresets.bulkAdd(backupData.personaPresets);
                    if (backupData.musicLibrary) await db.musicLibrary.put(backupData.musicLibrary);
                    if (backupData.qzoneSettings) await db.qzoneSettings.put(backupData.qzoneSettings);
                    if (backupData.qzonePosts) await db.qzonePosts.bulkAdd(backupData.qzonePosts);
                    if (backupData.qzoneAlbums) await db.qzoneAlbums.bulkAdd(backupData.qzoneAlbums);
                    if (backupData.qzonePhotos) await db.qzonePhotos.bulkAdd(backupData.qzonePhotos);
                    if (backupData.favorites) await db.favorites.bulkAdd(backupData.favorites);
                    if (backupData.qzoneGroups) await db.qzoneGroups.bulkAdd(backupData.qzoneGroups);
                    if (backupData.memories) await db.memories.bulkAdd(backupData.memories);
                });

                await showCustomAlert('导入成功', '备份数据已成功导入！页面将刷新以应用更改。');
                location.reload();

            } catch (error) {
                console.error('导入备份时出错:', error);
                await showCustomAlert('导入失败', `发生了一个错误: ${error.message}`);
            }
        }
        // Avatar frames array
        const avatarFrames = DEFAULT_FRAMES;
        
        // Constants
        const STICKER_REGEX = /^https:\/\/files\.catbox\.moe\/[a-zA-Z0-9]+\.(gif|png|jpg|jpeg|webp)$/;
        const MESSAGE_RENDER_WINDOW = 50;
        
        // Dynamic font style
        const dynamicFontStyle = document.createElement('style');
        document.head.appendChild(dynamicFontStyle);

        // ===================================================================
        // 继续重写剩余功能函数
        // ===================================================================

        // 收藏夹显示函数 - 完整版本
         function displayFilteredFavorites(items) {
             const listEl = document.getElementById('favorites-list');
             if (!listEl) return;
             
             listEl.innerHTML = '';
             
             if (items.length === 0) {
                 const searchTerm = document.getElementById('favorites-search-input')?.value || '';
                 const message = searchTerm ? '未找到相关收藏' : '你的收藏夹是空的，<br>快去动态或聊天中收藏喜欢的内容吧！';
                 listEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">${message}</p>`;
                 return;
             }
             
             for (const item of items) {
                 const card = document.createElement('div');
                 card.className = 'favorite-item-card';
                 card.dataset.favid = item.id;
                 
                 let headerHtml = '', contentHtml = '', sourceText = '', footerHtml = '';
                 
                 if (item.type === 'qzone_post') {
                     const post = item.content;
                     sourceText = '来自动态';
                     let authorAvatar = defaultAvatar, authorNickname = '未知用户';
                     
                     if (post.authorId === 'user') {
                         authorAvatar = state.qzoneSettings.avatar;
                         authorNickname = state.qzoneSettings.nickname;
                     } else if (state.chats[post.authorId]) {
                         authorAvatar = state.chats[post.authorId].settings.aiAvatar;
                         authorNickname = state.chats[post.authorId].name;
                     }
                     
                     headerHtml = `<img src="${authorAvatar}" class="avatar"><div class="info"><div class="name">${authorNickname}</div></div>`;
                     
                     const publicTextHtml = post.publicText ? `<div class="post-content">${post.publicText.replace(/\n/g, '<br>')}</div>` : '';
                     if (post.type === 'shuoshuo') {
                         contentHtml = `<div class="post-content">${post.content.replace(/\n/g, '<br>')}</div>`;
                     } else if (post.type === 'image_post' && post.imageUrl) {
                         contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${post.imageUrl}" class="chat-image"></div>` : `<img src="${post.imageUrl}" class="chat-image">`;
                     } else if (post.type === 'text_image') {
                         contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}"></div>` : `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="chat-image" style="cursor: pointer;" data-hidden-text="${post.hiddenContent}">`;
                     }
                     
                     // 收藏夹中的点赞和评论
                     let likesHtml = '';
                     if (post.likes && post.likes.length > 0) {
                         likesHtml = `
                             <div class="post-likes-section">
                                 <svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                                 <span>${post.likes.join('、')} 觉得很赞</span>
                             </div>`;
                     }
                     
         // 数据导出功能
         async function exportBackup() {
             try {
                 const data = {
                     chats: await db.chats.toArray(),
                     worldBooks: await db.worldBooks.toArray(),
                     userStickers: await db.userStickers.toArray(),
                     apiConfig: await db.apiConfig.toArray(),
                     globalSettings: await db.globalSettings.toArray(),
                     personaPresets: await db.personaPresets.toArray(),
                     musicLibrary: await db.musicLibrary.toArray(),
                     qzoneSettings: await db.qzoneSettings.toArray(),
                     qzonePosts: await db.qzonePosts.toArray(),
                     qzoneAlbums: await db.qzoneAlbums.toArray(),
                     qzonePhotos: await db.qzonePhotos.toArray(),
                     favorites: await db.favorites.toArray(),
                     qzoneGroups: await db.qzoneGroups.toArray(),
                     memories: await db.memories.toArray(),
                     callRecords: await db.callRecords.toArray()
                 };
                 
                 const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                 const url = URL.createObjectURL(blob);
                 const a = document.createElement('a');
                 a.href = url;
                 a.download = `lingki_backup_${new Date().toISOString().slice(0, 10)}.json`;
                 document.body.appendChild(a);
                 a.click();
                 document.body.removeChild(a);
                 URL.revokeObjectURL(url);
                 
                 showCustomAlert('数据导出成功！');
             } catch (error) {
                 console.error('导出失败:', error);
                 showCustomAlert('导出失败，请重试。');
             }
         }
         
         // 数据导入功能
         async function importBackup(file) {
             try {
                 const text = await file.text();
                 const data = JSON.parse(text);
                 
                 const confirmed = await showCustomConfirm(
                     '导入数据将覆盖当前所有数据，此操作不可撤销。确定要继续吗？',
                     '警告'
                 );
                 
                 if (!confirmed) return;
                 
                 // 清空所有表
                 await db.chats.clear();
                 await db.worldBooks.clear();
                 await db.userStickers.clear();
                 await db.apiConfig.clear();
                 await db.globalSettings.clear();
                 await db.personaPresets.clear();
                 await db.musicLibrary.clear();
                 await db.qzoneSettings.clear();
                 await db.qzonePosts.clear();
                 await db.qzoneAlbums.clear();
                 await db.qzonePhotos.clear();
                 await db.favorites.clear();
                 await db.qzoneGroups.clear();
                 await db.memories.clear();
                 await db.callRecords.clear();
                 
                 // 导入数据
                 if (data.chats) await db.chats.bulkAdd(data.chats);
                 if (data.worldBooks) await db.worldBooks.bulkAdd(data.worldBooks);
                 if (data.userStickers) await db.userStickers.bulkAdd(data.userStickers);
                 if (data.apiConfig) await db.apiConfig.bulkAdd(data.apiConfig);
                 if (data.globalSettings) await db.globalSettings.bulkAdd(data.globalSettings);
                 if (data.personaPresets) await db.personaPresets.bulkAdd(data.personaPresets);
                 if (data.musicLibrary) await db.musicLibrary.bulkAdd(data.musicLibrary);
                 if (data.qzoneSettings) await db.qzoneSettings.bulkAdd(data.qzoneSettings);
                 if (data.qzonePosts) await db.qzonePosts.bulkAdd(data.qzonePosts);
                 if (data.qzoneAlbums) await db.qzoneAlbums.bulkAdd(data.qzoneAlbums);
                 if (data.qzonePhotos) await db.qzonePhotos.bulkAdd(data.qzonePhotos);
                 if (data.favorites) await db.favorites.bulkAdd(data.favorites);
                 if (data.qzoneGroups) await db.qzoneGroups.bulkAdd(data.qzoneGroups);
                 if (data.memories) await db.memories.bulkAdd(data.memories);
                 if (data.callRecords) await db.callRecords.bulkAdd(data.callRecords);
                 
                 showCustomAlert('数据导入成功！页面将刷新以应用更改。');
                 setTimeout(() => location.reload(), 1500);
                 
             } catch (error) {
                 console.error('导入失败:', error);
                 showCustomAlert('导入失败，请检查文件格式。');
             }
         }
         
         // 重置所有数据
         async function resetAllData() {
             const confirmed = await showCustomConfirm(
                 '这将删除所有聊天记录、设置和数据。此操作不可撤销！确定要继续吗？',
                 '严重警告'
             );
             
             if (!confirmed) return;
             
             const doubleConfirmed = await showCustomConfirm(
                 '最后确认：真的要删除所有数据吗？',
                 '最终确认'
             );
             
             if (!doubleConfirmed) return;
             
             try {
                 // 清空 IndexedDB
                 await db.delete();
                 
                 // 清空 localStorage
                 localStorage.clear();
                 
                 // 重置全局状态
                 state.chats = {};
                 state.apiConfig = { proxyUrl: '', apiKey: '' };
                 state.globalSettings = { appIcons: DEFAULT_APP_ICONS };
                 
                 showCustomAlert('所有数据已重置。页面将刷新。');
                 setTimeout(() => location.reload(), 1500);
                 
             } catch (error) {
                 console.error('重置失败:', error);
                 showCustomAlert('重置失败，请重试。');
             }
         }
         
         // 自定义字体应用
         async function applyCustomFont(fontUrl, isPreview = false) {
             if (!fontUrl) {
                 // 重置为默认字体
                 if (dynamicFontStyle) {
                     dynamicFontStyle.textContent = '';
                 }
                 if (!isPreview) {
                     await db.globalSettings.put({ key: 'customFontUrl', value: '' });
                 }
                 return;
             }
             
             const fontFamily = 'CustomFont';
             const css = `
                 @import url('${fontUrl}');
                 * {
                     font-family: '${fontFamily}', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                 }
             `;
             
             if (!dynamicFontStyle) {
                 dynamicFontStyle = document.createElement('style');
                 document.head.appendChild(dynamicFontStyle);
             }
             
             dynamicFontStyle.textContent = css;
             
             if (!isPreview) {
                 await db.globalSettings.put({ key: 'customFontUrl', value: fontUrl });
             }
         }
         
         // 重置为默认字体
         async function resetToDefaultFont() {
             if (dynamicFontStyle) {
                 dynamicFontStyle.textContent = '';
             }
             await db.globalSettings.put({ key: 'customFontUrl', value: '' });
             
             const fontUrlInput = document.getElementById('custom-font-url');
             if (fontUrlInput) fontUrlInput.value = '';
         }
                     if (post.comments && post.comments.length > 0) {
                         commentsHtml = '<div class="post-comments-container">';
                         post.comments.forEach(comment => {
                             commentsHtml += `
                                 <div class="comment-item">
                                     <span class="commenter-name">${comment.commenterName}:</span>
                                     <span class="comment-text">${comment.text}</span>
                                 </div>`;
                         });
                         commentsHtml += '</div>';
                     }
                     
                     footerHtml = `${likesHtml}${commentsHtml}`;
                     
                 } else if (item.type === 'chat_message') {
                     const msg = item.content;
                     const chat = state.chats[item.chatId];
                     if (!chat) continue;
                     
                     sourceText = `来自与 ${chat.name} 的聊天`;
                     const isUser = msg.role === 'user';
                     let senderName, senderAvatar;
                     
                     if (isUser) {
                         senderName = chat.isGroup ? (chat.settings.myNickname || '我') : '我';
                         senderAvatar = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
                     } else {
                         if (chat.isGroup) {
                             const member = chat.members.find(m => m.originalName === msg.senderName);
                             senderName = msg.senderName;
                             senderAvatar = member ? member.avatar : defaultGroupMemberAvatar;
                         } else {
                             senderName = chat.name;
                             senderAvatar = chat.settings.aiAvatar || defaultAvatar;
                         }
                     }
                     
                     headerHtml = `<img src="${senderAvatar}" class="avatar"><div class="info"><div class="name">${senderName}</div></div>`;
                     
                     if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
                         contentHtml = `<img src="${msg.content}" class="sticker-image" style="max-width: 80px; max-height: 80px;">`;
                     } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
                         contentHtml = `<img src="${msg.content[0].image_url.url}" class="chat-image">`;
                     } else {
                         contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
                     }
                 }
                 
                 card.innerHTML = `
                     <div class="fav-card-header">${headerHtml}<div class="source">${sourceText}</div></div>
                     <div class="fav-card-content">${contentHtml}</div>
                     ${footerHtml}
                 `;
                 
                 listEl.appendChild(card);
             }
         }
         
         // 收藏夹屏幕渲染
         async function renderFavoritesScreen() {
             allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray();
             
             const searchInput = document.getElementById('favorites-search-input');
             const clearBtn = document.getElementById('favorites-search-clear-btn');
             
             if (searchInput) searchInput.value = '';
             if (clearBtn) clearBtn.style.display = 'none';
             
             displayFilteredFavorites(allFavoriteItems);
         }
         
         // 创建动态模态框重置
         function resetCreatePostModal() {
             const publicText = document.getElementById('post-public-text');
             const imagePreview = document.getElementById('post-image-preview');
             const imageDescription = document.getElementById('post-image-description');
             const previewContainer = document.getElementById('post-image-preview-container');
             const descGroup = document.getElementById('post-image-desc-group');
             const localImageInput = document.getElementById('post-local-image-input');
             const hiddenText = document.getElementById('post-hidden-text');
             const switchBtn = document.getElementById('switch-to-image-mode');
             
             if (publicText) publicText.value = '';
             if (imagePreview) imagePreview.src = '';
             if (imageDescription) imageDescription.value = '';
             if (previewContainer) previewContainer.classList.remove('visible');
             if (descGroup) descGroup.style.display = 'none';
             if (localImageInput) localImageInput.value = '';
             if (hiddenText) hiddenText.value = '';
             if (switchBtn) switchBtn.click();
         }
                    
         // 从数据库加载所有数据
         async function loadAllDataFromDB() {
             try {
                 // 加载聊天数据
                 const chats = await db.chats.toArray();
                 state.chats = {};
                 chats.forEach(chat => {
                     state.chats[chat.id] = chat;
                     
                     // 数据迁移：为群聊添加 isGroup 标识
                     if (!chat.hasOwnProperty('isGroup')) {
                         chat.isGroup = chat.members && chat.members.length > 0;
                     }
                     
                     // 为单聊添加状态和关系字段
                     if (!chat.isGroup) {
                         if (!chat.settings) chat.settings = {};
                         if (!chat.settings.hasOwnProperty('status')) chat.settings.status = 'online';
                         if (!chat.settings.hasOwnProperty('relationship')) chat.settings.relationship = 'friend';
                         if (!chat.settings.hasOwnProperty('aiAvatarLibrary')) chat.settings.aiAvatarLibrary = [];
                     }
                 });
                 
                 // 加载 API 配置
                 const apiConfigs = await db.apiConfig.toArray();
                 state.apiConfig = { proxyUrl: '', apiKey: '' };
                 apiConfigs.forEach(config => {
                     state.apiConfig[config.key] = config.value;
                 });
                 
                 // 加载全局设置
                 const globalSettings = await db.globalSettings.toArray();
                 state.globalSettings = { appIcons: DEFAULT_APP_ICONS };
                 globalSettings.forEach(setting => {
                     state.globalSettings[setting.key] = setting.value;
                 });
                 
                 // 合并默认应用图标
                 if (state.globalSettings.appIcons) {
                     state.globalSettings.appIcons = { ...DEFAULT_APP_ICONS, ...state.globalSettings.appIcons };
                 } else {
                     state.globalSettings.appIcons = DEFAULT_APP_ICONS;
                 }
                 
                 // 加载用户贴纸
                 const userStickers = await db.userStickers.toArray();
                 state.userStickers = userStickers;
                 
                 // 加载世界书
                 const worldBooks = await db.worldBooks.toArray();
                 state.worldBooks = worldBooks;
                 
                 // 加载音乐库
                 const musicLibrary = await db.musicLibrary.toArray();
                 state.musicLibrary = musicLibrary;
                 
                 // 加载人格预设
                 const personaPresets = await db.personaPresets.toArray();
                 state.personaPresets = personaPresets;
                 
                 // 加载 QZone 设置
                 const qzoneSettings = await db.qzoneSettings.toArray();
                 state.qzoneSettings = {
                     nickname: '用户',
                     avatar: defaultAvatar,
                     backgroundImage: '',
                     backgroundOpacity: 0.3
                 };
                 qzoneSettings.forEach(setting => {
                     state.qzoneSettings[setting.key] = setting.value;
                 });
                 
                 // 加载初始收藏夹数据
                 allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray();
                 
                 // 应用聊天列表背景
                 loadChatListBackground();
                 
             } catch (error) {
                 console.error('加载数据失败:', error);
             }
         }
         
         // 保存全局播放列表
         async function saveGlobalPlaylist() {
             if (musicState.playlist && musicState.playlist.length > 0) {
                 await db.globalSettings.put({ key: 'globalPlaylist', value: musicState.playlist });
             }
         }
         
         // 格式化时间戳
         function formatTimestamp(timestamp) {
             const date = new Date(timestamp);
             return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
         }
         
         // 显示通知
         function showNotification(chatId, message) {
             const chat = state.chats[chatId];
             if (!chat) return;
             
             const notificationBar = document.getElementById('notification-bar');
             const notificationAvatar = document.getElementById('notification-avatar');
             const notificationName = document.getElementById('notification-name');
             const notificationMessage = document.getElementById('notification-message');
             
             if (notificationBar && notificationAvatar && notificationName && notificationMessage) {
                 notificationAvatar.src = chat.settings?.aiAvatar || defaultAvatar;
                 notificationName.textContent = chat.name;
                 notificationMessage.textContent = typeof message === 'string' ? message : '发送了一条消息';
                 
                 notificationBar.style.display = 'flex';
                 notificationBar.onclick = () => {
                     openChat(chatId);
                     notificationBar.style.display = 'none';
                 };
                 
                 setTimeout(() => {
                     notificationBar.style.display = 'none';
                 }, 3000);
             }
         }
         
         // 初始化用户头像
         function initializeUserAvatar() {
             const userAvatarImg = document.getElementById('user-avatar');
             if (userAvatarImg) {
                 const savedAvatar = state.qzoneSettings?.avatar;
                 userAvatarImg.src = savedAvatar || defaultAvatar;
             }
         }
         
         // 初始化应用
         async function initializeApp() {
             await loadAllDataFromDB();
             initializeUserAvatar();
             
             // 应用自定义字体
             const customFontUrl = state.globalSettings?.customFontUrl;
             if (customFontUrl) {
                 await applyCustomFont(customFontUrl);
             }
         }
         
         // 更新时钟
         function updateClock() {
             const now = new Date();
             const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
             const clockElement = document.getElementById('status-time');
             if (clockElement) {
                 clockElement.textContent = timeString;
             }
         }
         
         // 解析 AI 响应
         function parseAiResponse(content) {
             try {
                 // 尝试标准 JSON 数组解析
                 return JSON.parse(content);
             } catch {
                 try {
                     // 使用正则表达式强制解析 JSON 对象
                     const jsonMatch = content.match(/\{[\s\S]*\}/);
                     if (jsonMatch) {
                         const jsonStr = jsonMatch[0];
                         const parsed = JSON.parse(jsonStr);
                         return [parsed];
                     }
                 } catch {
                     // 如果都失败了，返回纯文本
                     return [{ role: 'assistant', content: content }];
                 }
             }
             return [{ role: 'assistant', content: content }];
         }
         
         // 渲染 API 设置
         function renderApiSettings() {
             const proxyUrlInput = document.getElementById('proxy-url');
             const apiKeyInput = document.getElementById('api-key');
                      const backgroundActivityCheckbox = document.getElementById('background-activity');
         const backgroundIntervalInput = document.getElementById('background-interval');
         const blockCooldownInput = document.getElementById('block-cooldown');
         
         if (proxyUrlInput) proxyUrlInput.value = state.apiConfig.proxyUrl || '';
         if (apiKeyInput) apiKeyInput.value = state.apiConfig.apiKey || '';
         if (backgroundActivityCheckbox) backgroundActivityCheckbox.checked = state.globalSettings.backgroundActivity || false;
         if (backgroundIntervalInput) backgroundIntervalInput.value = state.globalSettings.backgroundInterval || 30;
         if (blockCooldownInput) blockCooldownInput.value = state.globalSettings.blockCooldown || 5;
     }

     // Export backup function
     async function exportBackup() {
         try {
             const backupData = {};
             
             const [
                 chats, worldBooks, userStickers, apiConfig, globalSettings,
                 personaPresets, musicLibrary, qzoneSettings, qzonePosts,
                 qzoneAlbums, qzonePhotos, favorites, qzoneGroups,
                 memories
             ] = await Promise.all([
                 db.chats.toArray(),
                 db.worldBooks.toArray(),
                 db.userStickers.toArray(),
                 db.apiConfig.get('main'),
                 db.globalSettings.get('main'),
                 db.personaPresets.toArray(),
                 db.musicLibrary.get('main'),
                 db.qzoneSettings.get('main'),
                 db.qzonePosts.toArray(),
                 db.qzoneAlbums.toArray(),
                 db.qzonePhotos.toArray(),
                 db.favorites.toArray(),
                 db.qzoneGroups.toArray(),
                 db.memories.toArray()
             ]);
             
             Object.assign(backupData, {
                 chats, worldBooks, userStickers, apiConfig, globalSettings,
                 personaPresets, musicLibrary, qzoneSettings, qzonePosts,
                 qzoneAlbums, qzonePhotos, favorites, qzoneGroups,
                 memories
             });
             
             const blob = new Blob(
                 [JSON.stringify(backupData, null, 2)],
                 { type: 'application/json' }
             );
             const url = URL.createObjectURL(blob);
             const link = Object.assign(document.createElement('a'), {
                 href: url,
                 download: `lingki-Full-Backup-${new Date().toISOString().split('T')[0]}.json`
             });
             link.click();
             URL.revokeObjectURL(url);
             
             await showCustomAlert('导出成功', '已成功导出所有数据！');
             
         } catch (error) {
             console.error("导出数据时出错:", error);
             await showCustomAlert('导出失败', `发生了一个错误: ${error.message}`);
         }
     }
        
        // Data import function
        async function importBackup(file) {
            if (!file) return;
            
            const confirmed = await showCustomConfirm(
                '严重警告！',
                '导入备份将完全覆盖您当前的所有数据，包括聊天、动态、设置等。此操作不可撤销！您确定要继续吗？',
                { confirmButtonClass: 'btn-danger' }
            );
            
            if (!confirmed) return;
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                // 验证数据格式
                if (!data.chats || !data.globalSettings) {
                    await showCustomAlert('导入失败', '备份文件格式不正确。');
                    return;
                }
                
                // 清空现有数据
                await db.transaction('rw', [db.chats, db.qzonePosts, db.userStickers, db.worldBooks, db.memories], async () => {
                    await db.chats.clear();
                    await db.qzonePosts.clear();
                    await db.userStickers.clear();
                    await db.worldBooks.clear();
                    await db.memories.clear();
                });
                
                // 导入新数据
                if (data.chats) {
                    for (const chat of Object.values(data.chats)) {
                        await db.chats.put(chat);
                    }
                }
                
                if (data.qzonePosts) {
                    for (const post of data.qzonePosts) {
                        await db.qzonePosts.put(post);
                    }
                }
                
                if (data.userStickers) {
                    for (const sticker of data.userStickers) {
                        await db.userStickers.put(sticker);
                    }
                }
                
                if (data.worldBooks) {
                    for (const book of data.worldBooks) {
                        await db.worldBooks.put(book);
                    }
                }
                
                if (data.memories) {
                    for (const memory of data.memories) {
                        await db.memories.put(memory);
                    }
                }
                
                // 更新状态
                state.chats = data.chats || {};
                state.globalSettings = { ...state.globalSettings, ...data.globalSettings };
                state.apiConfig = { ...state.apiConfig, ...data.apiConfig };
                state.qzoneSettings = { ...state.qzoneSettings, ...data.qzoneSettings };
                state.userStickers = data.userStickers || [];
                state.worldBooks = data.worldBooks || [];
                
                // 保存全局设置
                await db.globalSettings.put(state.globalSettings, 'main');
                await db.apiConfig.put(state.apiConfig, 'main');
                await db.qzoneSettings.put(state.qzoneSettings, 'main');
                
                await showCustomAlert('导入成功', '数据已成功导入！页面将自动刷新。');
                
                // 刷新页面以应用新数据
                setTimeout(() => {
                    location.reload();
                }, 1000);
                
            } catch (error) {
                console.error("导入数据时出错:", error);
                await showCustomAlert('导入失败', `发生了一个错误: ${error.message}`);
            }
        }

        // Reset all data function
        async function resetAllData() {
            const confirmed = await showCustomConfirm(
                '危险操作',
                '此操作将删除所有数据，包括聊天记录、动态、设置等，且无法恢复！您确定要继续吗？',
                { confirmButtonClass: 'btn-danger' }
            );
            
            if (!confirmed) return;
            
            try {
                // 清空数据库
                await db.transaction('rw', [db.chats, db.qzonePosts, db.userStickers, db.worldBooks, db.memories, db.globalSettings, db.apiConfig, db.qzoneSettings], async () => {
                    await db.chats.clear();
                    await db.qzonePosts.clear();
                    await db.userStickers.clear();
                    await db.worldBooks.clear();
                    await db.memories.clear();
                    await db.globalSettings.clear();
                    await db.apiConfig.clear();
                    await db.qzoneSettings.clear();
                });
                
                await showCustomAlert('重置成功', '所有数据已清除！页面将自动刷新。');
                
                // 刷新页面
                setTimeout(() => {
                    location.reload();
                }, 1000);
                
            } catch (error) {
                console.error("重置数据时出错:", error);
                await showCustomAlert('重置失败', `发生了一个错误: ${error.message}`);
            }
        }

        // Apply custom font function
        async function applyCustomFont() {
            const fontUrl = document.getElementById('font-url-input').value.trim();
            
            if (!fontUrl) {
                await showCustomAlert('错误', '请输入字体文件URL。');
                return;
            }
            
            try {
                // 创建字体样式
                const fontName = `CustomFont_${Date.now()}`;
                const fontStyle = document.createElement('style');
                fontStyle.id = 'custom-font-style';
                
                // 移除旧的字体样式
                const oldStyle = document.getElementById('custom-font-style');
                if (oldStyle) {
                    oldStyle.remove();
                }
                
                fontStyle.textContent = `
                    @font-face {
                        font-family: '${fontName}';
                        src: url('${fontUrl}');
                        font-display: swap;
                    }
                    
                    .custom-font {
                        font-family: '${fontName}', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                    }
                `;
                
                document.head.appendChild(fontStyle);
                
                // 应用字体到整个应用
                document.body.classList.add('custom-font');
                
                // 保存字体设置
                state.globalSettings.customFont = {
                    url: fontUrl,
                    name: fontName,
                    applied: true
                };
                
                await db.globalSettings.put(state.globalSettings, 'main');
                
                await showCustomAlert('成功', '自定义字体已应用！');
                
                // 更新预览
                updateFontPreview();
                
            } catch (error) {
                console.error('应用字体时出错:', error);
                await showCustomAlert('错误', `应用字体失败: ${error.message}`);
            }
        }

        // Reset custom font function
        async function resetCustomFont() {
            try {
                // 移除字体样式
                const fontStyle = document.getElementById('custom-font-style');
                if (fontStyle) {
                    fontStyle.remove();
                }
                
                // 移除字体类
                document.body.classList.remove('custom-font');
                
                // 清除字体设置
                if (state.globalSettings.customFont) {
                    delete state.globalSettings.customFont;
                    await db.globalSettings.put(state.globalSettings, 'main');
                }
                
                // 清空输入框
                document.getElementById('font-url-input').value = '';
                
                await showCustomAlert('成功', '已重置为默认字体！');
                
                // 更新预览
                updateFontPreview();
                
            } catch (error) {
                console.error('重置字体时出错:', error);
                await showCustomAlert('错误', `重置字体失败: ${error.message}`);
            }
        }

        // Update font preview function
        function updateFontPreview() {
            const preview = document.getElementById('font-preview');
            const urlInput = document.getElementById('font-url-input');
            
            if (state.globalSettings.customFont && state.globalSettings.customFont.applied) {
                preview.textContent = `当前字体: ${state.globalSettings.customFont.name}`;
                preview.className = 'font-preview custom-font';
                urlInput.value = state.globalSettings.customFont.url;
            } else {
                preview.textContent = '当前使用系统默认字体';
                preview.className = 'font-preview';
            }
        }

        // Initialize user avatar function
        function initializeUserAvatar() {
            const avatarImg = document.getElementById('user-avatar');
            
            if (state.globalSettings.userAvatar) {
                avatarImg.src = state.globalSettings.userAvatar;
            } else {
                // 使用默认头像
                avatarImg.src = defaultAvatar;
            }
            
            // 添加点击事件
            avatarImg.addEventListener('click', () => {
                showScreen('user-menu-screen');
            });
        }

        // Application initialization function
        async function initializeApp() {
            try {
                console.log('开始初始化应用...');
                
                // 加载数据库数据
                await loadDatabaseData();
                
                // 初始化用户头像
                initializeUserAvatar();
                
                // 应用全局壁纸
                applyGlobalWallpaper();
                
                // 应用自定义字体
                if (state.globalSettings.customFont && state.globalSettings.customFont.applied) {
                    try {
                        const fontName = state.globalSettings.customFont.name;
                        const fontUrl = state.globalSettings.customFont.url;
                        
                        const fontStyle = document.createElement('style');
                        fontStyle.id = 'custom-font-style';
                        fontStyle.textContent = `
                            @font-face {
                                font-family: '${fontName}';
                                src: url('${fontUrl}');
                                font-display: swap;
                            }
                            
                            .custom-font {
                                font-family: '${fontName}', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                            }
                        `;
                        
                        document.head.appendChild(fontStyle);
                        document.body.classList.add('custom-font');
                    } catch (error) {
                        console.error('加载自定义字体失败:', error);
                    }
                }
                
                // 渲染聊天列表
                renderChatList();
                
                // 渲染API设置
                renderApiSettings();
                
                // 初始化收藏功能
                initializeFavorites();
                
                // 设置全局播放列表保存
                setupGlobalPlaylistSaving();
                
                // 显示聊天列表页面
                showScreen('chat-list-screen');
                
                console.log('应用初始化完成');
                
            } catch (error) {
                console.error('应用初始化失败:', error);
                await showCustomAlert('初始化失败', `应用启动时发生错误: ${error.message}`);
            }
        }

        // Render chat list function
        function renderChatList() {
            const container = document.getElementById('chat-list-container');
            const searchInput = document.getElementById('chat-search-input');
            
            if (!container) return;
            
            container.innerHTML = '';
            
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            const chats = Object.values(state.chats).filter(chat => 
                chat.name.toLowerCase().includes(searchTerm)
            );
            
            // 按最后消息时间排序
            chats.sort((a, b) => {
                const aLastTime = a.history.length > 0 ? a.history[a.history.length - 1].timestamp : 0;
                const bLastTime = b.history.length > 0 ? b.history[b.history.length - 1].timestamp : 0;
                return bLastTime - aLastTime;
            });
            
            if (chats.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>暂无聊天</p>
                        <p>点击右上角"+"开始新的对话</p>
                    </div>
                `;
                return;
            }
            
            chats.forEach(chat => {
                const item = createChatListItem(chat);
                container.appendChild(item);
            });
        }

        // Create chat list item function
        function createChatListItem(chat) {
            const defaultAvatar = 'https://via.placeholder.com/40x40/007bff/ffffff?text=AI';
            const defaultMyGroupAvatar = 'https://via.placeholder.com/40x40/28a745/ffffff?text=ME';
            const defaultGroupMemberAvatar = 'https://via.placeholder.com/40x40/6c757d/ffffff?text=M';
            
            // 获取最后一条消息显示
            let lastMsgDisplay = '暂无消息';
            
            if (chat.history.length > 0) {
                const lastMsgObj = chat.history[chat.history.length - 1];
                
                if (chat.isGroup) {
                    // 群聊逻辑：显示发送者和消息内容
                    const senderName = lastMsgObj.role === 'user' ? 
                        (chat.settings.myNickname || '我') : 
                        (lastMsgObj.senderName || '成员');
                    
                    if (lastMsgObj.content) {
                        if (lastMsgObj.type === 'transfer') { 
                            lastMsgDisplay = `${senderName}: [转账]`; 
                        } else if (lastMsgObj.type === 'ai_image' || lastMsgObj.type === 'user_photo') { 
                            lastMsgDisplay = `${senderName}: [照片]`; 
                        } else if (lastMsgObj.type === 'voice_message') { 
                            lastMsgDisplay = `${senderName}: [语音]`; 
                        } else if (typeof lastMsgObj.content === 'string' && /^https?:\/\/.*\.(jpg|jpeg|png|gif|webp)$/i.test(lastMsgObj.content)) { 
                            lastMsgDisplay = lastMsgObj.meaning ? `${senderName}: [表情: ${lastMsgObj.meaning}]` : `${senderName}: [表情]`; 
                        } else if (Array.isArray(lastMsgObj.content)) { 
                            lastMsgDisplay = `${senderName}: [图片]`; 
                        } else { 
                            lastMsgDisplay = `${senderName}: ${String(lastMsgObj.content || '...').substring(0, 20)}`; 
                        }
                    } else {
                        lastMsgDisplay = `${senderName}: ...`;
                    }
                } else {
                    // 单聊逻辑：如果有消息历史，显示最后一条消息；否则显示状态
                    if (lastMsgObj.content) {
                        if (lastMsgObj.type === 'transfer') { 
                            lastMsgDisplay = '[转账]'; 
                        } else if (lastMsgObj.type === 'ai_image' || lastMsgObj.type === 'user_photo') { 
                            lastMsgDisplay = '[照片]'; 
                        } else if (lastMsgObj.type === 'voice_message') { 
                            lastMsgDisplay = '[语音]'; 
                        } else if (typeof lastMsgObj.content === 'string' && /^https?:\/\/.*\.(jpg|jpeg|png|gif|webp)$/i.test(lastMsgObj.content)) { 
                            lastMsgDisplay = lastMsgObj.meaning ? `[表情: ${lastMsgObj.meaning}]` : '[表情]'; 
                        } else if (Array.isArray(lastMsgObj.content)) { 
                            lastMsgDisplay = `[图片]`; 
                        } else { 
                            lastMsgDisplay = String(lastMsgObj.content || '...').substring(0, 20); 
                        }
                    } else {
                        // 没有消息历史时显示状态
                        const statusText = chat.status?.text || '在线';
                        lastMsgDisplay = `[${statusText}]`;
                    }
                }
            }

            const item = document.createElement('div');
            item.className = 'chat-list-item';
            item.dataset.chatId = chat.id;
            const avatar = chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar;
            
            item.innerHTML = `
                <img src="${avatar || defaultAvatar}" class="avatar">
                <div class="info">
                    <div class="name-line">
                        <span class="name">${chat.name}</span>
                        ${chat.isGroup ? '<span class="group-tag">群聊</span>' : ''}
                    </div>
                    <div class="last-msg" style="color: ${chat.isGroup ? 'var(--text-secondary)' : '#b5b5b5'}; font-style: italic;">${lastMsgDisplay}</div>
                </div>
                <div class="unread-count-wrapper">
                    <span class="unread-count" style="display: none;">0</span>
                </div>
            `;
            
            // 控制红点显示/隐藏的逻辑
            const unreadCount = chat.unreadCount || 0;
            const unreadEl = item.querySelector('.unread-count');
            if (unreadCount > 0) {
                unreadEl.textContent = unreadCount > 99 ? '99+' : unreadCount;
                unreadEl.style.display = 'inline-flex';
            } else {
                unreadEl.style.display = 'none';
            }
            
            const avatarEl = item.querySelector('.avatar');
            if (avatarEl) {
                avatarEl.style.cursor = 'pointer';
                avatarEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    handleUserPat(chat.id, chat.name);
                });
            }
            
            const infoEl = item.querySelector('.info');
            if (infoEl) {
                infoEl.addEventListener('click', () => openChat(chat.id));
            }

            // 长按删除功能
            addLongPressListener(item, async (e) => {
                const confirmed = await showCustomConfirm(
                    '删除对话', 
                    `确定要删除与 "${chat.name}" 的整个对话吗？此操作不可撤销。`, 
                    { confirmButtonClass: 'btn-danger' }
                );
                
                if (confirmed) {
                    if (musicState.isActive && musicState.activeChatId === chat.id) {
                        await endListenTogetherSession(false);
                    }
                    
                    delete state.chats[chat.id];
                    
                    if (state.activeChatId === chat.id) {
                        state.activeChatId = null;
                    }
                    
                    await db.chats.delete(chat.id);
                    renderChatList();
                }
            });
            
            return item;
        }

        // Render API settings function
        function renderApiSettings() {
            const proxyUrlInput = document.getElementById('proxy-url-input');
            const apiKeyInput = document.getElementById('api-key-input');
            const modelSelect = document.getElementById('model-select');
            
            if (proxyUrlInput) proxyUrlInput.value = state.apiConfig.proxyUrl || '';
            if (apiKeyInput) apiKeyInput.value = state.apiConfig.apiKey || '';
            if (modelSelect) modelSelect.value = state.apiConfig.model || '';
        }

        // Initialize favorites function
        function initializeFavorites() {
            // 初始化收藏功能的相关设置
            if (!state.globalSettings.favorites) {
                state.globalSettings.favorites = [];
            }
        }

        // Setup global playlist saving function
        function setupGlobalPlaylistSaving() {
            // 设置全局播放列表保存功能
            if (typeof window.saveGlobalPlaylist === 'function') {
                console.log('全局播放列表保存功能已设置');
            }
        }

        // Utility functions for time handling
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMinutes = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffMinutes < 1) {
                return '刚刚';
            } else if (diffMinutes < 60) {
                return `${diffMinutes}分钟前`;
            } else if (diffHours < 24) {
                return `${diffHours}小时前`;
            } else if (diffDays < 7) {
                return `${diffDays}天前`;
            } else {
                return date.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
        }

        // Notification system
        function showNotification(chatId, message) {
            // 简单的通知系统
            if ('Notification' in window && Notification.permission === 'granted') {
                const chat = state.chats[chatId];
                if (chat) {
                    new Notification(chat.name, {
                        body: message,
                        icon: chat.settings.aiAvatar || defaultAvatar
                    });
                }
            }
        }

        // AI response parsing utility
        function parseAiResponse(content) {
            try {
                // 尝试解析JSON数组
                const parsed = JSON.parse(content);
                if (Array.isArray(parsed)) {
                    return parsed;
                } else {
                    // 如果不是数组，包装成数组
                    return [parsed];
                }
            } catch (error) {
                console.warn('AI响应解析失败，使用纯文本模式:', error);
                // 解析失败时，返回纯文本消息
                return [{
                    type: 'text',
                    content: content
                }];
            }
        }

        // Advanced chat interface rendering function
        function renderChatInterface(chatId) {
            cleanupWaimaiTimers();
            const chat = state.chats[chatId];
            if (!chat) return;
            exitSelectionMode();
            
            const messagesContainer = document.getElementById('chat-messages');
            const chatInputArea = document.getElementById('chat-input-area');
            const lockOverlay = document.getElementById('chat-lock-overlay');
            const lockContent = document.getElementById('chat-lock-content');

            messagesContainer.dataset.theme = chat.settings.theme || 'default';
            const fontSize = chat.settings.fontSize || 13;
            messagesContainer.style.setProperty('--chat-font-size', `${fontSize}px`);
            applyScopedCss(chat.settings.customCss || '', '#chat-messages', 'custom-bubble-style');
            
            document.getElementById('chat-header-title').textContent = chat.name;
            const statusContainer = document.getElementById('chat-header-status');
            const statusTextEl = statusContainer.querySelector('.status-text');

            if (chat.isGroup) {
                statusContainer.style.display = 'none';
                document.getElementById('chat-header-title-wrapper').style.justifyContent = 'center';
            } else {
                statusContainer.style.display = 'flex';
                document.getElementById('chat-header-title-wrapper').style.justifyContent = 'flex-start';
                statusTextEl.textContent = chat.status?.text || '在线';
                statusContainer.classList.toggle('busy', chat.status?.isBusy || false);
            }
            
            lockOverlay.style.display = 'none';
            chatInputArea.style.visibility = 'visible';
            lockContent.innerHTML = '';

            if (!chat.isGroup && chat.relationship.status !== 'friend') {
                lockOverlay.style.display = 'flex';
                chatInputArea.style.visibility = 'hidden';
                
                let lockHtml = '';
                switch (chat.relationship.status) {
                    case 'blocked_by_user':
                        const isSimulationRunning = simulationIntervalId !== null;
                        const blockedTimestamp = chat.relationship.blockedTimestamp;
                        const cooldownHours = state.globalSettings.blockCooldownHours || 1;
                        const cooldownMilliseconds = cooldownHours * 60 * 60 * 1000;
                        const timeSinceBlock = Date.now() - blockedTimestamp;
                        const isCooldownOver = timeSinceBlock > cooldownMilliseconds;
                        const timeRemainingMinutes = Math.max(0, Math.ceil((cooldownMilliseconds - timeSinceBlock) / (1000 * 60)));

                        lockHtml = `
                            <span class="lock-text">你已将"${chat.name}"拉黑。</span>
                            <button id="unblock-btn" class="lock-action-btn">解除拉黑</button>
                            <div style="margin-top: 20px; padding: 10px; border: 1px dashed #ccc; border-radius: 8px; font-size: 11px; text-align: left; color: #666; background: rgba(0,0,0,0.02);">
                                <strong style="color: #333;">【开发者诊断面板】</strong><br>
                                - 后台活动总开关: ${state.globalSettings.enableBackgroundActivity ? '<span style="color: green;">已开启</span>' : '<span style="color: red;">已关闭</span>'}<br>
                                - 系统心跳计时器: ${isSimulationRunning ? '<span style="color: green;">运行中</span>' : '<span style="color: red;">未运行</span>'}<br>
                                - 当前角色状态: <strong>${chat.relationship.status}</strong><br>
                                - 需要冷静(小时): <strong>${cooldownHours}</strong><br>
                                - 冷静期是否结束: ${isCooldownOver ? '<span style="color: green;">是</span>' : `<span style="color: orange;">否 (还剩约 ${timeRemainingMinutes} 分钟)</span>`}<br>
                                - 触发条件: ${isCooldownOver && state.globalSettings.enableBackgroundActivity ? '<span style="color: green;">已满足，等待下次系统心跳</span>' : '<span style="color: red;">未满足</span>'}
                            </div>
                            <button id="force-apply-check-btn" class="lock-action-btn secondary" style="margin-top: 10px;">强制触发一次好友申请检测</button>
                        `;
                        break;
                    case 'blocked_by_ai':
                        lockHtml = `
                            <span class="lock-text">你被对方拉黑了。</span>
                            <button id="apply-friend-btn" class="lock-action-btn">重新申请加为好友</button>
                        `;
                        break;
                    
                    case 'pending_user_approval':
                        lockHtml = `
                            <span class="lock-text">"${chat.name}"请求添加你为好友：<br><i>"${chat.relationship.applicationReason}"</i></span>
                            <button id="accept-friend-btn" class="lock-action-btn">接受</button>
                            <button id="reject-friend-btn" class="lock-action-btn secondary">拒绝</button>
                        `;
                        break;

                    case 'pending_ai_approval':
                        lockHtml = `<span class="lock-text">好友申请已发送，等待对方通过...</span>`;
                        break;
                }
                lockContent.innerHTML = lockHtml;
            }
            
            messagesContainer.innerHTML = '';
            const chatScreen = document.getElementById('chat-interface-screen');
            
            // 检查是否启用了应用聊天列表背景到聊天界面
            if (state.globalSettings?.applyToChatBackground && state.globalSettings?.chatListBackground) {
                applyChatListBackgroundToChat();
            } else {
                chatScreen.style.backgroundImage = chat.settings.background ? `url(${chat.settings.background})` : 'none';
            }

            const isDarkMode = document.getElementById('phone-screen').classList.contains('dark-mode');
            chatScreen.style.backgroundColor = chat.settings.background ? 'transparent' : (isDarkMode ? '#000000' : '#f0f2f5');
            
            const history = chat.history;
            const totalMessages = history.length;
            currentRenderedCount = 0;
            const initialMessages = history.slice(-MESSAGE_RENDER_WINDOW);
            initialMessages.forEach(msg => appendMessage(msg, chat, true));
            currentRenderedCount = initialMessages.length;
            
            if (totalMessages > currentRenderedCount) {
                prependLoadMoreButton(messagesContainer);
            }
            
            const typingIndicator = document.createElement('div');
            typingIndicator.id = 'typing-indicator';
            typingIndicator.style.display = 'none';
            typingIndicator.textContent = '对方正在输入...';
            messagesContainer.appendChild(typingIndicator);
            
            setTimeout(() => messagesContainer.scrollTop = messagesContainer.scrollHeight, 0);
        }

        // Prepend load more button function
        function prependLoadMoreButton(container) { 
            const button = document.createElement('button'); 
            button.id = 'load-more-btn'; 
            button.textContent = '加载更早的记录'; 
            button.addEventListener('click', loadMoreMessages); 
            container.prepend(button); 
        }

        // Load more messages function
        function loadMoreMessages() { 
            const messagesContainer = document.getElementById('chat-messages'); 
            const chat = state.chats[state.activeChatId]; 
            if (!chat) return; 
            
            const loadMoreBtn = document.getElementById('load-more-btn'); 
            if (loadMoreBtn) loadMoreBtn.remove(); 
            
            const totalMessages = chat.history.length; 
            const nextSliceStart = totalMessages - currentRenderedCount - MESSAGE_RENDER_WINDOW; 
            const nextSliceEnd = totalMessages - currentRenderedCount; 
            const messagesToPrepend = chat.history.slice(Math.max(0, nextSliceStart), nextSliceEnd); 
            const oldScrollHeight = messagesContainer.scrollHeight; 
            
            messagesToPrepend.reverse().forEach(msg => prependMessage(msg, chat)); 
            currentRenderedCount += messagesToPrepend.length; 
            
            const newScrollHeight = messagesContainer.scrollHeight; 
            messagesContainer.scrollTop += (newScrollHeight - oldScrollHeight); 
            
            if (totalMessages > currentRenderedCount) { 
                prependLoadMoreButton(messagesContainer); 
            } 
        }

        // Enhanced wallpaper screen rendering function
        function renderWallpaperScreen() { 
            const preview = document.getElementById('wallpaper-preview'); 
            const bg = newWallpaperBase64 || state.globalSettings.wallpaper; 
            
            if (bg && bg.startsWith('data:image')) { 
                preview.style.backgroundImage = `url(${bg})`; 
                preview.textContent = ''; 
            } else if(bg) { 
                preview.style.backgroundImage = bg; 
                preview.textContent = '当前为渐变色'; 
            }
            
            // 调用图标渲染函数
            renderIconSettings();
        }

        // Apply global wallpaper function
        function applyGlobalWallpaper() { 
            // 只应用加载页面壁纸
            applyLoadingScreenWallpaper();
        }

        // Apply loading screen wallpaper function
        function applyLoadingScreenWallpaper() {
            const loadingScreen = document.getElementById('loading-screen');
            const wallpaper = state.globalSettings.wallpaper;
            
            if (wallpaper && wallpaper.startsWith('data:image')) {
                loadingScreen.style.backgroundImage = `url(${wallpaper})`;
                loadingScreen.classList.add('has-wallpaper');
            } else if (wallpaper) {
                loadingScreen.style.backgroundImage = wallpaper;
                loadingScreen.classList.add('has-wallpaper');
            } else {
                // 如果没有壁纸，使用默认渐变背景
                loadingScreen.style.backgroundImage = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                loadingScreen.classList.remove('has-wallpaper');
            }
        }

        // Render world book screen function
        function renderWorldBookScreen() { 
            const listEl = document.getElementById('world-book-list'); 
            listEl.innerHTML = ''; 
            
            if (state.worldBooks.length === 0) { 
                listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">点击右上角 "+" 创建你的第一本世界书</p>'; 
                return; 
            } 
            
            state.worldBooks.forEach(book => { 
                const item = document.createElement('div'); 
                item.className = 'list-item'; 
                item.dataset.bookId = book.id; 
                item.innerHTML = `
                    <div class="item-title">${book.name}</div>
                    <div class="item-content">${(book.content || '暂无内容...').substring(0, 50)}</div>
                `; 
                
                item.addEventListener('click', () => openWorldBookEditor(book.id)); 
                
                addLongPressListener(item, async () => { 
                    const confirmed = await showCustomConfirm(
                        '删除世界书', 
                        `确定要删除《${book.name}》吗？此操作不可撤销。`, 
                        { confirmButtonClass: 'btn-danger' }
                    ); 
                    
                    if (confirmed) { 
                        await db.worldBooks.delete(book.id); 
                        state.worldBooks = state.worldBooks.filter(wb => wb.id !== book.id); 
                        renderWorldBookScreen(); 
                    } 
                }); 
                
                listEl.appendChild(item); 
            }); 
        }

        // Open world book editor function
        function openWorldBookEditor(bookId) { 
            editingWorldBookId = bookId; 
            const book = state.worldBooks.find(wb => wb.id === bookId); 
            if (!book) return; 
            
            document.getElementById('world-book-editor-title').textContent = book.name; 
            document.getElementById('world-book-name-input').value = book.name; 
            document.getElementById('world-book-content-input').value = book.content; 
            showScreen('world-book-editor-screen'); 
        }

        // Enhanced sticker panel rendering function
        function renderStickerPanel() { 
            const grid = document.getElementById('sticker-grid'); 
            grid.innerHTML = ''; 
            
            if (state.userStickers.length === 0) { 
                grid.innerHTML = '<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;">大人请点击右上角"添加"或"上传"来添加你的第一个表情吧！</p>'; 
                return; 
            } 
            
            state.userStickers.forEach(sticker => { 
                const item = document.createElement('div'); 
                item.className = 'sticker-item'; 
                item.style.backgroundImage = `url(${sticker.url})`; 
                item.title = sticker.name; 
                
                item.addEventListener('click', () => sendSticker(sticker)); 
                
                addLongPressListener(item, () => { 
                    if (isSelectionMode) return; 
                    
                    const existingDeleteBtn = item.querySelector('.delete-btn'); 
                    if (existingDeleteBtn) return; 
                    
                    const deleteBtn = document.createElement('div'); 
                    deleteBtn.className = 'delete-btn'; 
                    deleteBtn.innerHTML = '&times;'; 
                    deleteBtn.onclick = async (e) => { 
                        e.stopPropagation(); 
                        const confirmed = await showCustomConfirm(
                            '删除表情', 
                            `确定要删除表情 "${sticker.name}" 吗？`, 
                            { confirmButtonClass: 'btn-danger' }
                        ); 
                        
                        if (confirmed) { 
                            await db.userStickers.delete(sticker.id); 
                            state.userStickers = state.userStickers.filter(s => s.id !== sticker.id); 
                            renderStickerPanel(); 
                        } 
                    }; 
                    
                    item.appendChild(deleteBtn); 
                    deleteBtn.style.display = 'block'; 
                    
                    setTimeout(() => {
                        item.addEventListener('mouseleave', () => deleteBtn.remove(), { once: true })
                    }, 3000); 
                }); 
                
                grid.appendChild(item); 
            }); 
        }

        // Enhanced open chat function
        async function openChat(chatId) {
            state.activeChatId = chatId;
            const chat = state.chats[chatId];
            if (!chat) return; // 安全检查

            // 在这里将未读数清零
            if (chat.unreadCount > 0) {
                chat.unreadCount = 0;
                await db.chats.put(chat); // 同步到数据库
            }

            renderChatInterface(chatId);
            showScreen('chat-interface-screen');
            
            if (typeof window.updateListenTogetherIconProxy === 'function') {
                window.updateListenTogetherIconProxy(state.activeChatId);
            }
            
            toggleCallButtons(chat.isGroup || false);    

            if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                console.log(`检测到好友申请待处理状态，为角色 "${chat.name}" 自动触发AI响应...`);
                triggerAiResponse();
            }
            
            // 根据是否为群聊，显示或隐藏投票按钮
            const pollBtn = document.getElementById('send-poll-btn');
            if (pollBtn) {
                pollBtn.style.display = chat.isGroup ? 'flex' : 'none';
            }
        }

        // Filter visible posts for AI function
        function filterVisiblePostsForAI(allPosts, chat) {
            return allPosts.filter(post => {
                // 如果帖子没有可见性限制，所有人都能看到
                if (!post.visibleGroupIds) {
                    return true;
                }
                
                // 如果有可见性限制，检查当前聊天的分组是否在允许列表中
                return post.visibleGroupIds.includes(chat.groupId);
            });
        }

        // Enhanced message element creation function with modern features
        function createMessageElement(msg, chat) {
            if (msg.isHidden) {
                return null;
            }

            if (msg.type === 'pat_message') {
                const wrapper = document.createElement('div');
                wrapper.className = 'message-wrapper system-pat'; 
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble system-bubble'; 
                bubble.dataset.timestamp = msg.timestamp;
                bubble.textContent = msg.content;
                wrapper.appendChild(bubble);
                addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
                wrapper.addEventListener('click', () => { 
                    if (isSelectionMode) toggleMessageSelection(msg.timestamp); 
                });
                return wrapper;
            }

            const isUser = msg.role === 'user';
            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper ${isUser ? 'user' : 'ai'}`;

            // 群聊中显示发送者名称
            if (chat.isGroup && !isUser) {
                const member = chat.members.find(m => m.originalName === msg.senderName);
                
                const senderNameDiv = document.createElement('div');
                senderNameDiv.className = 'sender-name';
                senderNameDiv.textContent = member ? member.groupNickname : (msg.senderName || '未知成员');
                
                wrapper.appendChild(senderNameDiv);
            }

            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${isUser ? 'user' : 'ai'}`;
            bubble.dataset.timestamp = msg.timestamp;

            const timestampEl = document.createElement('span');
            timestampEl.className = 'timestamp';
            timestampEl.textContent = formatTimestamp(msg.timestamp);

            // 头像处理
            let avatarSrc, avatarFrameSrc = '';
            if (chat.isGroup) {
                if (isUser) {
                    avatarSrc = chat.settings.myAvatar || 'https://via.placeholder.com/40x40/28a745/ffffff?text=ME';
                    avatarFrameSrc = chat.settings.myAvatarFrame || '';
                } else {
                    const member = chat.members.find(m => m.originalName === msg.senderName);
                    avatarSrc = member ? member.avatar : 'https://via.placeholder.com/40x40/6c757d/ffffff?text=M';
                    avatarFrameSrc = member ? (member.avatarFrame || '') : '';
                }
            } else {
                if (isUser) {
                    avatarSrc = chat.settings.myAvatar || 'https://via.placeholder.com/40x40/007bff/ffffff?text=ME';
                    avatarFrameSrc = chat.settings.myAvatarFrame || '';
                } else {
                    avatarSrc = chat.settings.aiAvatar || 'https://via.placeholder.com/40x40/007bff/ffffff?text=AI';
                    avatarFrameSrc = chat.settings.aiAvatarFrame || '';
                }
            }
            
            const hasFrameClass = avatarFrameSrc ? 'has-frame' : '';
            let avatarHtml;
            if (avatarFrameSrc) {
                avatarHtml = `
                    <div class="avatar-with-frame">
                        <img src="${avatarSrc}" class="avatar-img">
                        <img src="${avatarFrameSrc}" class="avatar-frame">
                    </div>
                `;
            } else {
                avatarHtml = `<img src="${avatarSrc}" class="avatar">`;
            }
            const avatarGroupHtml = `<div class="avatar-group ${hasFrameClass}">${avatarHtml}</div>`;

            let contentHtml = '';
            
            // 处理不同类型的消息
            if (msg.type === 'share_link') {
                bubble.classList.add('is-link-share');
                
                contentHtml = `
                    <div class="link-share-card" data-timestamp="${msg.timestamp}">
                        <div class="title">${msg.title || '无标题'}</div>
                        <div class="description">${msg.description || '点击查看详情...'}</div>
                        <div class="footer">
                            <svg class="footer-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="2" y1="12" x2="22" y2="12"></line>
                                <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                            </svg>
                            <span>${msg.source_name || '链接分享'}</span>
                        </div>
                    </div>
                `;
            } else if (msg.type === 'user_photo' || msg.type === 'ai_image') {
                bubble.classList.add('is-ai-image');
                const altText = msg.type === 'user_photo' ? "用户描述的照片" : "AI生成的图片";
                contentHtml = `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="ai-generated-image" alt="${altText}" data-description="${msg.content}">`;
            } else if (msg.type === 'voice_message') {
                bubble.classList.add('is-voice-message');
                const duration = Math.max(1, Math.round((msg.content || '').length / 5));
                const durationFormatted = `0:${String(duration).padStart(2, '0')}''`;
                const waveformHTML = '<div></div><div></div><div></div><div></div><div></div>';
                contentHtml = `<div class="voice-message-body" data-text="${msg.content}"><div class="voice-waveform">${waveformHTML}</div><span class="voice-duration">${durationFormatted}</span></div>`;
            } else if (typeof msg.content === 'string' && /^https?:\/\/.*\.(jpg|jpeg|png|gif|webp)$/i.test(msg.content)) {
                bubble.classList.add('is-sticker');
                contentHtml = `<img src="${msg.content}" alt="${msg.meaning || 'Sticker'}" class="sticker-image">`;
            } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
                bubble.classList.add('has-image');
                const imageUrl = msg.content[0].image_url.url;
                contentHtml = `<img src="${imageUrl}" class="chat-image" alt="User uploaded image">`;
            } else {
                contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
            }

            // 引用消息处理
            let quoteHtml = '';
            if (msg.quote) {
                const quotedContentSnippet = String(msg.quote.content || '').substring(0, 50) + (String(msg.quote.content || '').length > 50 ? '...' : '');
                
                quoteHtml = `
                    <div class="quoted-message">
                        <div class="quoted-sender">回复 ${msg.quote.senderName}:</div>
                        <div class="quoted-content">${quotedContentSnippet}</div>
                    </div>
                `;
            }

            // 拼接最终的气泡内容
            bubble.innerHTML = `
                ${avatarGroupHtml}
                <div class="content">
                    ${quoteHtml}
                    ${contentHtml}
                </div>
            `;

            wrapper.appendChild(bubble);
            wrapper.appendChild(timestampEl);
            
            addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
            wrapper.addEventListener('click', () => { 
                if (isSelectionMode) toggleMessageSelection(msg.timestamp); 
            });

            if (!isUser) {
                const avatarContainer = wrapper.querySelector('.avatar-group');
                if (avatarContainer) {
                    avatarContainer.style.cursor = 'pointer';
                    avatarContainer.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const characterName = chat.isGroup ? msg.senderName : chat.name;
                        handleUserPat(chat.id, characterName);
                    });
                }
            }

            return wrapper;
        }

        // Prepend message function
        function prependMessage(msg, chat) { 
            const messagesContainer = document.getElementById('chat-messages'); 
            const messageEl = createMessageElement(msg, chat); 

            if (!messageEl) return; // 如果消息是隐藏的，则不处理

            const loadMoreBtn = document.getElementById('load-more-btn'); 
            if (loadMoreBtn) { 
                messagesContainer.insertBefore(messageEl, loadMoreBtn.nextSibling); 
            } else { 
                messagesContainer.prepend(messageEl); 
            } 
        }

        // Enhanced append message function with animation
        function appendMessage(msg, chat, isInitialLoad = false) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageEl = createMessageElement(msg, chat);

            if (!messageEl) return; // 如果消息是隐藏的，则不处理

            // 只对新消息添加动画，不对初始加载的消息添加
            if (!isInitialLoad) {
                messageEl.classList.add('animate-in');
            }
          
            const typingIndicator = document.getElementById('typing-indicator');
            messagesContainer.insertBefore(messageEl, typingIndicator);
            
            if (!isInitialLoad) {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                currentRenderedCount++;
            }
        }
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                await db.transaction('rw', db.tables, async () => {
                    for (const table of db.tables) {
                        await table.clear();
                    }
                    
                    if (Array.isArray(data.chats)) await db.chats.bulkPut(data.chats);
                    if (Array.isArray(data.worldBooks)) await db.worldBooks.bulkPut(data.worldBooks);
                    if (Array.isArray(data.userStickers)) await db.userStickers.bulkPut(data.userStickers);
                    if (Array.isArray(data.personaPresets)) await db.personaPresets.bulkPut(data.personaPresets);
                    if (Array.isArray(data.qzonePosts)) await db.qzonePosts.bulkPut(data.qzonePosts);
                    if (Array.isArray(data.qzoneAlbums)) await db.qzoneAlbums.bulkPut(data.qzoneAlbums);
                    if (Array.isArray(data.qzonePhotos)) await db.qzonePhotos.bulkPut(data.qzonePhotos);
                    if (Array.isArray(data.favorites)) await db.favorites.bulkPut(data.favorites);
                    if (Array.isArray(data.qzoneGroups)) await db.qzoneGroups.bulkPut(data.qzoneGroups);
                    if (Array.isArray(data.memories)) await db.memories.bulkPut(data.memories);
                    
                    if (data.apiConfig) await db.apiConfig.put(data.apiConfig);
                    if (data.globalSettings) await db.globalSettings.put(data.globalSettings);
                    if (data.musicLibrary) await db.musicLibrary.put(data.musicLibrary);
                    if (data.qzoneSettings) await db.qzoneSettings.put(data.qzoneSettings);
                });
                
                await showCustomAlert('导入成功', '所有数据已成功恢复！应用即将刷新以应用所有更改。');
                
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
                
            } catch (error) {
                console.error("导入数据时出错:", error);
                await showCustomAlert('导入失败', `文件格式不正确或数据已损坏: ${error.message}`);
            }
        }
        
        // Data reset function
        async function resetAllData() {
            const confirmed = await showCustomConfirm(
                '⚠️ 严重警告！',
                '此操作将永久删除所有数据，包括：\n\n' +
                '• 所有聊天记录和角色\n' +
                '• 所有设置和配置\n' +
                '• 所有动态和相册\n' +
                '• 所有收藏和回忆\n' +
                '• 所有表情包和世界书\n\n' +
                '此操作不可撤销！确定要重置所有数据吗？',
                { confirmButtonClass: 'btn-danger' }
            );
            
            if (!confirmed) return;
            
            try {
                // Clear all IndexedDB tables
                await db.transaction('rw', db.tables, async () => {
                    for (const table of db.tables) {
                        await table.clear();
                    }
                });
                
                // Clear localStorage
                localStorage.clear();
                
                // Reset state object
                state = {
                    chats: {},
                    activeChatId: null,
                    globalSettings: {},
                    apiConfig: {},
                    userStickers: [],
                    worldBooks: [],
                    personaPresets: [],
                    qzoneSettings: {},
                    activeAlbumId: null
                };
                
                // Reset music state
                musicState = {
                    isActive: false,
                    activeChatId: null,
                    isPlaying: false,
                    playlist: [],
                    currentIndex: -1,
                    playMode: 'order',
                    totalElapsedTime: 0,
                    timerId: null
                };
                
                // Reset UI state
                newWallpaperBase64 = null;
                isSelectionMode = false;
                selectedMessages = new Set();
                editingMemberId = null;
                editingFrameForMember = false;
                editingWorldBookId = null;
                editingPersonaPresetId = null;
                
                await showCustomAlert('重置成功', '所有数据已成功清空！应用即将刷新。');
                
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
                
            } catch (error) {
                console.error("重置数据时出错:", error);
                await showCustomAlert('重置失败', `发生了一个错误: ${error.message}`);
            }
        }
        
        // Font management functions
        function applyCustomFont(fontUrl, isPreviewOnly = false) {
            if (!fontUrl) {
                dynamicFontStyle.innerHTML = '';
                const fontPreview = document.getElementById('font-preview');
                if (fontPreview) fontPreview.style.fontFamily = '';
                return;
            }
            
            const fontName = 'custom-user-font';
            const newStyle = `
                @font-face {
                  font-family: '${fontName}';
                  src: url('${fontUrl}');
                  font-display: swap;
                }`;
                
            if (isPreviewOnly) {
                const previewStyle = document.getElementById('preview-font-style') || document.createElement('style');
                previewStyle.id = 'preview-font-style';
                previewStyle.innerHTML = newStyle;
                if (!document.getElementById('preview-font-style')) document.head.appendChild(previewStyle);
                const fontPreview = document.getElementById('font-preview');
                if (fontPreview) fontPreview.style.fontFamily = `'${fontName}', 'bulangni', sans-serif`;
            } else {
                dynamicFontStyle.innerHTML = `
                    ${newStyle}
                    body {
                      font-family: '${fontName}', 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                    }`;
            }
        }
        
        async function resetToDefaultFont() {
            dynamicFontStyle.innerHTML = '';
            state.globalSettings.fontUrl = '';
            await db.globalSettings.put(state.globalSettings);
            
            const fontUrlInput = document.getElementById('font-url-input');
            const fontPreview = document.getElementById('font-preview');
            
            if (fontUrlInput) fontUrlInput.value = '';
            if (fontPreview) fontPreview.style.fontFamily = '';
            
            alert('已恢复默认字体。');
        }
        
        // Database loading function
        async function loadAllDataFromDB() {
            const [
                chatsArr,
                apiConfig,
                globalSettings,
                userStickers,
                worldBooks,
                musicLib,
                personaPresets,
                qzoneSettings,
                initialFavorites
            ] = await Promise.all([
                db.chats.toArray(),
                db.apiConfig.get('main'),
                db.globalSettings.get('main'),
                db.userStickers.toArray(),
                db.worldBooks.toArray(),
                db.musicLibrary.get('main'),
                db.personaPresets.toArray(),
                db.qzoneSettings.get('main'),
                db.favorites.orderBy('timestamp').reverse().toArray()
            ]);
            
            state.chats = chatsArr.reduce((acc, chat) => {
                if (typeof chat.unreadCount === 'undefined') {
                    chat.unreadCount = 0;
                }
                
                // Data migration for group chats
                if (chat.isGroup && chat.members && chat.members.length > 0 && chat.members[0].name) {
                    console.log(`检测到旧版群聊数据 for "${chat.name}"，正在执行迁移...`);
                    chat.members.forEach(member => {
                        if (typeof member.originalName === 'undefined') {
                            member.originalName = member.name;
                            member.groupNickname = member.name;
                            delete member.name;
                        }
                    });
                    console.log(`迁移完成 for "${chat.name}"`);
                }
                
                // Add status for single chats
                if (!chat.isGroup && !chat.status) {
                    chat.status = {
                        text: '在线',
                        lastUpdate: Date.now(),
                        isBusy: false
                    };
                    console.log(`为旧角色 "${chat.name}" 补全了status属性。`);
                }
                
                // Add relationship for single chats
                if (!chat.isGroup && !chat.relationship) {
                    chat.relationship = {
                        status: 'friend',
                        blockedTimestamp: null,
                        applicationReason: ''
                    };
                    console.log(`为旧角色 "${chat.name}" 补全了 relationship 属性。`);
                }
                
                // Add AI avatar library
                if (!chat.isGroup && (!chat.settings || !chat.settings.aiAvatarLibrary)) {
                    if (!chat.settings) chat.settings = {};
                    chat.settings.aiAvatarLibrary = [];
                    console.log(`为旧角色 "${chat.name}" 补全了aiAvatarLibrary属性。`);
                }
                
                if (!chat.musicData) chat.musicData = { totalTime: 0 };
                
                if (chat.settings && chat.settings.linkedWorldBookId && !chat.settings.linkedWorldBookIds) {
                    chat.settings.linkedWorldBookIds = [chat.settings.linkedWorldBookId];
                    delete chat.settings.linkedWorldBookId;
                }
                
                acc[chat.id] = chat;
                return acc;
            }, {});
            
            state.apiConfig = apiConfig || { id: 'main', proxyUrl: '', apiKey: '', model: '' };
            
            state.globalSettings = globalSettings || {
                id: 'main',
                wallpaper: 'linear-gradient(135deg, #89f7fe, #66a6ff)',
                fontUrl: '',
                enableBackgroundActivity: false,
                backgroundActivityInterval: 60,
                blockCooldownHours: 1,
                appIcons: { ...DEFAULT_APP_ICONS }
            };
            
            // Merge saved icons with default icons
            state.globalSettings.appIcons = { ...DEFAULT_APP_ICONS, ...(state.globalSettings.appIcons || {}) };
            
            state.userStickers = userStickers || [];
            state.worldBooks = worldBooks || [];
            musicState.playlist = musicLib?.playlist || [];
            state.personaPresets = personaPresets || [];
            state.qzoneSettings = qzoneSettings || {
                id: 'main',
                nickname: '{{user}}',
                avatar: 'https://files.catbox.moe/q6z5fc.jpeg',
                banner: 'https://files.catbox.moe/r5heyt.gif'
            };
            
            allFavoriteItems = initialFavorites || [];
            
            // Load chat list background
            if (state.globalSettings.chatListBackground) {
                setTimeout(() => {
                    const opacity = (state.globalSettings.chatListBackgroundOpacity || 100) / 100;
                    setChatListBackground(state.globalSettings.chatListBackground, opacity);
                }, 100);
            }
        }
        
        // Music playlist save function
        async function saveGlobalPlaylist() {
            await db.musicLibrary.put({ id: 'main', playlist: musicState.playlist });
        }
        
        // Timestamp formatting
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        // Notification system
        let notificationTimeout;
        
        function showNotification(chatId, messageContent) {
            clearTimeout(notificationTimeout);
            const chat = state.chats[chatId];
            if (!chat) return;
            
            const bar = document.getElementById('notification-bar');
            if (!bar) return;
            
            const avatar = document.getElementById('notification-avatar');
            const content = document.getElementById('notification-content');
            
            if (avatar) avatar.src = chat.settings.aiAvatar || chat.settings.groupAvatar || defaultAvatar;
            if (content) {
                const nameEl = content.querySelector('.name');
                const messageEl = content.querySelector('.message');
                if (nameEl) nameEl.textContent = chat.name;
                if (messageEl) messageEl.textContent = messageContent;
            }
            
            const newBar = bar.cloneNode(true);
            bar.parentNode.replaceChild(newBar, bar);
            
            newBar.addEventListener('click', () => {
                openChat(chatId);
                newBar.classList.remove('visible');
            });
            
            newBar.classList.add('visible');
            notificationTimeout = setTimeout(() => {
                newBar.classList.remove('visible');
            }, 4000);
        }
        
        // User avatar initialization
        function initializeUserAvatar() {
            const userAvatar = document.getElementById('user-avatar');
            if (!userAvatar) return;
            
            const savedAvatar = state.globalSettings?.userAvatar;
            if (savedAvatar) {
                userAvatar.src = savedAvatar;
            } else {
                userAvatar.src = 'data:image/svg+xml;utf8,<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="16" cy="16" r="16" fill="%23F0F0F0"/><circle cx="16" cy="12" r="5" fill="%23999999"/><path d="M6 26C6 21.5817 9.58172 18 14 18H18C22.4183 18 26 21.5817 26 26V28H6V26Z" fill="%23999999"/></svg>';
            }
        }
        
        // Initialize application
        async function initializeApp() {
            try {
                await loadAllDataFromDB();
                initializeUserAvatar();
                
                // Apply custom font if set
                if (state.globalSettings.fontUrl) {
                    applyCustomFont(state.globalSettings.fontUrl);
                }
                
                console.log('应用初始化完成');
            } catch (error) {
                console.error('应用初始化失败:', error);
            }
        }
        
        // Start the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // Clock update function
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            const timeEl = document.getElementById('status-bar-time');
            if (timeEl) timeEl.textContent = timeString;
        }
        
        // AI response parsing function
        function parseAiResponse(content) {
            const trimmedContent = content.trim();
            
            // Try parsing as standard JSON array
            if (trimmedContent.startsWith('[') && trimmedContent.endsWith(']')) {
                try {
                    const parsed = JSON.parse(trimmedContent);
                    if (Array.isArray(parsed)) {
                        console.log("解析成功：标准JSON数组格式。");
                        return parsed;
                    }
                } catch (e) {
                    console.warn("标准JSON数组解析失败，将尝试强力解析...");
                }
            }
            
            // Force parsing using regex
            const jsonMatches = trimmedContent.match(/{[^{}]*}/g);
            
            if (jsonMatches) {
                const results = [];
                for (const match of jsonMatches) {
                    try {
                        const parsedObject = JSON.parse(match);
                        results.push(parsedObject);
                    } catch (e) {
                        console.warn("跳过一个无效的JSON片段:", match);
                    }
                }
                
                if (results.length > 0) {
                    console.log("解析成功：通过强力提取模式。");
                    return results;
                }
            }
            
            // Fallback to plain text
            console.error("所有解析方案均失败！将返回原始文本。");
            return [{ type: 'text', content: content }];
        }
        
        // API settings rendering
        function renderApiSettings() {
            const proxyUrlEl = document.getElementById('proxy-url');
            const apiKeyEl = document.getElementById('api-key');
            const backgroundActivityEl = document.getElementById('background-activity-switch');
            const backgroundIntervalEl = document.getElementById('background-interval-input');
            const blockCooldownEl = document.getElementById('block-cooldown-input');
            
            if (proxyUrlEl) proxyUrlEl.value = state.apiConfig.proxyUrl || '';
            if (apiKeyEl) apiKeyEl.value = state.apiConfig.apiKey || '';
            if (backgroundActivityEl) backgroundActivityEl.checked = state.globalSettings.enableBackgroundActivity || false;
            if (backgroundIntervalEl) backgroundIntervalEl.value = state.globalSettings.backgroundActivityInterval || 60;
            if (blockCooldownEl) blockCooldownEl.value = state.globalSettings.blockCooldownHours || 1;
        }
        
        // Chat list rendering
        async function renderChatList() {
            const chatListEl = document.getElementById('chat-list');
            if (!chatListEl) return;
            
            chatListEl.innerHTML = '';
            
            const activeToggle = document.querySelector('.toggle-btn.active');
            const filterType = activeToggle ? activeToggle.dataset.type : 'all';
            
            let allChats = Object.values(state.chats).sort((a, b) => 
                (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0)
            );
            
            console.log('renderChatList 调试信息:');
            console.log('- 总聊天数量:', Object.keys(state.chats).length);
            console.log('- 过滤类型:', filterType);
            console.log('- 过滤前聊天数量:', allChats.length);
            
            if (filterType === 'single') {
                allChats = allChats.filter(chat => !chat.isGroup);
            } else if (filterType === 'group') {
                allChats = allChats.filter(chat => chat.isGroup);
            }
            
            console.log('- 过滤后聊天数量:', allChats.length);
            
            const allGroups = await db.qzoneGroups.toArray();
            
            if (allChats.length === 0) {
                console.log('- 聊天列表为空，显示提示信息');
                chatListEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">点击右上角 "+" 或群组图标添加聊天</p>';
                return;
            }
            
            // Group processing
            allGroups.forEach(group => {
                const latestChatInGroup = allChats.find(chat => chat.groupId === group.id);
                group.latestTimestamp = latestChatInGroup ? (latestChatInGroup.history.slice(-1)[0]?.timestamp || 0) : 0;
            });
            
            allGroups.sort((a, b) => b.latestTimestamp - a.latestTimestamp);
            
            allGroups.forEach(group => {
                const groupChats = allChats.filter(chat => !chat.isGroup && chat.groupId === group.id);
                if (groupChats.length === 0) return;
                
                const groupContainer = document.createElement('div');
                groupContainer.className = 'chat-group-container';
                groupContainer.innerHTML = `
                    <div class="chat-group-header">
                        <span class="arrow">▼</span>
                        <span class="group-name">${group.name}</span>
                    </div>
                    <div class="chat-group-content"></div>
                `;
                const contentEl = groupContainer.querySelector('.chat-group-content');
                groupChats.forEach(chat => {
                    const item = createChatListItem(chat);
                    contentEl.appendChild(item);
                });
                chatListEl.appendChild(groupContainer);
            });
            
            const ungroupedOrGroupChats = allChats.filter(chat => chat.isGroup || (!chat.isGroup && !chat.groupId));
            ungroupedOrGroupChats.forEach(chat => {
                const item = createChatListItem(chat);
                chatListEl.appendChild(item);
            });
            
            // Add collapse functionality
            document.querySelectorAll('.chat-group-header').forEach(header => {
                header.addEventListener('click', () => {
                    header.classList.toggle('collapsed');
                    header.nextElementSibling.classList.toggle('collapsed');
                });
            });
        }
        
        // Chat list item creation
        function createChatListItem(chat) {
            const lastMsgObj = chat.history.filter(msg => !msg.isHidden).slice(-1)[0] || {};
            let lastMsgDisplay;
            
            if (!chat.isGroup && chat.relationship?.status === 'pending_user_approval') {
                lastMsgDisplay = `<span style="color: #ff8c00;">[好友申请] ${chat.relationship.applicationReason || '请求添加你为好友'}</span>`;
            } else if (!chat.isGroup && chat.relationship?.status === 'blocked_by_ai') {
                lastMsgDisplay = `<span style="color: #dc3545;">[你已被对方拉黑]</span>`;
            } else {
                if (chat.isGroup) {
                    if (lastMsgObj.type === 'pat_message') {
                        lastMsgDisplay = `[系统消息] ${lastMsgObj.content}`;
                    } else if (lastMsgObj.type === 'transfer') {
                        lastMsgDisplay = '[转账]';
                    } else if (lastMsgObj.type === 'ai_image' || lastMsgObj.type === 'user_photo') {
                        lastMsgDisplay = '[照片]';
                    } else if (lastMsgObj.type === 'voice_message') {
                        lastMsgDisplay = '[语音]';
                    } else if (typeof lastMsgObj.content === 'string' && STICKER_REGEX.test(lastMsgObj.content)) {
                        lastMsgDisplay = lastMsgObj.meaning ? `[表情: ${lastMsgObj.meaning}]` : '[表情]';
                    } else if (Array.isArray(lastMsgObj.content)) {
                        lastMsgDisplay = `[图片]`;
                    } else {
                        lastMsgDisplay = String(lastMsgObj.content || '...').substring(0, 20);
                    }
                    
                    if (lastMsgObj.senderName && lastMsgObj.type !== 'pat_message') {
                        lastMsgDisplay = `${lastMsgObj.senderName}: ${lastMsgDisplay}`;
                    }
                } else {
                    if (lastMsgObj.content) {
                        if (lastMsgObj.type === 'transfer') {
                            lastMsgDisplay = '[转账]';
                        } else if (lastMsgObj.type === 'ai_image' || lastMsgObj.type === 'user_photo') {
                            lastMsgDisplay = '[照片]';
                        } else if (lastMsgObj.type === 'voice_message') {
                            lastMsgDisplay = '[语音]';
                        } else if (typeof lastMsgObj.content === 'string' && STICKER_REGEX.test(lastMsgObj.content)) {
                            lastMsgDisplay = lastMsgObj.meaning ? `[表情: ${lastMsgObj.meaning}]` : '[表情]';
                        } else if (Array.isArray(lastMsgObj.content)) {
                            lastMsgDisplay = `[图片]`;
                        } else {
                            lastMsgDisplay = String(lastMsgObj.content || '...').substring(0, 20);
                        }
                    } else {
                        const statusText = chat.status?.text || '在线';
                        lastMsgDisplay = `[${statusText}]`;
                    }
                }
            }
            
            const item = document.createElement('div');
            item.className = 'chat-list-item';
            item.dataset.chatId = chat.id;
            const avatar = chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar;
            
            item.innerHTML = `
                <img src="${avatar || defaultAvatar}" class="avatar">
                <div class="info">
                    <div class="name-line">
                        <span class="name">${chat.name}</span>
                        ${chat.isGroup ? '<span class="group-tag">群聊</span>' : ''}
                    </div>
                    <div class="last-msg" style="color: ${chat.isGroup ? 'var(--text-secondary)' : '#b5b5b5'}; font-style: italic;">${lastMsgDisplay}</div>
                </div>
                <div class="unread-count-wrapper">
                    <span class="unread-count" style="display: none;">0</span>
                </div>
            `;
            
            const unreadCount = chat.unreadCount || 0;
            const unreadEl = item.querySelector('.unread-count');
            if (unreadCount > 0) {
                unreadEl.textContent = unreadCount > 99 ? '99+' : unreadCount;
                unreadEl.style.display = 'inline-flex';
            } else {
                unreadEl.style.display = 'none';
            }
            
            const avatarEl = item.querySelector('.avatar');
            if (avatarEl) {
                avatarEl.style.cursor = 'pointer';
                avatarEl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    handleUserPat(chat.id, chat.name);
                });
            }
            
            const infoEl = item.querySelector('.info');
            if (infoEl) {
                infoEl.addEventListener('click', () => openChat(chat.id));
            }
            
            addLongPressListener(item, async (e) => {
                const confirmed = await showCustomConfirm('删除对话', `确定要删除与 "${chat.name}" 的整个对话吗？此操作不可撤销。`, { confirmButtonClass: 'btn-danger' });
                if (confirmed) {
                    if (musicState.isActive && musicState.activeChatId === chat.id) {
                        await endListenTogetherSession(false);
                    }
                    delete state.chats[chat.id];
                    if (state.activeChatId === chat.id) state.activeChatId = null;
                    await db.chats.delete(chat.id);
                    renderChatList();
                }
            });
            
            return item;
        }

        // Additional required functions for app functionality
        function renderApiSettings() {
            const proxyUrlInput = document.getElementById('proxy-url-input');
            const apiKeyInput = document.getElementById('api-key-input');
            const modelSelect = document.getElementById('model-select');
            
            if (proxyUrlInput) proxyUrlInput.value = state.apiConfig.proxyUrl || '';
            if (apiKeyInput) apiKeyInput.value = state.apiConfig.apiKey || '';
            if (modelSelect) modelSelect.value = state.apiConfig.model || '';
        }

        // Initialize user avatar function
        function initializeUserAvatar() {
            const avatarImg = document.getElementById('user-avatar');
            
            if (avatarImg) {
                if (state.globalSettings.userAvatar) {
                    avatarImg.src = state.globalSettings.userAvatar;
                } else {
                    avatarImg.src = 'https://via.placeholder.com/40x40/007bff/ffffff?text=ME';
                }
                
                avatarImg.addEventListener('click', () => {
                    if (typeof showScreen === 'function') {
                        showScreen('user-menu-screen');
                    }
                });
            }
        }

        // Apply global wallpaper function
        function applyGlobalWallpaper() {
            applyLoadingScreenWallpaper();
        }

        // Apply loading screen wallpaper function
        function applyLoadingScreenWallpaper() {
            const loadingScreen = document.getElementById('loading-screen');
            if (!loadingScreen) return;
            
            const wallpaper = state.globalSettings.wallpaper;
            
            if (wallpaper && wallpaper.startsWith('data:image')) {
                loadingScreen.style.backgroundImage = `url(${wallpaper})`;
                loadingScreen.classList.add('has-wallpaper');
            } else if (wallpaper) {
                loadingScreen.style.backgroundImage = wallpaper;
                loadingScreen.classList.add('has-wallpaper');
            } else {
                loadingScreen.style.backgroundImage = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                loadingScreen.classList.remove('has-wallpaper');
            }
        }

        // Load database data function
        async function loadDatabaseData() {
            try {
                // Initialize default state
                state = {
                    chats: {},
                    activeChatId: null,
                    globalSettings: {
                        enableBackgroundActivity: false,
                        backgroundInterval: 30,
                        blockCooldown: 5
                    },
                    apiConfig: {
                        proxyUrl: '',
                        apiKey: '',
                        model: ''
                    },
                    userStickers: [],
                    worldBooks: [],
                    personaPresets: [],
                    qzoneSettings: {
                        nickname: '我',
                        signature: '这个人很懒，什么都没留下...'
                    },
                    activeAlbumId: null
                };

                // Try to load data from IndexedDB if available
                if (typeof db !== 'undefined' && db) {
                    try {
                        const globalSettings = await db.globalSettings.get('main');
                        const apiConfig = await db.apiConfig.get('main');
                        const qzoneSettings = await db.qzoneSettings.get('main');
                        const chats = await db.chats.toArray();
                        const userStickers = await db.userStickers.toArray();
                        const worldBooks = await db.worldBooks.toArray();

                        if (globalSettings) state.globalSettings = { ...state.globalSettings, ...globalSettings };
                        if (apiConfig) state.apiConfig = { ...state.apiConfig, ...apiConfig };
                        if (qzoneSettings) state.qzoneSettings = { ...state.qzoneSettings, ...qzoneSettings };
                        if (userStickers) state.userStickers = userStickers;
                        if (worldBooks) state.worldBooks = worldBooks;

                        // Convert chats array to object
                        if (chats && chats.length > 0) {
                            state.chats = {};
                            chats.forEach(chat => {
                                state.chats[chat.id] = chat;
                            });
                        }
                    } catch (dbError) {
                        console.warn('数据库加载失败，使用默认设置:', dbError);
                    }
                }

                console.log('数据加载完成:', state);
            } catch (error) {
                console.error('加载数据时出错:', error);
            }
        }

        function initializeFavorites() {
            if (!state.globalSettings.favorites) {
                state.globalSettings.favorites = [];
            }
        }

        function setupGlobalPlaylistSaving() {
            if (typeof window.saveGlobalPlaylist === 'function') {
                console.log('全局播放列表保存功能已设置');
            }
        }

        // Basic screen navigation function
        function showScreen(screenId) {
            try {
                // Hide all screens
                const screens = document.querySelectorAll('.screen');
                screens.forEach(screen => {
                    screen.classList.remove('active');
                });

                // Show target screen
                const targetScreen = document.getElementById(screenId);
                if (targetScreen) {
                    targetScreen.classList.add('active');
                    console.log(`切换到屏幕: ${screenId}`);
                } else {
                    console.warn(`找不到屏幕: ${screenId}`);
                }
            } catch (error) {
                console.error('切换屏幕时出错:', error);
            }
        }

        // Basic alert function fallback
        async function showCustomAlert(title, message) {
            return new Promise((resolve) => {
                alert(`${title}\n\n${message}`);
                resolve();
            });
        }

        // Basic confirm function fallback
        async function showCustomConfirm(title, message, options = {}) {
            return new Promise((resolve) => {
                const result = confirm(`${title}\n\n${message}`);
                resolve(result);
            });
        }

        // Handle user pat function placeholder
        function handleUserPat(chatId, characterName) {
            console.log(`拍了拍 ${characterName}`);
        }

        // Open chat function placeholder
        function openChat(chatId) {
            console.log(`打开聊天: ${chatId}`);
            state.activeChatId = chatId;
        }

        // Add long press listener function placeholder
        function addLongPressListener(element, callback) {
            let pressTimer;
            
            element.addEventListener('mousedown', (e) => {
                pressTimer = setTimeout(() => {
                    callback(e);
                }, 500);
            });
            
            element.addEventListener('mouseup', () => {
                clearTimeout(pressTimer);
            });
            
            element.addEventListener('mouseleave', () => {
                clearTimeout(pressTimer);
            });
        }

        // End listen together session function placeholder
        async function endListenTogetherSession(notify = true) {
            console.log('结束一起听歌会话');
        }

        // Note: Global variables are already defined earlier in the file

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('开始初始化应用...');
                
                // Load database data
                await loadDatabaseData();
                
                // Initialize user avatar
                initializeUserAvatar();
                
                // Apply global wallpaper
                applyGlobalWallpaper();
                
                // Apply custom font if exists
                if (state.globalSettings.customFont && state.globalSettings.customFont.applied) {
                    try {
                        const fontName = state.globalSettings.customFont.name;
                        const fontUrl = state.globalSettings.customFont.url;
                        
                        const fontStyle = document.createElement('style');
                        fontStyle.id = 'custom-font-style';
                        fontStyle.textContent = `
                            @font-face {
                                font-family: '${fontName}';
                                src: url('${fontUrl}');
                                font-display: swap;
                            }
                            
                            .custom-font {
                                font-family: '${fontName}', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
                            }
                        `;
                        
                        document.head.appendChild(fontStyle);
                        document.body.classList.add('custom-font');
                    } catch (error) {
                        console.error('加载自定义字体失败:', error);
                    }
                }
                
                // Render chat list
                renderChatList();
                
                // Render API settings
                renderApiSettings();
                
                // Initialize favorites
                initializeFavorites();
                
                // Setup global playlist saving
                setupGlobalPlaylistSaving();
                
                // Show chat list screen
                showScreen('chat-list-screen');
                
                console.log('应用初始化完成');
                
            } catch (error) {
                console.error('应用初始化失败:', error);
                if (typeof showCustomAlert === 'function') {
                    await showCustomAlert('初始化失败', `应用启动时发生错误: ${error.message}`);
                } else {
                    alert(`应用启动时发生错误: ${error.message}`);
                }
            }
        });

    </script>
</body>
</html>
