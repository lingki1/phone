# 实现计划

- [x] 1. 设置项目结构和核心类型定义


  - 创建 `src/app/components/shopping/` 目录结构
  - 定义购物系统的 TypeScript 接口和类型
  - 创建商品、礼物和交易相关的类型定义文件
  - _需求: 1.1, 8.1_

- [x] 2. 扩展数据库管理器支持购物功能


  - 在 `dataManager.ts` 中添加礼物存储 (GIFT_STORE) 和购物交易存储 (SHOPPING_TRANSACTION_STORE)
  - 实现礼物数据的 CRUD 操作方法
  - 实现购物交易记录的存储和查询方法
  - 编写数据库升级逻辑以支持新的存储结构
  - _需求: 5.1, 5.2, 8.1_

- [x] 3. 实现聊天分析和商品生成服务


  - 创建 `ChatAnalyzer.ts` 服务，分析用户聊天记录提取关键信息
  - 实现 `AIProductService.ts`，调用 API 生成个性化商品建议
  - 创建 `ProductGenerator.ts` 主服务，整合分析和生成逻辑
  - 实现价格生成算法，确保价格在 ¥1-50 范围内合理
  - 添加商品分类逻辑，包括 nsfw 内容识别
  - _需求: 2.1, 2.2, 2.3, 2.4_

- [x] 4. 创建购买管理和余额验证系统


  - 实现 `PurchaseManager.ts` 服务，处理商品购买逻辑
  - 添加余额验证功能，确保用户有足够资金
  - 实现购买流程的原子性操作，防止重复扣费
  - 集成现有的 `dataManager` 余额管理功能
  - 添加购买失败的回滚机制
  - _需求: 3.1, 3.2, 3.3, 3.4_

- [x] 5. 实现礼物记忆管理系统


  - 创建 `GiftMemoryManager.ts` 服务，管理 AI 角色的礼物记忆
  - 实现将购买的礼物添加到 AI 角色记忆的功能
  - 创建系统提示词构建逻辑，将礼物信息注入 AI 对话
  - 实现礼物记忆的查询和展示功能
  - 确保礼物记忆在聊天会话中持久保存
  - _需求: 4.5, 4.6, 4.7, 7.1, 7.2_

- [x] 6. 开发商品展示界面组件


  - 创建 `ProductGrid.tsx` 组件，以网格形式展示商品列表
  - 实现 `ProductCard.tsx` 组件，显示单个商品的信息和图标
  - 添加商品加载状态和错误处理的 UI 反馈
  - 实现商品刷新功能，允许用户重新生成商品列表
  - 添加商品分类过滤和搜索功能
  - _需求: 2.5, 6.1, 6.2_

- [x] 7. 创建商品详情和购买界面




  - 实现 `ProductDetail.tsx` 组件，显示商品的详细信息
  - 创建 `PurchaseModal.tsx` 模态框，处理购买确认流程
  - 添加 AI 角色选择功能，让用户选择为哪个角色购买
  - 实现购买确认和支付流程的 UI
  - 添加购买成功/失败的反馈提示
  - _需求: 3.1, 6.3, 6.4_



- [x] 8. 开发主购物应用组件

  - 创建 `ShoppingApp.tsx` 主组件，整合所有购物功能
  - 实现应用的状态管理和组件间通信
  - 添加导航和返回桌面的功能
  - 集成商品生成、展示和购买的完整流程
  - 实现错误处理和用户友好的提示信息


  - _需求: 1.1, 1.2, 6.1, 8.4_

- [x] 9. 实现礼物指示器组件


  - 创建 `GiftIndicator.tsx` 组件，在聊天界面显示礼物标记
  - 实现礼物数量和最新礼物的显示逻辑
  - 添加点击查看礼物详情的功能


  - 确保指示器样式不会干扰聊天界面
  - 实现礼物指示器的动画效果
  - _需求: 4.1, 4.2, 4.3, 4.4_

- [ ] 10. 集成购物应用到桌面系统
  - 修改 `DesktopPage.tsx`，将购物应用状态从 'coming-soon' 改为 'available'


  - 添加余额检查逻辑，只有余额 > ¥5 时才允许访问购物应用
  - 实现购物应用的启动和导航逻辑
  - 添加购物应用图标的点击处理
  - 确保与现有桌面应用的导航模式一致
  - _需求: 1.1, 1.2, 1.3, 8.4_

- [ ] 11. 集成礼物系统到聊天界面
  - 修改 `ChatInterface.tsx`，添加 `GiftIndicator` 组件的显示
  - 更新消息渲染逻辑，在 AI 消息右上角显示礼物指示器
  - 修改系统提示词构建函数，包含 AI 角色收到的礼物信息
  - 确保礼物记忆在 AI 回复中得到体现
  - 实现礼物指示器的点击交互功能
  - _需求: 4.1, 4.5, 4.6, 4.7, 7.3, 8.5_

- [x] 12. 实现余额同步和交易记录


  - 确保购物交易与现有的红包系统余额管理兼容
  - 实现购物交易记录在 MePage 中的显示
  - 添加购物历史查看功能
  - 确保余额变化在所有相关组件中实时更新
  - 实现交易记录的导出和备份功能
  - _需求: 3.2, 3.3, 5.3, 8.2_


- [x] 13. 添加错误处理和用户体验优化

  - 实现网络错误、API 调用失败的优雅处理
  - 添加加载状态指示器和用户友好的错误提示
  - 实现商品生成失败时的默认商品展示
  - 添加购买流程中的确认和取消机制
  - 优化界面响应速度和用户交互体验
  - _需求: 6.2, 6.4_

- [ ] 14. 实现商品和礼物的样式设计
  - 创建所有购物相关组件的 CSS 样式文件
  - 设计商品卡片、购买模态框的视觉效果
  - 实现礼物指示器的美观设计和动画
  - 确保购物界面与整体应用风格一致
  - 添加响应式设计，支持不同屏幕尺寸
  - _需求: 6.4_

- [x] 15. 编写测试和文档


  - 为核心服务类编写单元测试
  - 测试购买流程的完整性和数据一致性
  - 验证礼物记忆在 AI 对话中的正确集成
  - 测试余额检查和交易记录功能
  - 编写组件使用文档和 API 说明
  - _需求: 所有需求的验证_