# 需求文档

## 介绍

本功能为聊天应用实现虚拟货币和红包系统，允许用户通过AI交互发送和接收虚拟货币，类似微信红包功能。系统包括余额管理、红包发送/接收和数据库持久化。

## 需求

### 需求 1

**用户故事：** 作为用户，我希望拥有跨会话持久化的虚拟货币余额，以便在应用中积累和消费虚拟货币。

#### 验收标准

1. 当应用加载时，系统应从数据库检索用户当前余额
2. 当用户余额发生变化时，系统应立即更新数据库中的余额
3. 当用户查看个人资料页面时，系统应准确显示其当前余额
4. 如果数据库不可用，系统应回退到localStorage进行余额存储
5. 当用户余额更新时，MePage组件应实时反映新余额

### 需求 2

**用户故事：** 作为用户，我希望在聊天对话中向AI角色发送红包，以便在社交场景中模拟给钱。

#### 验收标准

1. 当与AI角色聊天时，用户应能访问红包发送界面
2. 当发送红包时，用户应能指定金额和可选消息
3. 当发送红包时，系统应从用户余额中扣除金额
4. 当红包发送后，系统应在聊天界面显示红包消息
5. 当用户余额不足时，系统应阻止发送并显示错误消息
6. 当红包发送后，AI应能通过聊天确认收到

### 需求 3

**用户故事：** 作为用户，我希望在对话中接收AI角色的红包，以便通过互动赚取虚拟货币。

#### 验收标准

1. 当AI角色发送红包时，系统应在聊天中显示可接收的红包
2. 当用户点击收到的红包时，系统应将金额添加到用户余额
3. 当收到红包时，系统应显示庆祝动画或反馈
4. 当红包被打开时，系统应更新聊天显示已被领取
5. 当发送多个红包时，每个都应可单独领取

### 需求 4

**用户故事：** 作为AI角色，我希望能够通过聊天命令发送和请求红包，以便与用户的虚拟货币系统交互。

#### 验收标准

1. 当AI生成红包命令时，系统应将其处理为可发送的红包
2. 当AI请求红包时，系统应向用户呈现发送界面
3. 当AI发送红包时，系统应创建可领取的红包组件
4. 当处理AI货币命令时，系统应验证金额和用户余额
5. 当AI货币交互发生时，系统应立即更新数据库
6. 当系统提示词更新时，应包含红包功能的使用说明和命令格式
7. 当AI使用红包功能时，应遵循预定义的JSON命令格式

### 需求 7

**用户故事：** 作为系统，我需要为AI提供明确的红包功能指令格式，以便AI能够正确使用红包系统。

#### 验收标准

1. 当构建系统提示词时，应包含红包发送的JSON命令格式说明
2. 当构建系统提示词时，应包含红包请求的JSON命令格式说明
3. 当AI使用红包命令时，系统应能正确解析和执行
4. 当红包命令格式错误时，系统应提供错误提示
5. 当更新系统提示词时，应保持与现有聊天功能的兼容性

### 需求 5

**用户故事：** 作为用户，我希望红包交互具有类似微信的视觉界面，以便体验感觉熟悉且有吸引力。

#### 验收标准

1. 当显示红包时，应具有独特的红包视觉设计
2. 当发送红包时，界面应包括金额输入和消息字段
3. 当接收红包时，界面应显示发送者信息和金额
4. 当红包被打开时，系统应显示打开动画
5. 当红包在聊天中时，应与常规消息明显区分

### 需求 6

**用户故事：** 作为用户，我希望货币系统与现有聊天界面无缝集成，以便货币交互在对话中感觉自然。

#### 验收标准

1. 当在聊天界面中时，红包选项应易于访问
2. 当发送或接收红包时，应作为特殊消息类型出现在聊天历史中
3. 当查看聊天历史时，红包交易应被保留并可显示
4. 当在聊天之间切换时，红包状态应按对话维护
5. 当聊天界面加载时，现有红包应显示其当前已领取/未领取状态