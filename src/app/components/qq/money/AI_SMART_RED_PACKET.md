# AI智能红包接收系统

## 🎯 功能概述

现在AI可以根据上下文和角色性格智能判断是否接收用户发送的红包，而不是自动接收。

## 🤖 AI判断机制

### AI可以选择的行为：

1. **接收红包** - 使用 `accept_red_packet` 命令
2. **拒绝红包** - 使用 `decline_red_packet` 命令

### AI判断因素：
- 红包金额大小
- 祝福语内容
- 当前对话情境
- AI角色性格设定
- 与用户的关系状态

## 📋 AI命令格式

### 群聊格式：

**接收红包：**
```json
{
  "type": "accept_red_packet", 
  "name": "AI角色名", 
  "red_packet_id": "redpacket_1234567890", 
  "message": "谢谢你的红包！"
}
```

**拒绝红包：**
```json
{
  "type": "decline_red_packet", 
  "name": "AI角色名", 
  "red_packet_id": "redpacket_1234567890", 
  "message": "不好意思，我不能收这个红包"
}
```

### 单聊格式：

**接收红包：**
```json
{
  "type": "accept_red_packet", 
  "red_packet_id": "redpacket_1234567890", 
  "message": "谢谢你的红包！"
}
```

**拒绝红包：**
```json
{
  "type": "decline_red_packet", 
  "red_packet_id": "redpacket_1234567890", 
  "message": "不好意思，我不能收这个红包"
}
```

## 🔄 完整流程

1. **用户发送红包**
   - 点击红包按钮，输入金额和祝福语
   - 系统扣除用户余额，创建红包消息
   - 红包显示为"待领取"状态

2. **AI收到红包信息**
   - 系统将红包详情传递给AI
   - 包含红包ID、金额、祝福语等信息
   - AI根据上下文进行判断

3. **AI做出决定**
   - **如果接收**：使用accept_red_packet命令，红包变为已领取，AI表达感谢
   - **如果拒绝**：使用decline_red_packet命令，红包保持待领取状态，AI说明拒绝理由

## 🎭 AI可能的反应示例

### 接收场景：
- "谢谢你的红包！真是太贴心了"
- "哇，收到红包好开心！谢谢～"
- "感谢你的心意，我收下了"
- "红包收到，祝你也发财！"

### 拒绝场景：
- "谢谢你的好意，但我不能收这个红包"
- "不好意思，我觉得还是你自己留着吧"
- "心意我领了，但红包你收回去吧"
- "我们的关系还没到收红包的程度呢"

## 🧪 测试方法

1. **发送不同金额的红包**
   - 小额红包（1-10元）：AI更容易接收
   - 大额红包（100+元）：AI可能会拒绝

2. **使用不同的祝福语**
   - 友好祝福：AI更容易接收
   - 奇怪内容：AI可能会拒绝

3. **在不同情境下测试**
   - 正常聊天：AI通常会接收
   - 刚认识：AI可能会拒绝
   - 争吵后：AI可能会拒绝

## 🔧 技术实现

### 新增函数：
- `handleAiAcceptRedPacket()` - 处理AI接收红包的逻辑
- 扩展了 `createAiMessage()` - 支持新的红包命令

### 系统提示词更新：
- 添加了红包处理规则说明
- 提供了命令格式示例
- 指导AI如何做出判断

### 消息传递优化：
- 更新了 `buildMessagesPayload()` 函数
- 确保红包ID和详细信息正确传递给AI
- 包含红包状态信息

现在你可以测试发送红包给AI，看看AI会如何根据情况做出不同的反应！🎉