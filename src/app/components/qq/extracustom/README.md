# 额外信息功能

## 功能概述

额外信息功能允许AI在回复中包含HTML格式的额外内容，这些内容会直接渲染在聊天界面中，为用户提供丰富的视觉体验。

**重要特性**：
- **线上模式**：HTML内容直接显示在聊天中，不会被气泡包裹
- **剧情模式**：HTML内容嵌入在故事文本中，与文字自然融合

## 主要特性

- **HTML渲染**: AI可以生成HTML代码，直接显示在聊天中
- **自定义描述**: 用户可以描述希望AI生成的额外信息内容和样式
- **安全过滤**: 自动过滤危险的脚本标签，确保安全性
- **响应式设计**: 支持不同屏幕尺寸和主题
- **持久化存储**: 配置信息保存在数据库中

## 使用方法

### 1. 启用功能

1. 在聊天界面中，点击右上角的"⭐"按钮
2. 在弹出的设置窗口中，勾选"启用额外信息功能"
3. 选择使用现有配置或创建新配置：
   - **选择现有配置**：从列表中选择一个已有的配置
   - **创建新配置**：点击"✨ 创建新配置"按钮
4. 在"功能描述"文本框中输入你的需求

**💡 数据存储说明**：
- 配置会自动保存到世界书系统
- 世界书分类为 `extrainfo`
- 世界书名称为 `{角色名字} 的额外信息`
- 可以在世界书管理页面查看和管理
- 支持配置的复用和选择

### 2. 显示模式

**线上模式（普通聊天）**：
- HTML内容会直接显示在聊天中
- 完全不被聊天气泡包裹（与红包消息效果一致）
- 完全按照AI设计的样式显示
- 没有任何背景、边框或气泡装饰

**剧情模式**：
- HTML内容嵌入在故事文本中
- 使用 `{{html: ... }}` 标记
- 与文字自然融合

### 3. 功能描述示例

```
我希望制作一个状态栏，显示当前的心情、位置和穿着信息
```

```
我希望AI在回复中包含一个美观的信息卡片，显示重要数据
```

```
我希望有一个进度条样式的状态显示
```

### 4. AI回复格式

启用后，AI会在回复中包含额外信息，格式如下：

```json
[
  {
    "type": "text",
    "content": "你的正常回复内容"
  },
  {
    "type": "extra_info",
    "htmlContent": "<div style='background: #f0f0f0; padding: 20px; border-radius: 8px;'><h3 style='color: #333;'>标题</h3><p style='color: #666;'>内容描述</p></div>",
    "description": "用户的需求描述"
  }
]
```

## 技术实现

### 组件结构

- `ExtraInfoManager`: 管理额外信息的配置和状态
- `ExtraInfoDisplay`: 渲染AI生成的HTML内容
- `ExtraInfoSettings`: 提供用户设置界面
- `ExtraInfoPrompt`: 生成AI提示词
- `ExtraInfoInjector`: 系统提示词注入器

### 数据存储

- **存储方式**: 使用世界书系统存储，无需扩展IndexedDB
- **世界书分类**: `extrainfo`
- **世界书名称**: `{角色名字} 的额外信息`
- **世界书内容**: 用户的功能描述
- **自动管理**: 启用时自动创建，禁用时自动删除

### 安全措施

- 自动过滤 `<script>` 标签
- 使用 `dangerouslySetInnerHTML` 安全渲染
- 错误处理和回退显示

### 无气泡包裹实现

- 使用CSS `:has()` 选择器检测额外信息内容
- 通过 `!important` 强制移除消息气泡的所有样式
- 与红包消息保持一致的渲染方式
- 确保HTML内容完全按照设计显示，不受气泡样式影响

## 样式特性

### 默认样式

- 渐变背景和圆角边框
- 响应式布局设计
- 支持明暗主题切换
- 移动端优化

### 自定义样式

AI生成的HTML可以使用内联样式或CSS类，支持：

- 颜色和字体
- 布局和间距
- 动画和过渡
- 图标和装饰元素

## 使用场景

### 状态显示
- 角色状态栏
- 进度指示器
- 数据统计卡片

### 信息展示
- 重要信息提醒
- 数据可视化
- 操作指南

### 装饰美化
- 节日主题装饰
- 个性化界面元素
- 视觉增强效果

## 注意事项

1. **HTML安全性**: 确保AI生成的HTML不包含恶意代码
2. **性能考虑**: 复杂的HTML可能影响渲染性能
3. **兼容性**: 某些CSS属性在不同浏览器中可能有差异
4. **响应式**: 建议使用响应式设计，适配不同设备

## 扩展功能

### 未来计划

- 支持更多HTML元素和CSS属性
- 添加动画和交互效果
- 支持模板系统
- 集成第三方UI组件库

### 自定义开发

开发者可以通过以下方式扩展功能：

1. 修改 `ExtraInfoInjector` 添加更多提示词
2. 扩展 `ExtraInfoDisplay` 支持更多渲染方式
3. 添加新的配置选项和设置界面
4. 集成其他渲染引擎（如Markdown、LaTeX等）

## 故障排除

### 常见问题

1. **HTML不显示**: 检查HTML代码是否正确，是否有语法错误
2. **样式异常**: 确认CSS属性兼容性，避免使用实验性属性
3. **性能问题**: 简化HTML结构，减少DOM节点数量
4. **主题适配**: 使用CSS变量确保在不同主题下正常显示

### 调试方法

1. 查看浏览器控制台的错误信息
2. 检查HTML代码的语法正确性
3. 验证CSS样式的兼容性
4. 测试在不同设备和浏览器中的显示效果
