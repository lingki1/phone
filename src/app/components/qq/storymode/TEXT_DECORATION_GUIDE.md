# 剧情模式文本装饰功能指南

## 功能概述

剧情模式现在支持丰富的文本装饰功能，让AI生成的剧情内容更加生动有趣。这些装饰功能只在剧情模式下生效，不会影响普通聊天模式。

## 支持的装饰格式

### 1. 角色对话 - 斜体
- **格式**: `*"对话内容"*`
- **示例**: `*"你好，我是小明"*`
- **效果**: 显示为红色斜体文字

### 2. 重要动作和强调 - 加粗
- **格式**: `**动作描述**`
- **示例**: `**小明猛地站起来**`
- **效果**: 显示为深色加粗文字

### 3. 心理活动 - 括号格式
- **格式**: `(内心想法)`
- **示例**: `(小明心想：我该怎么办？)`
- **效果**: 显示为灰色斜体，带背景色和左边框

### 4. 时间标记 - 方括号
- **格式**: `[时间]`
- **示例**: `[第二天早上]`
- **效果**: 显示为蓝色加粗，带背景色和边框

### 5. 声音效果 - 单星号
- **格式**: `*声音*`
- **示例**: `*叮咚*`
- **效果**: 显示为橙色，带背景色和边框

### 6. 环境描述 - 普通文字
- **格式**: 直接写文字，无需特殊装饰
- **示例**: `房间里弥漫着淡淡的咖啡香`
- **效果**: 显示为普通黑色文字

## 完整示例

```
*"你...你真的愿意听我说吗？"* 小明的声音有些颤抖。

**她深吸一口气，努力让自己冷静下来。**

房间里只有时钟滴答的声音，显得格外安静。

*如果我说出来，你会怎么看我呢？* 她心里忐忑不安。

**终于，她下定决心，抬起头直视着对方。**

*"其实，我一直都很害怕..."* 她的声音越来越小。

**这一刻，所有的伪装都崩塌了。**

(小明：也许这就是我一直在等待的机会)

*叮咚* 门铃突然响起。

[第二天早上] 阳光透过窗帘洒进房间。
```

## 系统提示词注入

系统会自动在剧情模式下注入文本装饰格式要求，确保AI按照正确的格式输出内容。注入内容包括：

1. **装饰格式规则**: 详细的格式说明和示例
2. **装饰使用原则**: 何时使用哪种装饰的指导
3. **示例格式**: 完整的示例展示

## 技术实现

### 1. 系统提示词注入
- 位置: `src/app/components/systemprompt/injectors/StoryModeInjector.ts`
- 功能: 在剧情模式下自动注入文本装饰格式要求

### 2. 文本解析渲染
- 位置: `src/app/components/qq/storymode/StoryModeDisplay.tsx`
- 功能: 解析AI返回的文本，将装饰格式转换为HTML样式

### 3. CSS样式定义
- 位置: `src/app/components/qq/storymode/StoryModeDisplay.css`
- 功能: 定义各种装饰格式的视觉效果

## 安全考虑

1. **XSS防护**: 使用安全的HTML解析，过滤危险标签和属性
2. **格式限制**: 只允许特定的装饰格式，防止恶意代码注入
3. **内容验证**: 对解析后的HTML进行安全检查

## 使用建议

1. **适度使用**: 不要过度使用装饰，保持文本的可读性
2. **层次分明**: 确保不同装饰之间有清晰的层次关系
3. **一致性**: 在整个剧情中保持装饰格式的一致性
4. **重点突出**: 用装饰突出重要的对话、动作和心理活动

## 故障排除

### 装饰不显示
- 检查是否在剧情模式下
- 确认AI返回的文本格式是否正确
- 查看浏览器控制台是否有错误信息

### 样式异常
- 检查CSS文件是否正确加载
- 确认样式类名是否正确
- 验证HTML结构是否完整

### 解析错误
- 检查文本解析逻辑是否正确
- 确认正则表达式是否匹配
- 查看是否有特殊字符干扰

## 更新日志

- **v1.0.0**: 初始版本，支持基础文本装饰功能
- **v1.1.0**: 增加时间标记和声音效果支持
- **v1.2.0**: 优化解析逻辑，提高安全性
