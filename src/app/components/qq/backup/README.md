# 数据备份管理器

## 功能概述

数据备份管理器提供了完整的数据导出、导入和清空功能，支持应用中的所有数据类型，包括新增的送礼记录功能和自动备份功能。

## 支持的数据类型

### 基础数据
- **聊天记录**: 所有私聊和群聊的对话记录
- **角色人设**: AI角色的设定和配置信息
- **API配置**: 代理地址、API密钥和模型选择
- **个人信息**: 用户头像、昵称和个人介绍
- **主题设置**: 当前选择的主题和更新时间
- **余额信息**: 用户当前的虚拟货币余额

### 交易相关
- **交易记录**: 所有转账和红包记录
- **送礼记录**: AI角色之间的礼物赠送记录（新增）
  - 包含礼物详情（商品名称、数量、单价）
  - 配送方式（极速、快速、慢速）
  - 发送方和接收方信息
  - 时间戳和状态

### 功能配置
- **世界书**: 用户创建的所有世界书内容
- **预设配置**: AI模型的参数预设
- **聊天状态**: 角色的在线状态、心情、位置等
- **聊天背景**: 自定义的聊天背景图片

### 动态功能
- **动态内容**: 用户发布的所有动态
- **动态评论**: 动态下的所有评论
- **动态设置**: 动态功能的配置选项
- **动态通知**: 动态相关的通知消息
- **动态草稿**: 未发布的动态草稿

## 版本历史

### v1.8 (当前版本)
- ✅ 新增自动备份功能
  - 支持设置定时自动备份
  - 可选择小时或天为单位
  - 自动提醒用户进行备份
  - 设置持久化保存
- ✅ 改进用户界面
  - 添加自动备份状态显示
  - 优化设置界面布局
  - 响应式设计支持

### v1.7
- ✅ 新增剧情模式消息支持
- ✅ 优化数据收集逻辑
- ✅ 改进错误处理

### v1.6
- ✅ 新增送礼记录支持
- ✅ 优化导入导出进度显示
- ✅ 改进错误处理和用户反馈
- ✅ 添加数据变更事件通知

### v1.5
- ✅ 支持动态功能数据
- ✅ 添加聊天状态和背景
- ✅ 改进数据验证

### v1.4
- ✅ 支持世界书和预设配置
- ✅ 添加主题设置支持

### v1.3
- ✅ 支持交易记录
- ✅ 添加余额信息

### v1.2
- ✅ 支持API配置和个人信息
- ✅ 改进数据格式验证

### v1.1
- ✅ 基础聊天记录支持
- ✅ 简单的导入导出功能

## 使用方法

### 导出数据
1. 点击"导出数据"按钮
2. 系统会自动收集所有数据
3. 下载JSON格式的备份文件
4. 文件命名格式：`chat-app-backup-YYYY-MM-DD.json`

### 自动备份设置
1. 点击"设置自动备份"按钮
2. 勾选"启用自动备份"
3. 设置备份间隔（1-168小时 或 1-365天）
4. 点击"保存设置"
5. 系统会在指定时间自动提醒您进行备份

### 导入数据
1. 点击"选择文件导入"按钮
2. 选择之前导出的备份文件
3. 系统会验证文件格式并导入数据
4. 导入完成后会自动刷新页面状态

### 清空数据
1. 点击"清空所有数据"按钮
2. 确认操作（不可恢复）
3. 系统会删除所有本地数据
4. 页面会重置到初始状态

## 自动备份功能

### 功能特点
- **定时提醒**: 到达设定时间后自动弹出确认对话框
- **灵活设置**: 支持小时和天两种时间单位
- **状态显示**: 实时显示自动备份状态和下次备份时间
- **持久化**: 设置保存在本地，重启应用后仍然有效
- **用户控制**: 用户可以选择是否立即进行备份

### 设置选项
- **启用/禁用**: 可以随时开启或关闭自动备份
- **时间间隔**: 
  - 小时模式：1-168小时（1周）
  - 天模式：1-365天（1年）
- **下次备份时间**: 显示下次自动备份的具体时间

### 工作流程
1. 用户设置自动备份参数
2. 系统保存设置到localStorage
3. 启动定时器，计算下次备份时间
4. 到达指定时间后弹出确认对话框
5. 用户确认后自动执行备份流程
6. 备份完成后重新启动定时器

## 数据格式

### 送礼记录格式
```json
{
  "giftRecords": [
    {
      "id": "unique-id",
      "type": "send|receive",
      "amount": 100.00,
      "chatId": "chat-id",
      "fromUser": "发送方",
      "toUser": "接收方",
      "message": "{\"kind\":\"gift_purchase\",\"items\":[{\"productId\":\"item1\",\"name\":\"礼物名称\",\"quantity\":1,\"unitPrice\":50.00}],\"shippingMethod\":\"instant\"}",
      "timestamp": 1640995200000,
      "status": "completed"
    }
  ]
}
```

### 消息字段说明
- `kind`: 交易类型，送礼记录为 "gift_purchase"
- `items`: 礼物商品列表
  - `productId`: 商品ID
  - `name`: 商品名称
  - `quantity`: 数量
  - `unitPrice`: 单价
- `shippingMethod`: 配送方式
  - `instant`: 极速立刻
  - `fast`: 快速1分钟
  - `slow`: 慢速10分钟

## 安全注意事项

1. **文件安全**: 导出的备份文件包含敏感信息，请妥善保管
2. **导入验证**: 系统会验证文件格式，确保数据完整性
3. **数据覆盖**: 导入操作会覆盖现有数据，请谨慎操作
4. **版本兼容**: 建议使用相同或兼容版本的文件进行导入
5. **自动备份**: 自动备份功能仅在浏览器打开时有效，关闭浏览器后定时器会停止

## 事件通知

系统会在数据变更时触发以下事件：

- `dataImported`: 数据导入完成
- `dataCleared`: 数据清空完成

其他组件可以监听这些事件来更新自己的状态。

## 错误处理

- **文件格式错误**: 显示"无效的备份文件格式"
- **导入失败**: 显示具体的错误信息
- **网络错误**: 自动重试机制
- **数据损坏**: 跳过损坏的数据，继续导入其他数据
- **定时器错误**: 自动备份失败时会重新启动定时器

## 性能优化

- **分批处理**: 大量数据分批导入，避免界面卡顿
- **进度显示**: 实时显示导入导出进度
- **内存管理**: 及时释放不需要的数据
- **错误恢复**: 部分失败时能够继续处理其他数据
- **定时器管理**: 组件卸载时自动清理定时器，避免内存泄漏 