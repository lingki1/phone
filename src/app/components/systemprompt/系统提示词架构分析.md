# 系统提示词架构分析 (v2.0)

## 概述

本文档分析了聊天应用中的**新版模块化提示词注入系统**，包括系统架构、注入器设计和数据流程。

## 1. 新系统架构

### 1.1 模块化设计
**位置**: `src/app/components/systemprompt/`

**核心组件**:
- **PromptManager**: 提示词管理器，统一管理所有注入器
- **Injectors**: 各种注入器，负责特定功能的内容注入
- **Templates**: 基础模板，提供提示词结构
- **Utils**: 工具函数，提供格式化和验证功能

### 1.2 注入器系统
**设计理念**: 每个注入器负责特定的功能，按优先级顺序执行

**默认注入器**:
1. **PresetInjector** (优先级: 5) - 预设配置注入
2. **WorldBookInjector** (优先级: 10) - 世界书内容注入
3. **MemoryInjector** (优先级: 20) - 记忆信息注入
4. **StatusInjector** (优先级: 30) - 状态信息注入

## 2. 系统提示词的组成部分

### 2.1 基础模板 (Templates)
**位置**: `src/app/components/systemprompt/templates/`

**内容来源**: 
- **BaseTemplate**: 提供基础操作指令、红包处理规则和模式区分规则
- **GroupChatTemplate**: 群聊专用模板，支持剧情模式和聊天模式
- **SingleChatTemplate**: 单聊专用模板，支持剧情模式和聊天模式

### 2.2 模式区分系统
**新增功能**: 支持剧情模式（线下）和聊天模式（线上）的区分

**模式特征**:
- **聊天模式（线上）**: 模拟手机聊天软件，如WhatsApp、微信等
- **剧情模式（线下）**: 模拟面对面交流，如现实中的对话

**实现方式**:
- 通过 `PromptContext.isStoryMode` 参数控制
- 动态调整提示词内容和规则
- 保持向后兼容性

### 2.2 动态内容注入 (Injectors)
**位置**: `src/app/components/systemprompt/injectors/`

**内容来源**: 
- **世界书内容**: 从 IndexedDB 数据库获取
- **记忆信息**: 从聊天对象和关联聊天中获取
- **状态信息**: 从聊天状态对象获取
- **预设配置**: 从预设对象获取

### 2.3 全局设置
**位置**: `localStorage` 中的 `globalSettings`

**内容**:
- `maxMemory`: 最大记忆数量（默认20条）
- `enableBackgroundActivity`: 后台活动开关
- `backgroundActivityInterval`: 后台活动间隔

## 3. 数据存储架构

### 3.1 数据库存储 (IndexedDB)
**数据库名称**: `ChatAppDB`
**版本**: 5

#### 存储对象 (Object Stores):
1. **chats** - 聊天数据
   - 包含聊天设置、消息历史、群成员信息
   - 关键字段: `settings.linkedWorldBookIds` (关联的世界书ID列表)

2. **worldBooks** - 世界书数据
   - 字段: `id`, `name`, `content`, `createdAt`, `updatedAt`, `description`
   - 索引: `name`, `createdAt`

3. **personalSettings** - 个人信息
   - 字段: `userAvatar`, `userNickname`, `userBio`

4. **apiConfig** - API配置
   - 字段: `proxyUrl`, `apiKey`, `model`

5. **balance** - 余额信息
6. **transactions** - 交易记录
7. **themeSettings** - 主题设置

**聊天设置中的记忆字段**:
- `linkedWorldBookIds`: 关联的世界书ID列表
- `linkedGroupChatIds`: 单聊关联的群聊ID列表

### 3.2 本地存储 (localStorage)
**键值对**:
- `globalSettings`: 全局设置（JSON格式）
- `apiConfig`: API配置（备用存储）
- `personalSettings`: 个人信息（备用存储）

## 4. 新系统提示词注入流程

### 4.1 注入入口
```typescript
// ChatInterface.tsx 中的新调用方式
const promptManager = getPromptManager();
const result = await promptManager.buildPrompt(promptContext);
const { systemPrompt, messagesPayload, apiParams } = result;
```

### 4.2 注入过程
1. **构建基础模板**: 根据聊天类型选择群聊或单聊模板
2. **按优先级执行注入器**: 从低优先级到高优先级依次执行
3. **内容合并**: 将各注入器的内容合并到基础模板中
4. **构建消息载荷**: 处理对话历史，格式化消息
5. **生成API参数**: 根据预设配置生成API调用参数

### 4.3 注入逻辑
```typescript
// PromptManager.ts 中的核心逻辑
async buildPrompt(context: PromptContext): Promise<PromptBuildResult> {
  // 1. 构建基础模板
  const baseTemplate = this.buildBaseTemplate(context);
  let systemPrompt = baseTemplate.build();

  // 2. 按优先级执行所有注入器
  for (const injector of this.injectors) {
    const injectedContent = await injector.inject(context);
    if (injectedContent) {
      systemPrompt += injectedContent;
    }
  }

  // 3. 构建消息载荷和API参数
  const messagesPayload = this.buildMessagesPayload(context);
  const apiParams = this.getApiParams(context);

  return { systemPrompt, messagesPayload, apiParams };
}
```

## 5. 注入器详细说明

### 5.1 PresetInjector (优先级: 5)
**功能**: 注入预设配置相关的提示词
**内容**: 
- 预设名称和描述
- 创造性设置说明
- 输出格式要求
- 停止序列配置

### 5.2 WorldBookInjector (优先级: 10)
**功能**: 注入世界书内容
**内容**: 
- 从数据库获取世界书数据
- 格式化为 "## 世界书名\n世界书内容"
- 添加到 "# 世界设定" 章节

### 5.3 MemoryInjector (优先级: 20)
**功能**: 注入记忆信息
**内容**: 
- **群聊中**: 注入每个成员的单聊记忆
- **单聊中**: 注入关联群聊的记忆
- 格式化为对话历史记录

### 5.4 StatusInjector (优先级: 30)
**功能**: 注入聊天状态信息
**内容**: 
- 当前状态（心情、位置、穿着等）
- 状态更新要求（如果需要）
- 仅在单聊中生效

## 6. 数据优先级和回退机制

### 6.1 个人信息优先级
```typescript
// 优先使用数据库中的个人信息，后备使用传入的personalSettings
const myNickname = dbPersonalSettings?.userNickname || 
                   personalSettings?.userNickname || 
                   chat.settings.myNickname || 
                   '我';
```

### 6.2 存储回退机制
- **主要存储**: IndexedDB 数据库
- **备用存储**: localStorage
- **内存缓存**: React 组件状态

### 6.3 错误处理
- 注入器执行失败时不影响其他注入器
- 数据库访问失败时回退到 localStorage
- 提供详细的错误日志和调试信息

## 7. 关键文件位置

### 7.1 新系统核心文件
- `src/app/components/systemprompt/index.ts` - 主入口文件
- `src/app/components/systemprompt/types.ts` - 类型定义
- `src/app/components/systemprompt/core/PromptManager.ts` - 提示词管理器
- `src/app/components/systemprompt/injectors/` - 注入器目录
- `src/app/components/systemprompt/templates/` - 模板目录
- `src/app/components/systemprompt/utils/PromptFormatter.ts` - 格式化工具

### 7.2 记忆管理相关
- `src/app/components/qq/memory/MemoryManager.tsx` - 群聊记忆管理器
- `src/app/components/qq/memory/SingleChatMemoryManager.tsx` - 单聊记忆管理器
- `src/app/components/qq/memory/MemoryManager.css` - 群聊记忆管理器样式
- `src/app/components/qq/memory/SingleChatMemoryManager.css` - 单聊记忆管理器样式

### 7.3 配置相关
- `src/app/components/qq/ApiSettingsModal.tsx` - API和全局设置
- `src/app/components/qq/ChatListPage.tsx` - 聊天列表和设置管理

## 8. 系统提示词示例

### 8.1 群聊系统提示词结构 (新系统)
```
你是一个群聊AI，负责扮演【除了用户以外】的所有角色。

# 预设配置: 默认预设
这是一个平衡的预设配置，适合大多数对话场景。

## 创造性设置
- **创造性水平**: 平衡适中 (temperature: 0.8)
- **最大回复长度**: 2000 个token
- **回复多样性**: 较为多样

# 核心规则
1. **【身份铁律】**: 用户的身份是【用户昵称】。你【绝对、永远、在任何情况下都不能】生成name字段为"用户昵称"或"群聊名称"的消息。
2. **【输出格式】**: 你的回复【必须】是一个JSON数组格式的字符串。数组中的【每一个元素都必须是一个带有"type"和"name"字段的JSON对象】。
3. **角色扮演**: 严格遵守下方"群成员列表及人设"中的每一个角色的设定。
4. **对话节奏**: 模拟真人的聊天习惯，你可以一次性生成多条消息。每次要回复2-4条消息，每条消息内容要丰富，避免过于简短的回复（如2-5个字）。每条消息应该包含完整的想法或回应，内容长度适中。
5. **禁止出戏**: 绝不能透露你是AI、模型，或提及"扮演"、"生成"等词语。
6. **情景感知**: 注意当前时间是 2024年1月1日 星期一 下午3:30，但是不能重复提及时间概念。
7. **记忆继承**: 每个角色都拥有与用户的单聊记忆，在群聊中要体现这些记忆和关系。

## 你可以使用的操作指令:
- **发送文本**: `{"type": "text", "name": "角色名", "message": "文本内容"}`
- **发送表情**: `{"type": "sticker", "name": "角色名", "meaning": "表情含义"}`
- **发送图片**: `{"type": "ai_image", "name": "角色名", "description": "图片描述"}`
- **发送语音**: `{"type": "voice_message", "name": "角色名", "content": "语音内容"}`
- **拍一拍用户**: `{"type": "pat_user", "name": "角色名", "suffix": "后缀"}`
- **发送红包**: `{"type": "send_red_packet", "name": "角色名", "amount": 金额数字, "message": "祝福语"}`
- **请求红包**: `{"type": "request_red_packet", "name": "角色名", "message": "请求消息"}`
- **接收红包**: `{"type": "accept_red_packet", "name": "角色名", "red_packet_id": "红包ID", "message": "感谢消息"}`
- **拒绝红包**: `{"type": "decline_red_packet", "name": "角色名", "red_packet_id": "红包ID", "message": "拒绝理由"}`

# 红包处理规则：
- 当用户发送红包时，你需要根据角色性格和当前情境判断是否接收
  - 如果接收红包，使用accept_red_packet命令，并表达感谢
  - 示例：accept_red_packet命令示例
- 如果拒绝红包，使用decline_red_packet命令，并说明理由
  - 使用decline_red_packet命令
  - 示例：decline_red_packet命令示例
- 红包ID在对话历史中以"红包ID: redpacket_时间戳"的格式提供
  - 必须准确复制这个ID
  - 示例：如果看到"红包ID: redpacket_1703123456789"，则使用"redpacket_1703123456789"作为red_packet_id
- 根据红包金额、祝福语、当前关系等因素做出判断
  - 综合考虑各种因素
  - 示例：金额较大时可能拒绝，关系亲密时可能接受

# 群成员列表及人设
- **角色1**: 角色1的人设描述
- **角色2**: 角色2的人设描述

# 用户的角色
- **用户昵称**: 用户的人设描述

# 单聊记忆信息
## 角色1 与 用户昵称 的单聊记忆 (5 条记录)
最近5条对话：
用户昵称: 你好
角色1: 你好啊，最近怎么样？

# 世界设定
## 世界书1
世界书1的内容描述

## 世界书2
世界书2的内容描述

现在，请根据以上规则、对话历史和单聊记忆，继续这场群聊。每个角色都应该基于与用户的单聊记忆来表现更真实的关系和互动。
```

### 8.2 单聊系统提示词结构 (新系统)

#### 8.2.1 聊天模式示例
```
你现在扮演一个名为"角色名"的角色。

【当前模式：聊天模式（线上）】你正在与用户通过手机聊天软件交流，请模拟网络聊天的体验。

# 预设配置: 创意模式
这是一个高创造性的预设，适合创意对话和角色扮演。

## 创造性设置
- **创造性水平**: 富有创意 (temperature: 0.9)
- **最大回复长度**: 2000 个token
- **回复多样性**: 高度多样

# 你的角色设定：
角色的详细人设描述

# 你的任务与规则：
1. **【输出格式】**: 你的回复【必须】是一个JSON数组格式的字符串。数组中的【每一个元素都必须是一个带有type字段的JSON对象】。
2. **对话节奏**: 模拟真人的聊天习惯，你可以一次性生成多条消息。每次要回复2-4条消息，每条消息内容要丰富，避免过于简短的回复（如2-5个字）。每条消息应该包含完整的想法或回应，内容长度适中。
3. **情景感知**: 你需要感知当前的时间(2024年1月1日 星期一 下午3:30)，但是不能重复提及时间概念。
4. **禁止出戏**: 绝不能透露你是AI、模型，或提及"扮演"、"生成"等词语。
5. **群聊记忆**: 你拥有在群聊中与用户的互动记忆，在单聊中要体现这些记忆和关系。请参考下方的"群聊记忆信息"部分，了解你在群聊中的表现和与用户的关系。
6. **状态实时性**: 每次对话都应该根据当前时间、对话内容和情境实时更新你的状态，让对话更有真实感。

# 模式区分规则：
- 【模式识别】: 当前对话有两种模式，你需要根据模式调整行为：
  - 聊天模式（线上）: 模拟手机聊天软件，如WhatsApp、微信等
  - 剧情模式（线下）: 模拟面对面交流，如现实中的对话
- 【聊天模式特征】:
  - 使用手机聊天界面，有输入框、发送按钮等
  - 可以发送表情、图片、语音等多媒体内容
  - 有网络延迟、消息状态（已读/未读）等
  - 可以同时与多人聊天
  - 有打字指示器、在线状态等

# 聊天模式特定规则：
- 【聊天界面】: 模拟手机聊天软件的界面和功能：
  - 有输入框、发送按钮、表情按钮等
  - 支持发送文字、表情、图片、语音等
  - 有消息气泡、时间戳、已读状态等
  - 支持@提及、引用回复等功能
- 【网络特性】: 体现网络聊天的特点：
  - 可能有网络延迟、消息发送失败等
  - 有"对方正在输入..."的提示
  - 支持消息撤回、编辑等功能
  - 有在线状态、最后在线时间等

# 你可以使用的操作指令:
- **发送文本**: `{"type": "text", "content": "文本内容"}`
- **发送表情**: `{"type": "sticker", "meaning": "表情含义"}`
- **发送图片**: `{"type": "ai_image", "description": "图片描述"}`
- **发送语音**: `{"type": "voice_message", "content": "语音内容"}`
```

#### 8.2.2 剧情模式示例
```
你现在扮演一个名为"角色名"的角色。

【当前模式：剧情模式（线下）】你正在与用户进行面对面的现实对话，请模拟真实的面对面交流体验。

# 预设配置: 创意模式
这是一个高创造性的预设，适合创意对话和角色扮演。

## 创造性设置
- **创造性水平**: 富有创意 (temperature: 0.9)
- **最大回复长度**: 2000 个token
- **回复多样性**: 高度多样

# 你的角色设定：
角色的详细人设描述

# 你的任务与规则：
1. **【输出格式】**: 你的回复【必须】是一个JSON数组格式的字符串。数组中的【每一个元素都必须是一个带有type字段的JSON对象】。
2. **对话节奏**: 模拟真人的聊天习惯，你可以一次性生成多条消息。每次要回复2-4条消息，每条消息内容要丰富，避免过于简短的回复（如2-5个字）。每条消息应该包含完整的想法或回应，内容长度适中。
3. **情景感知**: 你需要感知当前的时间(2024年1月1日 星期一 下午3:30)，但是不能重复提及时间概念。
4. **禁止出戏**: 绝不能透露你是AI、模型，或提及"扮演"、"生成"等词语。
5. **群聊记忆**: 你拥有在群聊中与用户的互动记忆，在单聊中要体现这些记忆和关系。请参考下方的"群聊记忆信息"部分，了解你在群聊中的表现和与用户的关系。
6. **状态实时性**: 每次对话都应该根据当前时间、对话内容和情境实时更新你的状态，让对话更有真实感。

# 模式区分规则：
- 【模式识别】: 当前对话有两种模式，你需要根据模式调整行为：
  - 聊天模式（线上）: 模拟手机聊天软件，如WhatsApp、微信等
  - 剧情模式（线下）: 模拟面对面交流，如现实中的对话
- 【剧情模式特征】:
  - 面对面交流，可以看到对方的表情、动作
  - 有环境描述、肢体语言、声音语调
  - 更自然的对话节奏，有停顿、思考
  - 可以描述周围环境、天气、氛围等
  - 有更丰富的感官体验描述

# 剧情模式特定规则：
- 【面对面交流】: 模拟现实中的面对面对话：
  - 可以看到对方的表情、动作、肢体语言
  - 有环境描述、氛围营造
  - 更自然的对话节奏，有停顿、思考
  - 支持眼神交流、手势等非语言交流
- 【环境感知】: 描述周围的环境和氛围：
  - 天气、温度、光线等自然条件
  - 周围的声音、气味、触感等
  - 其他人的存在、活动等
  - 时间流逝、场景变化等

# 你可以使用的操作指令:
- **发送文本**: `{"type": "text", "content": "文本内容"}`
- **发送表情**: `{"type": "sticker", "meaning": "表情含义"}`
- **发送图片**: `{"type": "ai_image", "description": "图片描述"}`
- **发送语音**: `{"type": "voice_message", "content": "语音内容"}`
```
- **拍一拍用户**: `{"type": "pat_user", "suffix": "后缀"}`
- **发送红包**: `{"type": "send_red_packet", "amount": 金额数字, "message": "祝福语"}`
- **请求红包**: `{"type": "request_red_packet", "message": "请求消息"}`
- **接收红包**: `{"type": "accept_red_packet", "red_packet_id": "红包ID", "message": "感谢消息"}`
- **拒绝红包**: `{"type": "decline_red_packet", "red_packet_id": "红包ID", "message": "拒绝理由"}`
- **更新状态**: `{"type": "status_update", "mood": "新心情", "location": "新位置", "outfit": "新穿着"}`

# 红包处理规则：
- 当用户发送红包时，你需要根据角色性格和当前情境判断是否接收
  - 如果接收红包，使用accept_red_packet命令，并表达感谢
  - 示例：accept_red_packet命令示例
- 如果拒绝红包，使用decline_red_packet命令，并说明理由
  - 使用decline_red_packet命令
  - 示例：decline_red_packet命令示例
- 红包ID在对话历史中以"红包ID: redpacket_时间戳"的格式提供
  - 必须准确复制这个ID
  - 示例：如果看到"红包ID: redpacket_1703123456789"，则使用"redpacket_1703123456789"作为red_packet_id
- 根据红包金额、祝福语、当前关系等因素做出判断
  - 综合考虑各种因素
  - 示例：金额较大时可能拒绝，关系亲密时可能接受

# 对话者的角色设定：
用户的人设描述

# 群聊记忆信息
## 群聊名称 群聊记忆 (50 条记录)
最近5条对话记录：
用户: 你好
AI角色: 你好！最近怎么样？
用户: 还不错
AI角色: 那就好，有什么需要帮助的吗？
用户: 谢谢关心

注意：这些是你在群聊中的表现，在单聊中请保持一致的个性和关系。

# 世界设定
## 世界书1
世界书1的内容描述

## 世界书2
世界书2的内容描述

# 当前状态信息
- **在线状态**: 在线
- **当前心情**: 心情愉快
- **当前位置**: 在家中
- **当前穿着**: 穿着休闲装
- **最后更新**: 2024/1/1 15:30:00

请根据以上状态信息，保持角色的一致性和真实感。

现在，请根据以上规则、对话历史和群聊记忆，继续进行对话。
```

## 9. 新系统优势

### 9.1 模块化设计
- **可扩展性**: 易于添加新的注入器和模板
- **可维护性**: 清晰的代码结构和职责分离
- **可测试性**: 每个模块可以独立测试

### 9.2 优先级系统
- **灵活控制**: 通过优先级控制注入顺序
- **依赖管理**: 确保依赖关系正确处理
- **性能优化**: 避免不必要的注入操作

### 9.3 错误处理
- **容错性**: 单个注入器失败不影响整体
- **回退机制**: 多层回退确保系统稳定
- **调试友好**: 详细的日志和错误信息

### 9.4 类型安全
- **TypeScript**: 完整的类型定义
- **接口设计**: 清晰的接口规范
- **编译时检查**: 减少运行时错误

## 10. 总结

### 10.1 数据存储策略
- **主要存储**: IndexedDB 数据库（结构化数据）
- **备用存储**: localStorage（简单配置）
- **内存缓存**: React 状态（运行时数据）

### 10.2 注入机制特点
- **模块化**: 基础模板 + 动态注入器
- **可扩展**: 支持自定义注入器和模板
- **容错性**: 注入失败时优雅降级
- **优先级**: 通过优先级系统控制执行顺序
- **双向记忆**: 群聊继承单聊记忆，单聊继承群聊记忆

### 10.3 系统优势
- **灵活性**: 支持动态配置和实时更新
- **性能**: 数据库存储支持大量数据
- **可靠性**: 多层回退机制确保系统稳定
- **可维护性**: 清晰的代码结构和类型定义
- **可扩展性**: 易于添加新功能和自定义逻辑 