# 世界书注入功能测试指南

## 概述

本文档提供了测试世界书注入功能的详细步骤，确保世界书内容在API调用时正确注入到系统提示词中。

## 测试步骤

### 1. 创建测试世界书

1. 进入世界书管理页面
2. 创建一个新的世界书，包含以下信息：
   - **名称**: 测试世界书
   - **分类**: 测试分类
   - **描述**: 这是一个用于测试的世界书
   - **内容**: 
     ```
     这是一个测试世界设定。在这个世界中：
     - 所有角色都使用中文交流
     - 时间设定为现代
     - 地点设定为虚拟城市
     - 特殊规则：每次回复都要提到"测试世界"
     ```

### 2. 关联世界书到聊天

1. 进入任意聊天（单聊或群聊）
2. 点击聊天设置或相关按钮
3. 找到"关联世界书"选项
4. 选择刚才创建的测试世界书
5. 保存关联设置

### 3. 验证关联状态

1. 检查聊天设置中的 `linkedWorldBookIds` 字段
2. 确认世界书ID已正确保存
3. 在浏览器控制台中查看相关日志

### 4. 测试API调用

1. 在关联了世界书的聊天中发送消息
2. 观察浏览器控制台的日志输出
3. 查找以下关键日志：

#### 4.1 WorldBookInjector 日志
```
WorldBookInjector: 开始注入世界书
{
  chatId: "xxx",
  chatName: "xxx",
  linkedWorldBookIds: ["wb_xxx"],
  linkedCount: 1
}
```

#### 4.2 成功注入日志
```
WorldBookInjector: 成功注入 1 个世界书
{
  worldBooks: [
    {
      id: "wb_xxx",
      name: "测试世界书",
      category: "测试分类"
    }
  ]
}
WorldBookInjector: 注入内容长度: xxx
```

#### 4.3 PromptManager 日志
```
PromptManager: 开始构建提示词
{
  chatId: "xxx",
  isGroup: false,
  hasPreset: false,
  hasWorldBooks: true,
  hasMemory: false
}
PromptManager: WorldBookInjector 注入成功
```

### 5. 验证注入内容

1. 在控制台中查找完整的系统提示词
2. 确认包含以下内容：
   ```
   # 世界设定
   
   ## 测试世界书 (测试分类)
   这是一个测试世界设定。在这个世界中：
   - 所有角色都使用中文交流
   - 时间设定为现代
   - 地点设定为虚拟城市
   - 特殊规则：每次回复都要提到"测试世界"
   ```

### 6. 验证AI回复

1. 发送测试消息："你好"
2. 检查AI回复是否：
   - 提到了"测试世界"
   - 符合世界设定中的规则
   - 使用中文交流

## 调试技巧

### 1. 启用详细日志

在浏览器控制台中，查找以下关键信息：
- `WorldBookInjector` 相关的所有日志
- `PromptManager` 的构建过程日志
- API请求的完整内容

### 2. 检查数据存储

在浏览器开发者工具的 Application 标签页中：
1. 检查 IndexedDB 中的 `worldBooks` 存储
2. 检查 `chats` 存储中的 `linkedWorldBookIds` 字段
3. 确认数据完整性

### 3. 网络请求分析

在 Network 标签页中：
1. 找到 `/v1/chat/completions` 请求
2. 检查请求体中的 `messages` 数组
3. 确认 `system` 角色消息包含世界书内容

## 常见问题排查

### 问题1: 世界书没有注入

**可能原因**:
- 世界书没有正确关联到聊天
- `linkedWorldBookIds` 字段为空
- 世界书数据不存在或损坏

**解决方法**:
1. 检查聊天设置中的关联状态
2. 重新关联世界书
3. 检查世界书数据完整性

### 问题2: 注入内容不完整

**可能原因**:
- 世界书内容过长被截断
- 数据库查询失败
- 注入器执行出错

**解决方法**:
1. 检查控制台错误日志
2. 验证世界书内容长度
3. 检查数据库连接状态

### 问题3: 分类信息缺失

**可能原因**:
- 旧的世界书数据没有分类字段
- 数据迁移未完成

**解决方法**:
1. 重新编辑世界书，添加分类
2. 检查数据迁移逻辑
3. 确认 `WorldBookInfo` 接口包含 `category` 字段

## 测试用例

### 用例1: 基础注入测试
- **目标**: 验证单个世界书正确注入
- **步骤**: 创建简单世界书，关联到聊天，发送消息
- **预期**: AI回复符合世界设定

### 用例2: 多世界书注入测试
- **目标**: 验证多个世界书同时注入
- **步骤**: 创建多个世界书，全部关联到同一聊天
- **预期**: 所有世界书内容都出现在系统提示词中

### 用例3: 分类显示测试
- **目标**: 验证分类信息正确显示
- **步骤**: 创建带分类的世界书，检查关联界面和注入内容
- **预期**: 分类信息在界面和注入内容中正确显示

### 用例4: 错误处理测试
- **目标**: 验证错误情况下的处理
- **步骤**: 删除已关联的世界书，发送消息
- **预期**: 系统优雅处理，不崩溃，记录警告日志

## 性能测试

### 1. 大量世界书测试
- 创建10个以上的世界书
- 全部关联到同一聊天
- 验证注入性能和响应时间

### 2. 长内容测试
- 创建包含大量文本的世界书
- 验证注入内容长度限制
- 检查API请求大小

### 3. 并发测试
- 同时发送多个消息
- 验证注入器的并发处理能力
- 检查是否有竞态条件

## 总结

通过以上测试步骤，可以全面验证世界书注入功能的正确性。重点关注：

1. **数据完整性**: 确保世界书数据正确存储和检索
2. **注入准确性**: 确保内容正确注入到系统提示词
3. **错误处理**: 确保异常情况下的优雅处理
4. **性能表现**: 确保注入过程不影响用户体验

如果所有测试都通过，说明世界书注入功能工作正常。 