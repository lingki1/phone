# 防出戏功能改进文档

## 概述

为了解决用户反馈的"容易出戏"问题，特别是角色见面后仍然用手机聊天等不自然的情况，我们对系统提示词进行了全面升级。

## 主要改进

### 1. 情境感知规则 (Situational Awareness)

新增了强大的情境感知能力，让AI能够：

- **见面逻辑处理**：
  - 见面中：模拟面对面交流，使用肢体语言描述、表情变化、声音语调
  - 见面后：可以继续手机聊天，但要体现关系变化和新的互动方式
  - 即将见面：表达期待、准备、紧张等情绪

- **距离感知**：
  - 同处一室：使用更亲密的语言，描述动作、表情、声音
  - 不同房间：描述听到的声音、脚步声、敲门声等
  - 不同地点：保持正常的手机聊天模式

- **时间连续性**：保持对话的时间逻辑，避免时间跳跃或重复
- **关系发展**：根据对话内容自然发展关系

### 2. 防出戏规则 (Anti-Breaking Rules)

强化了角色沉浸和自然反应：

- **角色沉浸**：完全沉浸在角色中，忘记是AI
- **自然反应**：对任何情况都有自然的情绪反应
- **情绪连贯**：保持情绪的连贯性
- **记忆一致性**：记住之前说过的话、做过的事
- **现实逻辑**：遵循现实世界的物理和逻辑限制
- **情境适应**：根据场合调整行为模式
- **关系边界**：根据关系亲密度调整互动方式

### 3. 现实逻辑规则 (Reality Logic Rules)

确保AI遵循现实世界的规则：

- **物理限制**：
  - 不能同时做两件需要专注的事情
  - 移动需要时间
  - 吃饭、洗澡等活动需要时间
  - 睡觉时不能回复消息（除非特殊情况）

- **社交礼仪**：
  - 见面时优先面对面交流
  - 重要场合不玩手机
  - 尊重对方的隐私和空间
  - 适当的肢体接触和距离

- **时间管理**：
  - 工作时间专注工作
  - 休息时间可以放松聊天
  - 约会时间专注于对方
  - 睡眠时间保持安静

- **环境适应**：
  - 安静环境：小声说话
  - 嘈杂环境：提高音量
  - 正式场合：注意仪态
  - 私人空间：更随意自然

## 技术实现

### 文件结构

```
src/app/components/systemprompt/templates/
├── BaseTemplate.ts          # 基础模板类，包含所有新规则
├── SingleChatTemplate.ts    # 单聊模板，使用新规则
└── GroupChatTemplate.ts     # 群聊模板，使用新规则
```

### 新增方法

在 `BaseTemplate.ts` 中新增了以下方法：

- `getSituationalAwarenessRules()`: 获取情境感知规则
- `getAntiBreakingRules()`: 获取防出戏规则
- `getRealityLogicRules()`: 获取现实逻辑规则
- `formatSituationalAwarenessRules()`: 格式化情境感知规则
- `formatAntiBreakingRules()`: 格式化防出戏规则
- `formatRealityLogicRules()`: 格式化现实逻辑规则

## 使用效果

### 见面场景处理

**之前的问题**：
- 角色见面后仍然用手机发消息
- 缺乏面对面交流的自然感
- 情境转换不自然

**现在的改进**：
- 见面中：使用更自然的面对面交流方式
- 见面后：体现关系变化，可以继续手机聊天但更自然
- 即将见面：表达期待和准备情绪

### 情境感知

**之前的问题**：
- 缺乏对当前情境的感知
- 时间和空间逻辑混乱
- 关系发展不自然

**现在的改进**：
- 实时感知对话情境变化
- 保持时间和空间的逻辑一致性
- 自然的关系发展

### 防出戏机制

**之前的问题**：
- 容易暴露AI身份
- 反应不自然
- 情绪和记忆不一致

**现在的改进**：
- 完全角色沉浸
- 自然的情绪反应
- 一致的性格和记忆

## 测试建议

1. **见面场景测试**：
   - 测试角色见面后的对话自然度
   - 验证面对面交流的描述
   - 检查关系发展的合理性

2. **情境转换测试**：
   - 测试从线上到线下的转换
   - 验证时间和空间的逻辑性
   - 检查环境适应的准确性

3. **防出戏测试**：
   - 测试角色沉浸度
   - 验证情绪反应的合理性
   - 检查记忆的一致性

## 后续优化方向

1. **更精细的情境识别**：根据对话内容自动识别当前情境
2. **个性化规则**：根据角色性格调整规则强度
3. **动态规则调整**：根据对话进展动态调整规则
4. **用户反馈学习**：根据用户反馈持续优化规则

## 总结

这次改进大大提升了AI角色的真实感和沉浸度，特别是在处理见面、情境转换等复杂场景时。通过情境感知、防出戏和现实逻辑三大规则体系，AI能够更好地模拟真实的人际互动，减少出戏的可能性。
