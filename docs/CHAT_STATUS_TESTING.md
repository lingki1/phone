# 聊天状态功能测试指南

## 测试概述

聊天状态功能现在已经支持实时状态更新，让AI角色在对话中能够自然地更新自己的心情、位置和穿着信息，增强聊天的真实感。

## 测试环境准备

### 1. 启动开发服务器
```bash
npm run dev
```

### 2. 确保API配置正确
- 设置代理地址
- 配置API密钥
- 选择模型

## 测试场景

### 场景1：首次对话状态更新
**测试目标**：验证AI在首次对话时会自动更新状态

**测试步骤**：
1. 创建一个新的单聊
2. 发送第一条消息（如："你好"）
3. 观察AI回复和状态更新

**预期结果**：
- AI会发送包含状态更新的回复
- 状态信息会根据当前时间合理设置
- 聊天头部会显示更新后的状态

**示例回复**：
```json
[
  {"type": "status_update", "mood": "精神饱满", "location": "在卧室", "outfit": "穿着睡衣"},
  {"type": "text", "content": "早上好！我刚起床，感觉精神饱满呢～"}
]
```

### 场景2：长时间间隔后的状态更新
**测试目标**：验证AI在长时间间隔后会强制更新状态

**测试步骤**：
1. 进行一段对话
2. 等待30分钟以上（或修改代码中的时间阈值）
3. 继续对话

**预期结果**：
- AI会在回复中包含状态更新
- 状态会根据当前时间调整

### 场景3：自然状态更新
**测试目标**：验证AI在对话中自然地更新状态

**测试步骤**：
1. 询问AI的当前状态："你现在在哪里？"
2. 询问AI的心情："你今天心情怎么样？"
3. 询问AI的穿着："你今天穿什么？"

**预期结果**：
- AI会自然地提及状态变化
- 状态更新会融入对话内容
- 聊天头部状态会实时更新

### 场景4：时间感知状态更新
**测试目标**：验证AI根据时间自动调整状态

**测试步骤**：
1. 在不同时间段进行对话
2. 观察状态建议的变化

**预期结果**：
- 早晨（6-12点）：建议精神饱满、在卧室/厨房、穿睡衣/休闲装
- 下午（12-18点）：建议专注/疲惫、在办公室/咖啡厅、穿正装/休闲装
- 晚上（18-22点）：建议放松/愉快、在家中/餐厅、穿休闲装/家居服
- 深夜（22-6点）：建议平静/困倦、在卧室/客厅、穿睡衣/家居服

### 场景5：活动相关状态更新
**测试目标**：验证AI根据活动更新状态

**测试步骤**：
1. 提及不同活动："我要去上班了"
2. 提及位置变化："我在咖啡厅"
3. 提及情绪变化："我今天很开心"

**预期结果**：
- AI会根据活动更新相应状态
- 状态变化有合理的理由
- 状态信息持久化保存

## 测试用例

### 用例1：早晨对话
**用户输入**：早上好！
**预期AI回复**：
```json
[
  {"type": "status_update", "mood": "精神饱满", "location": "在卧室", "outfit": "穿着睡衣"},
  {"type": "text", "content": "早上好！我刚起床，感觉精神饱满呢～今天天气不错，准备去洗漱了。"}
]
```

### 用例2：工作状态
**用户输入**：你在工作吗？
**预期AI回复**：
```json
[
  {"type": "status_update", "mood": "专注", "location": "在办公室", "outfit": "穿着正装"},
  {"type": "text", "content": "是的，我正在办公室里工作，穿着正装感觉很专业呢～"}
]
```

### 用例3：休息时间
**用户输入**：该休息了
**预期AI回复**：
```json
[
  {"type": "status_update", "mood": "放松", "location": "在家中", "outfit": "穿着休闲装"},
  {"type": "text", "content": "好的，我也该休息了。现在在家里穿着休闲装，感觉很放松～"}
]
```

## 调试技巧

### 1. 查看控制台日志
打开浏览器开发者工具，查看控制台输出：
- 状态更新日志
- API请求日志
- 错误信息

### 2. 检查数据库状态
使用浏览器开发者工具检查IndexedDB：
```javascript
// 在控制台执行
const db = indexedDB.open('ChatAppDB', 7);
db.onsuccess = () => {
  const transaction = db.result.transaction(['chatStatus'], 'readonly');
  const store = transaction.objectStore('chatStatus');
  const request = store.getAll();
  request.onsuccess = () => {
    console.log('聊天状态数据:', request.result);
  };
};
```

### 3. 强制状态更新
修改代码中的时间阈值进行测试：
```typescript
// 将30分钟改为1分钟进行快速测试
return timeDiff > 1 * 60 * 1000 || chat.messages.length <= 1;
```

## 常见问题

### 问题1：状态不更新
**可能原因**：
- API配置错误
- 网络连接问题
- 状态解析失败

**解决方法**：
- 检查API配置
- 查看控制台错误信息
- 验证JSON格式

### 问题2：状态更新过于频繁
**可能原因**：
- 时间阈值设置过小
- 状态更新逻辑有问题

**解决方法**：
- 调整时间阈值
- 检查状态更新条件

### 问题3：状态不合理
**可能原因**：
- 时间感知逻辑错误
- 状态建议不准确

**解决方法**：
- 检查时间计算逻辑
- 调整状态建议规则

## 性能测试

### 1. 状态更新频率
- 正常对话：每30分钟更新一次
- 首次对话：强制更新
- 手动触发：根据用户询问

### 2. 数据库性能
- 状态保存：异步操作，不影响UI
- 状态加载：组件初始化时加载
- 数据大小：每条状态约200字节

### 3. 内存使用
- 状态对象：轻量级，内存占用小
- 组件渲染：响应式更新，性能良好

## 验收标准

### 功能验收
- [ ] 首次对话自动更新状态
- [ ] 长时间间隔后强制更新状态
- [ ] 对话中自然更新状态
- [ ] 状态信息持久化保存
- [ ] 状态显示正确

### 性能验收
- [ ] 状态更新不影响对话流畅性
- [ ] 数据库操作不阻塞UI
- [ ] 内存使用合理

### 用户体验验收
- [ ] 状态更新自然真实
- [ ] 状态信息符合时间逻辑
- [ ] 界面显示清晰美观
- [ ] 响应式设计正常

## 测试报告模板

```
测试日期：____年__月__日
测试人员：________
测试环境：________

测试结果：
□ 通过
□ 部分通过
□ 失败

问题记录：
1. ________
2. ________

改进建议：
1. ________
2. ________
``` 