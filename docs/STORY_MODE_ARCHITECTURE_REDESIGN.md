# 剧情模式架构重新设计

## 概述

本次更新完全重新设计了剧情模式的架构，使其专注于剧情推展，采用小说风格的叙述方式，并支持多种显示模式。

## 核心改变

### 1. **新增专用模板**
- ✅ **StoryModeTemplate** - 剧情模式专用模板
- ✅ 完全不同于聊天模式的任务和规则
- ✅ 专注于故事发展和剧情推展

### 2. **新增专用注入器**
- ✅ **StoryModeInjector** (优先级: 5) - 剧情模式专用注入器
- ✅ **NarrativeStyleInjector** (优先级: 15) - 叙述风格注入器
- ✅ **CharacterStateInjector** (优先级: 25) - 角色状态注入器

### 3. **保留并优化的注入器**
- ✅ **StatusInjector** - 保留，支持剧情模式的状态查看
- ✅ **WorldBookInjector** - 优化，支持剧情模式的世界观设定
- ✅ **MemoryInjector** - 优化，支持剧情模式的故事背景记忆
- ✅ **PresetInjector** - 优化，支持剧情模式的故事创作设置

## 新增文件结构

```
src/app/components/systemprompt/
├── templates/
│   └── StoryModeTemplate.ts (新增) - 剧情模式专用模板
├── injectors/
│   ├── StoryModeInjector.ts (新增) - 剧情模式专用注入器
│   ├── NarrativeStyleInjector.ts (新增) - 叙述风格注入器
│   └── CharacterStateInjector.ts (新增) - 角色状态注入器
└── types.ts (扩展) - 添加 isStoryMode 标识
```

## 剧情模式核心特点

### 1. **任务和规则重新设计**
```typescript
// 剧情模式专用任务
- 剧情推展: 专注于推进故事情节，让故事不断发展
- 角色发展: 深化角色性格，展现角色成长和变化
- 叙述风格: 采用小说风格的叙述方式，注重描写和细节
- 沉浸体验: 创造引人入胜的阅读体验
- 状态描写: 自然地融入角色状态变化，让故事更真实
```

### 2. **叙述风格指导**
```typescript
// 支持多种叙述模式
1. 对话模式 - 使用引号标记对话，展现角色性格和关系
2. 叙述模式 - 第三人称叙述，推进情节，描述环境
3. 状态模式 - 深入角色内心，心理描写
4. 动作模式 - 生动描述角色动作，增强画面感
```

### 3. **显示模式设计**
```typescript
// 支持多种显示模式
- 对话模式：气泡样式，显示角色名
- 叙述模式：段落样式，背景色区分
- 状态模式：斜体样式，心理描写
- 动作模式：粗体样式，动作描述
```

## 注入器详细说明

### StoryModeInjector (优先级: 5)
**功能**: 注入剧情模式专用内容
**内容**:
- 故事发展目标
- 角色关系网络
- 情节推进要求
- 叙述技巧指导

### NarrativeStyleInjector (优先级: 15)
**功能**: 注入叙述风格指导
**内容**:
- 语言风格要求
- 叙述模式说明
- 描写技巧指导
- 叙述视角控制
- 情感表达技巧

### CharacterStateInjector (优先级: 25)
**功能**: 注入角色状态描写指导
**内容**:
- 基础状态信息
- 心理状态描写指导
- 情感变化描写指导
- 状态更新要求

## 优化的现有注入器

### StatusInjector
- ✅ 保留，支持剧情模式的状态查看
- ✅ 优化状态更新要求，适应剧情模式
- ✅ 状态更新融入故事叙述，不突兀

### WorldBookInjector
- ✅ 优化标题，剧情模式显示"故事世界观设定"
- ✅ 保持世界书内容的注入功能

### MemoryInjector
- ✅ 优化标题，剧情模式显示"故事背景记忆"和"角色关系记忆"
- ✅ 保持记忆信息的注入功能

### PresetInjector
- ✅ 优化设置标题，剧情模式显示"故事创作设置"
- ✅ 优化参数标签，适应剧情模式需求

## 技术实现

### 1. **类型扩展**
```typescript
export interface PromptContext {
  // ... 现有字段
  isStoryMode?: boolean; // 新增：标识是否是剧情模式
}
```

### 2. **模板选择逻辑**
```typescript
private buildBaseTemplate(context: PromptContext) {
  // 检查是否是剧情模式
  if (context.isStoryMode) {
    return new StoryModeTemplate(context);
  } else if (context.chat.isGroup) {
    return new GroupChatTemplate(context);
  } else {
    return new SingleChatTemplate(context);
  }
}
```

### 3. **注入器注册**
```typescript
// 注册剧情模式专用注入器
this.injectors = [
  // ... 现有注入器
  new StoryModeInjector(),
  new NarrativeStyleInjector(),
  new CharacterStateInjector()
];
```

## 用户体验改进

### 1. **专注剧情推展**
- 每次回复都推进故事情节
- 避免日常聊天的重复性
- 创造引人入胜的故事体验

### 2. **小说风格叙述**
- 采用文学性的表达方式
- 注重细节描写和氛围营造
- 支持多种叙述模式

### 3. **状态查看保留**
- 用户仍可查看角色状态
- 状态更新融入故事叙述
- 保持状态的真实性和连贯性

### 4. **灵活显示模式**
- 支持对话、叙述、状态、动作等模式
- 根据情节需要选择合适的显示方式
- 提供丰富的阅读体验

## 优势分析

### 1. **架构优势**
- ✅ **完全分离**: 剧情模式与聊天模式完全独立
- ✅ **专注剧情**: 专门针对故事发展和剧情推展
- ✅ **灵活显示**: 支持多种叙述和显示模式
- ✅ **可扩展性**: 易于添加新的叙述风格和显示模式

### 2. **用户体验**
- 🎭 **沉浸式体验**: 小说风格的叙述方式
- 📖 **多样化显示**: 不同模式提供丰富的阅读体验
- 🔄 **连贯性**: 保持故事发展的逻辑性和连贯性
- 🎨 **个性化**: 支持不同的叙述风格和显示效果

## 总结

这次重新设计成功创建了完全独立的剧情模式架构，专注于故事发展和剧情推展，采用小说风格的叙述方式，并支持多种显示模式。用户现在可以享受沉浸式的故事体验，同时保持状态查看等原有功能。
